{
	"info": {
		"_postman_id": "15381251-1e1fe5c4-857a-45c4-a9d9-d5648356faef",
		"name": "Regression Testing",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Preperson / Merge",
			"item": [
				{
					"name": "Create PrePerson request",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"id": "84aa0754-242c-4c94-affc-b7d1fd136119",
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						},
						{
							"listen": "test",
							"script": {
								"id": "7a2bc01b-57d6-4af3-a361-737f6aff304a",
								"exec": [
									"pm.test(\"Preperson create successful\", function () {\r",
									"    pm.response.to.have.status(201);\r",
									"\r",
									"    const jsonData = pm.response.json();\r",
									"\r",
									"    pm.globals.set('preperson_id', jsonData.data.id)\r",
									"});\r",
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"id": "15381251-2417a51a-c3d6-43a7-b955-f4584c753039",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "api-key",
								"value": "{{mis_client_secret}}"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}"
							},
							{
								"key": "x-custom-psk",
								"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"external_id\": \"3999869394.2799207815.1\",\n  \"first_name\": \"Преперсона\",\n  \"last_name\": \"Регрес\",\n  \"gender\": \"FEMALE\",\n  \"birth_date\": \"2024-11-20\",\n  \"emergency_contact\": {\n    \"first_name\": \"Ольга\",\n    \"last_name\": \"Комо\",\n    \"second_name\": \"Іванівнович\",\n    \"phones\": [\n      {\n        \"type\": \"MOBILE\",\n        \"number\": \"+380951364443\"\n      }\n    ]\n  },\n  \"note\": \"Зареєстрований у тестових цілях\"\n}"
						},
						"url": {
							"raw": "{{host}}/api/prepersons",
							"host": [
								"{{host}}"
							],
							"path": [
								"api",
								"prepersons"
							]
						}
					},
					"response": []
				},
				{
					"name": "Get preperson by ID",
					"event": [
						{
							"listen": "test",
							"script": {
								"id": "2e8f6668-e983-4b2d-937b-d8a5f31bc349",
								"exec": [
									"pm.test(\"Status code is 200\", function () {\r",
									"    pm.response.to.have.status(200);\r",
									"});\r",
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"id": "b29343e4-b50a-4b9c-a025-b3704911fe67",
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"id": "15381251-4d3c3e54-24b1-4420-a4a7-311b741d52a5",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							},
							{
								"key": "api-key",
								"value": "{{mis_client_secret}}",
								"type": "text"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text"
							},
							{
								"key": "x-custom-psk",
								"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{host}}/api/prepersons/{{preperson_id}}",
							"host": [
								"{{host}}"
							],
							"path": [
								"api",
								"prepersons",
								"{{preperson_id}}"
							]
						}
					},
					"response": []
				},
				{
					"name": "Create Episode for merge",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"id": "ad600e94-c4db-4dfb-90b0-237c156f9d88",
								"exec": [
									"const uuid = require('uuid');",
									"const id = uuid.v4();",
									"pm.environment.set(\"episode_id\", id);",
									"",
									"const now = new Date();",
									"",
									"// Зменшити дату на 2 дні",
									"const twoDaysAgo = new Date();",
									"twoDaysAgo.setDate(now.getDate() - 2);",
									"",
									"// Форматувати дату у форматі ISO 8601",
									"const formattedDate = twoDaysAgo.toISOString();",
									"console.log(formattedDate)",
									"// Зберегти дату в змінній середовища",
									"pm.globals.set('episode_start_date', formattedDate);",
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						},
						{
							"listen": "test",
							"script": {
								"id": "e6c3f1ee-7922-457c-b761-3f4735e98381",
								"exec": [
									"function displayResponse(title, data) {",
									"    console.log(title, data)",
									"    const html = `",
									"        <h1>${title}</h1>",
									"        <pre>${JSON.stringify(data, null, 2)}</pre>`;",
									"    pm.visualizer.set(html);",
									"}",
									"",
									"// Initialize variables to track the number of tests",
									"let allTestsPassed = false;",
									"let passedTestsCount = 0;",
									"let totalTestsCount = 3; // Adjust based on the total number of tests",
									"",
									"// Run your tests",
									"pm.test(\"Check token is not expired\", function () {",
									"    const result = pm.response.code !== 401;",
									"    pm.expect(result).to.be.true;",
									"    if (result) {",
									"        passedTestsCount++;",
									"        allTestsPassed = true;",
									"    }",
									"});",
									"",
									"pm.test(\"Check user has the required scope\", function () {",
									"    const result = pm.response.code !== 403;",
									"    pm.expect(result).to.be.true;",
									"    if (result) {",
									"        passedTestsCount++;",
									"        allTestsPassed = true;",
									"    }",
									"});",
									"",
									"pm.test(\"Check for valid access token\", function () {",
									"    const result = pm.response.code !== 401;",
									"    pm.expect(result).to.be.true;",
									"    if (result) {",
									"        passedTestsCount++;",
									"        allTestsPassed = true;",
									"    }",
									"});",
									"",
									"console.log(`Passed ${passedTestsCount} out of ${totalTestsCount} tests ${passedTestsCount < totalTestsCount}`);",
									"if (passedTestsCount === totalTestsCount) {",
									"    const jsonData = pm.response.json();",
									"    console.log('response in episode', jsonData);",
									"",
									"    pm.test(\"Episode done. Response status is 202\", function () {",
									"        pm.expect(pm.response.code).to.eql(202);",
									"    });",
									"",
									"",
									"",
									"    if (jsonData && jsonData.error) {",
									"        displayResponse('Episode Response Error Details', jsonData.error);",
									"    }",
									"",
									"",
									"    const job_id = jsonData.data.links[0].href.substring(6) || '';",
									"    pm.globals.set(\"job_id\", job_id);",
									"",
									"    pm.environment.set('retryCount', 0);",
									"",
									"    // Function to check job status",
									"    function checkJobStatus(jobId) {",
									"",
									"        const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;",
									"        const maxRetries = 3; // Set the maximum number of retries",
									"",
									"        pm.sendRequest({",
									"            method: 'GET',",
									"            url: url,",
									"            header: {",
									"                'Content-Type': 'application/json',",
									"                'Authorization': `Bearer ${pm.environment.get('access_token')}`,",
									"                'api-key': `${pm.environment.get('mis_client_secret')}`,",
									"                'X-Custom-PSK': '0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b'",
									"            }",
									"        }, function (err, res) {",
									"",
									"            const responseBody = res.json();",
									"",
									"            pm.test(\"Check if patient is not active\", function () {",
									"                if (responseBody.data.status_code === 409) {",
									"                    pm.expect(responseBody.error.message).to.equal(\"Person is not active\");",
									"                    pm.expect(responseBody.error.type).to.equal(\"request_conflict\");",
									"                }",
									"            });",
									"",
									"            // Валідація ID епізоду",
									"            pm.test(\"Check episode id is unique\", function () {",
									"                // Перевірка, чи статус відповіді є 422",
									"                pm.response.to.not.have.status(422);",
									"",
									"                // Отримання масиву помилок",
									"                const errors = responseBody.data?.error?.invalid || [];",
									"",
									"                // Перевірка на наявність помилки \"Episode with such id already exists\"",
									"                const isIdDuplicate = errors.some(error =>",
									"                    error.entry === \"$.id\" &&",
									"                    Array.isArray(error.rules) &&",
									"                    error.rules.some(rule => rule.description === \"Episode with such id already exists\")",
									"                );",
									"                // Якщо знайдена помилка, тест не пройде",
									"                pm.expect(isIdDuplicate).to.be.false;",
									"            });",
									"",
									"            pm.test(\"Check if episode period start date is valid\", function () {",
									"                const errors = responseBody.data.error?.invalid || [];",
									"                const isPeriodStartError = errors.some(error =>",
									"                    error.entry === \"$.period.start\" &&",
									"                    error.rules.some(rule => rule.description === \"Start date must be in past\")",
									"                );",
									"                pm.expect(isPeriodStartError).to.be.false;",
									"            });",
									"",
									"            if (err) {",
									"                displayResponse('Request Error', { error: err.message });",
									"                console.error('Error checking job status:', err);",
									"            } else {",
									"",
									"                // const responseBody = res.json();",
									"                console.log('Job Status:', responseBody.data.status);",
									"",
									"                if (responseBody.data.status === 'processed') {",
									"",
									"                    pm.test(`Episode Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {",
									"                        // Перевіряємо, чи код відповіді є або 303",
									"                        pm.expect(res.code).to.eql(303);",
									"                    });",
									"",
									"                    // Extract patientID and jobEpisodeID from responseBody",
									"                    const links = responseBody.data.links.reduce((acc, link) => {",
									"                        const href = link.href.replace('/api/', '');",
									"",
									"                        if (href.includes('patients/')) {",
									"                            // Extract patient ID",
									"                            const parts = href.split('/');",
									"                            const patientIDIndex = parts.indexOf('patients') + 1;",
									"                            if (patientIDIndex > 0 && patientIDIndex < parts.length) {",
									"                                acc.patientID = parts[patientIDIndex];",
									"                            }",
									"                        }",
									"",
									"                        if (href.includes('episodes/')) {",
									"                            // Extract episode ID",
									"                            acc.jobEpisodeID = href.split('episodes/')[1];",
									"                        }",
									"",
									"                        return acc;",
									"                    }, {});",
									"",
									"                    // Set globals",
									"                    if (links.patientID) {",
									"                        pm.globals.set('patient_id_from_episode', links.patientID);",
									"                    }",
									"",
									"                    if (links.jobEpisodeID) {",
									"                        pm.globals.set('jobEpisodeID', links.jobEpisodeID);",
									"                    }",
									"",
									"                    // Display response details in visualizer",
									"                    displayResponse('Episode Job Response Details', responseBody.data);",
									"",
									"",
									"                } else {",
									"",
									"                    // Retrieve the current retry count",
									"                    let retryCount = parseInt(pm.environment.get('retryCount')) || 0;",
									"",
									"                    if (retryCount < maxRetries) {",
									"                        // Increment the retry count and set it back to the environment",
									"                        retryCount++;",
									"                        pm.environment.set('retryCount', retryCount);",
									"",
									"                        console.log(`Retrying... Attempt ${retryCount}`);",
									"",
									"                        setTimeout(() => {",
									"                            checkJobStatus(jobId);",
									"                        }, 1000);",
									"",
									"                    } else {",
									"                        console.log('Maximum retry limit reached.');",
									"                        // Display final response details in visualizer",
									"                        displayResponse('Final Job Status Check', responseBody.data);",
									"                    }",
									"                }",
									"            }",
									"        });",
									"    }",
									"",
									"    // Call the function with the job ID",
									"    checkJobStatus(job_id);",
									"",
									"} else {",
									"    console.log('One or more tests failed, skipping job status check.');",
									"}",
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"id": "15381251-9c2488a9-0a19-4a12-a4ae-9a3f6b0daf2f",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}"
							},
							{
								"key": "api-key",
								"value": "{{mis_client_secret}}"
							},
							{
								"key": "x-custom-psk",
								"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"id\": \"{{episode_id}}\",\n    \"name\": \"Епізод QA_30\",\n    \"status\": \"active\",\n    \"type\": {\n        \"system\": \"eHealth/episode_types\",\n        \"code\": \"TREATMENT\"\n    },\n    \"period\": {\n        \"start\": \"{{episode_start_date}}\"\n    },\n    \"managing_organization\": {\n        \"identifier\": {\n            \"type\": {\n                \"coding\": [\n                    {\n                        \"system\": \"eHealth/resources\",\n                        \"code\": \"legal_entity\"\n                    }\n                ]\n            },\n            \"value\": \"{{user_legal_entity}}\"\n        }\n    },\n    \"care_manager\": {\n        \"identifier\": {\n            \"type\": {\n                \"coding\": [\n                    {\n                        \"system\": \"eHealth/resources\",\n                        \"code\": \"employee\"\n                    }\n                ]\n            },\n            \"value\": \"{{user_id}}\"\n        }\n    }\n}"
						},
						"url": {
							"raw": "{{host}}/api/patients/{{preperson_id}}/episodes",
							"host": [
								"{{host}}"
							],
							"path": [
								"api",
								"patients",
								"{{preperson_id}}",
								"episodes"
							]
						}
					},
					"response": []
				},
				{
					"name": "Create merge request",
					"event": [
						{
							"listen": "test",
							"script": {
								"id": "7907f9f9-f3df-4bbb-ab95-c9845a6e4954",
								"exec": [
									" const jsonData = pm.response.json();\r",
									"\r",
									"function displayResponse(title, data) {\r",
									"    const html = `\r",
									"        <h1>${title}</h1>\r",
									"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
									"    pm.visualizer.set(html);\r",
									"}\r",
									"\r",
									"if (jsonData.data.id) {\r",
									"    const personReqId = jsonData.data.id\r",
									"    console.log(personReqId)\r",
									"    pm.globals.set(\"merge_req_id\", personReqId);\r",
									"}\r",
									"\r",
									"\r",
									"\r",
									"\r",
									"// Function to handle each URL request\r",
									"function processUrl(url, additionalData) {\r",
									"    console.log(url, 'urls loop');\r",
									"   \r",
									"    pm.sendRequest({\r",
									"        url: url,\r",
									"        method: 'PUT',\r",
									"        header: {\r",
									"            'Content-Type': 'image/jpeg'\r",
									"        },\r",
									"        body: {\r",
									"            mode: 'raw',\r",
									"            raw: JSON.stringify(additionalData) // Include additional data in the body\r",
									"        }\r",
									"    }, function (err, res) {\r",
									"        if (err) {\r",
									"            console.error('Request failed:', err);\r",
									"            displayResponse('Request Error', { error: err.message });\r",
									"        } else {\r",
									"            let responseData;\r",
									"\r",
									"            // Check content type to determine how to parse the response\r",
									"            const contentType = res.headers.get('Content-Type');\r",
									"            console.log(contentType)\r",
									"            if (contentType && contentType.includes('text/plain')) {\r",
									"                try {\r",
									"                     // Handle TEXT response if needed\r",
									"                responseData = res.text(); // Get response as text\r",
									"                displayResponse('Document sign successful', { response: responseData });\r",
									"                } catch (e) {\r",
									"                    console.error('JSON parsing error:', e);\r",
									"                    displayResponse('Parsing Error', { error: 'Failed to parse JSON' });\r",
									"                    return;\r",
									"                }\r",
									"                // displayResponse('Document sign successful', responseData);\r",
									"            } else {\r",
									"                // Handle other response types if needed\r",
									"                responseData = res.text(); // Default to text for unknown formats\r",
									"                displayResponse('Unknown Response Format', { response: responseData });\r",
									"            }\r",
									"        }\r",
									"    });\r",
									"}\r",
									"\r",
									"const resData = pm.response.json();\r",
									"\r",
									"// Extract URLs from the documents array in the response\r",
									"const documents = resData.urgent.documents;\r",
									"const urls = documents.map(doc => doc.url);\r",
									"\r",
									"const additionalData = {\r",
									"    row: '0JTQvtC60YPQvNC10L3Rgg=='\r",
									"};\r",
									"\r",
									"// Process each URL from the documents array\r",
									"urls.forEach(url => {\r",
									"    processUrl(url, additionalData);\r",
									"});\r",
									"\r",
									"tests[\"Status code is 201\"] = responseCode.code === 201;\r",
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"id": "9a1506b1-e96e-4022-a9ec-c3b810c98308",
								"exec": [
									"const uuid = require('uuid');\r",
									"const id = uuid.v4();\r",
									"\r",
									"setTimeout(() => {\r",
									"    pm.sendRequest({\r",
									"\r",
									"        url: `${pm.globals.get('host')}/api/patients/${pm.globals.get('preperson_id')}/episodes`,\r",
									"        method: \"POST\",\r",
									"        header: {\r",
									"            'Content-Type': 'application/json',\r",
									"            'Authorization': `Bearer ${accessToken}`,\r",
									"            'api-key': `${pm.environment.get(\"mis_client_secret\")}`,\r",
									"            'X-Custom-PSK': `${pm.globals.get(\"x-custom-psk\")}`\r",
									"        },\r",
									"        body: {\r",
									"            mode: \"raw\",\r",
									"            raw: JSON.stringify({\r",
									"                \"id\": id,\r",
									"                \"name\": \"Епізод QA_30\",\r",
									"                \"status\": \"active\",\r",
									"                \"type\": {\r",
									"                    \"system\": \"eHealth/episode_types\",\r",
									"                    \"code\": \"TREATMENT\"\r",
									"                },\r",
									"                \"period\": {\r",
									"                    \"start\": \"2025-02-05T09:32:02.308Z\"\r",
									"                },\r",
									"                \"managing_organization\": {\r",
									"                    \"identifier\": {\r",
									"                        \"type\": {\r",
									"                            \"coding\": [\r",
									"                                {\r",
									"                                    \"system\": \"eHealth/resources\",\r",
									"                                    \"code\": \"legal_entity\"\r",
									"                                }\r",
									"                            ]\r",
									"                        },\r",
									"                        \"value\": `${pm.environment.get('user_legal_entity')}`\r",
									"                    }\r",
									"                },\r",
									"                \"care_manager\": {\r",
									"                    \"identifier\": {\r",
									"                        \"type\": {\r",
									"                            \"coding\": [\r",
									"                                {\r",
									"                                    \"system\": \"eHealth/resources\",\r",
									"                                    \"code\": \"employee\"\r",
									"                                }\r",
									"                            ]\r",
									"                        },\r",
									"                        \"value\": `${pm.environment.get('user_id')}`\r",
									"                    }\r",
									"                }\r",
									"            })\r",
									"        }\r",
									"    }, function (err, res) {\r",
									"        console.error(err);\r",
									"        console.log(res.json());\r",
									"    });\r",
									"\r",
									"}, 30000); // Затримка 30 секунд\r",
									"\r",
									"\r",
									"\r",
									"const patientId = pm.globals.get(\"patient_for_regress\");\r",
									"const url = `${pm.globals.get(\"host\")}/api/persons/${patientId}/authentication_methods`;\r",
									"const accessToken = pm.environment.get('access_token');\r",
									"\r",
									"function displayResponse(title, data) {\r",
									"    console.log(title, data)\r",
									"    const html = `\r",
									"        <h1>${title}</h1>\r",
									"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
									"    pm.visualizer.set(html);\r",
									"}\r",
									"\r",
									"pm.sendRequest({\r",
									"    url: url,\r",
									"    method: 'GET',\r",
									"    header: {\r",
									"        'Content-Type': 'application/json',\r",
									"        'Authorization': `Bearer ${accessToken}`,\r",
									"        'api-key': `${pm.environment.get(\"mis_client_secret\")}`,\r",
									"        'X-Custom-PSK': `${pm.globals.get(\"x-custom-psk\")}`\r",
									"    }\r",
									"}, function (err, res) {\r",
									"    if (err) {\r",
									"        console.error('Error in request:', err);\r",
									"    } else {\r",
									"        console.log('Response Status:', res.status);\r",
									"        console.log('Response Body:', res.text());\r",
									"\r",
									"        // Optional: Process the response data if needed\r",
									"        try {\r",
									"            const responseData = res.json();\r",
									"\r",
									"            // Extract the ID from the response data\r",
									"            if (responseData.data && responseData.data.length > 0) {\r",
									"                const id = responseData.data[0].id;\r",
									"\r",
									"                // Set the extracted ID in the Postman globals\r",
									"                pm.globals.set('patient_authentication_methods_in_approval', id);\r",
									"\r",
									"                displayResponse('Patient authentication methods in approval details', responseData)\r",
									"                console.log('Global Variable \"authenticationMethodID\" set to:', id);\r",
									"            } else {\r",
									"                console.log('No data found in response.');\r",
									"            }\r",
									"\r",
									"            console.log('Parsed Response Data:', responseData.data);\r",
									"        } catch (parseError) {\r",
									"            console.error('Error parsing response JSON:', parseError);\r",
									"        }\r",
									"    }\r",
									"});"
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"id": "15381251-087fc593-9c0c-40c2-9dbf-3f682da0c80d",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "POST",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							},
							{
								"key": "api-key",
								"value": "{{mis_client_secret}}",
								"type": "text"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text"
							},
							{
								"key": "x-custom-psk",
								"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\r\n  \"master_person_id\": \"{{patient_for_regress}}\",\r\n  \"merge_person_id\": \"{{preperson_id}}\",\r\n  \"authorize_with\": \"{{patient_authentication_methods_in_approval}}\"\r\n}"
						},
						"url": {
							"raw": "{{host}}/api/merge_requests",
							"host": [
								"{{host}}"
							],
							"path": [
								"api",
								"merge_requests"
							]
						}
					},
					"response": []
				},
				{
					"name": "Approve merge request",
					"event": [
						{
							"listen": "test",
							"script": {
								"id": "e8379d35-8d50-4ae5-98f3-40f93347477f",
								"exec": [
									"pm.test(\"Merge request approved successful\", function () {\r",
									"    pm.response.to.have.status(200);\r",
									"});\r",
									"\r",
									"if (pm.response.code === 200) {\r",
									"\r",
									"    function displayResponse(title, data) {\r",
									"        const html = `\r",
									"        <h1>${title}</h1>\r",
									"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
									"        pm.visualizer.set(html);\r",
									"    }\r",
									"\r",
									"    // Extract data from the response\r",
									"    const responseJson = pm.response.json();\r",
									"    let dataToSign = responseJson.data[\"data_to_be_signed\"];\r",
									"    console.log(dataToSign)\r",
									"\r",
									"\r",
									"    dataToSign.patient_signed = true;\r",
									"\r",
									"    // Define the URL and the request details for the local server\r",
									"    const localServerUrl = 'http://localhost:3000/receive-data'; // Replace with your local server endpoint\r",
									"    const requestData = {\r",
									"        method: 'POST',\r",
									"        url: localServerUrl,\r",
									"        header: {\r",
									"            'Content-Type': 'application/json'\r",
									"        },\r",
									"        body: {\r",
									"            mode: 'raw',\r",
									"            raw: JSON.stringify(dataToSign) // Send the entire response or specific fields\r",
									"        }\r",
									"    };\r",
									"\r",
									"    // Send the request to the local server\r",
									"    pm.sendRequest(requestData, function (err, res) {\r",
									"        if (err) {\r",
									"            console.error('Error sending request to local server:', err);\r",
									"        } else {\r",
									"            console.log('Response from local server:', res.json());\r",
									"            const responseBody = res.json();\r",
									"\r",
									"            // Set global variable in Postman\r",
									"            pm.globals.set('merge_req_signed_content', responseBody.signed_content);\r",
									"\r",
									"            displayResponse('Signed merge data', responseBody);\r",
									"        }\r",
									"    });\r",
									"\r",
									"} else {\r",
									"    console.log('Initial request failed');\r",
									"}\r",
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"id": "ba76941a-bf4c-498c-805a-8d6a3afdbdd9",
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"id": "15381251-4727296d-8fbe-4ca6-bb76-dd20aecdf119",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "PATCH",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							},
							{
								"key": "api-key",
								"value": "{{mis_client_secret}}",
								"type": "text"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text"
							},
							{
								"key": "x-custom-psk",
								"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\r\n  \"verification_code\": 7913\r\n}"
						},
						"url": {
							"raw": "{{host}}/api/merge_requests/{{merge_req_id}}/actions/approve",
							"host": [
								"{{host}}"
							],
							"path": [
								"api",
								"merge_requests",
								"{{merge_req_id}}",
								"actions",
								"approve"
							]
						}
					},
					"response": []
				},
				{
					"name": "Sign merge request",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"pm.test(\"Merge request sign successful\", function () {\r",
									"    pm.response.to.have.status(200);\r",
									"\r",
									"    const resData = pm.response.json();\r",
									"\r",
									"    pm.globals.set('merge_id', resData.data?.id)\r",
									"});"
								],
								"type": "text/javascript",
								"packages": {},
								"id": "9df22ec8-98c7-4b9a-b247-71ba6513aa7e"
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {},
								"id": "be2e8d9d-574a-4a79-8bc2-eea5d719ca48"
							}
						}
					],
					"id": "15381251-d6d5bcde-4990-4774-be93-9d82803a615f",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "PATCH",
						"header": [
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							},
							{
								"key": "api-key",
								"value": "{{mis_client_secret}}",
								"type": "text"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text"
							},
							{
								"key": "x-custom-psk",
								"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
								"type": "text"
							}
						],
						"body": {
							"mode": "raw",
							"raw": "{\r\n  \"signed_content\": \"{{merge_req_signed_content}}\",\r\n  \"signed_content_encoding\": \"base64\"\r\n}"
						},
						"url": {
							"raw": "{{host}}/api/merge_requests/{{merge_req_id}}/actions/sign",
							"host": [
								"{{host}}"
							],
							"path": [
								"api",
								"merge_requests",
								"{{merge_req_id}}",
								"actions",
								"sign"
							]
						}
					},
					"response": []
				},
				{
					"name": "Get merge request by ID",
					"event": [
						{
							"listen": "test",
							"script": {
								"id": "df14a82e-b953-4156-bbc2-762ab01141f0",
								"exec": [
									"pm.test(\"Get merge request by ID successful\", function () {\r",
									"    pm.response.to.have.status(200);\r",
									"});"
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						},
						{
							"listen": "prerequest",
							"script": {
								"id": "b2366e19-0e96-442f-a244-edd627d0b76a",
								"exec": [
									""
								],
								"type": "text/javascript",
								"packages": {},
								"requests": {}
							}
						}
					],
					"id": "15381251-3dcac57a-a7b2-4896-988a-79df62384ca5",
					"protocolProfileBehavior": {
						"disableBodyPruning": true
					},
					"request": {
						"method": "GET",
						"header": [
							{
								"key": "api-key",
								"value": "{{mis_client_secret}}",
								"type": "text"
							},
							{
								"key": "Content-Type",
								"value": "application/json",
								"type": "text"
							},
							{
								"key": "Authorization",
								"value": "Bearer {{access_token}}",
								"type": "text"
							},
							{
								"key": "x-custom-psk",
								"value": "{{x-custom-psk}}",
								"type": "text"
							}
						],
						"url": {
							"raw": "{{host}}/api/merge_requests/{{merge_id}}",
							"host": [
								"{{host}}"
							],
							"path": [
								"api",
								"merge_requests",
								"{{merge_id}}"
							]
						}
					},
					"response": []
				}
			],
			"id": "15381251-952d7626-ad38-4a1d-af2d-fd6565884c8b"
		},
		{
			"name": "Login",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "d846d6ca-c634-4b61-bdb6-ffb6cd1c256d",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "93cbb9e8-4fa8-4e08-90c4-104cfc55fbf8",
						"exec": [
							"const jsonData = pm.response.json();\r",
							"\r",
							"pm.test(\"Login - PASS. Status code is 201\", function () {\r",
							"    pm.response.to.have.status(201);\r",
							"\r",
							"    if (jsonData.data && jsonData.data.value) {\r",
							"        const access_token = jsonData.data.value;\r",
							"        const refresh_token = jsonData.data.details.refresh_token;\r",
							"        console.log('access_token', access_token);\r",
							"        console.log('refresh_token', refresh_token);\r",
							"        pm.environment.set(\"access_token\", access_token);\r",
							"    }\r",
							"\r",
							"});\r",
							"\r",
							"\r",
							"\r",
							"\r",
							"\r",
							"\r",
							"\r",
							"// tests[\"Status code is 201\"] = responseCode.code === 201;\r",
							"\r",
							"// function displayResponse(title, description, data) {\r",
							"//     console.log(title, data)\r",
							"//     const html = `\r",
							"//         <h1>${title}</h1>\r",
							"//         <h3>${description}</h3>\r",
							"//         <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"//     pm.visualizer.set(html);\r",
							"// }\r",
							"\r",
							"// const jsonData = pm.response.json();\r",
							"// if (jsonData.error) {\r",
							"//     displayResponse('Error on step LOGIN', jsonData.error.message, jsonData.error);\r",
							"// } else {\r",
							"//     if (jsonData.data && jsonData.data.value) {\r",
							"//         const access_token = jsonData.data.value;\r",
							"//         const refresh_token = jsonData.data.details.refresh_token;\r",
							"//         console.log('access_token', access_token);\r",
							"//         console.log('refresh_token', refresh_token);\r",
							"//         pm.environment.set(\"access_token\", access_token);\r",
							"//     }\r",
							"\r",
							"\r",
							"//     // -----------------------  Authorize  ---------------------------\r",
							"\r",
							"\r",
							"\r",
							"//     const le = pm.environment.get('user_legal_entity');\r",
							"//     const redirect = pm.environment.get('user_redirect_uri');\r",
							"//     const scopes = pm.environment.get('user_scopes');\r",
							"//     const apiKey = pm.environment.get('mis_client_secret');\r",
							"//     const XCustomPSK = '0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b';\r",
							"\r",
							"\r",
							"//     pm.sendRequest({\r",
							"//         url: 'https://auth-preprod.ehealth.gov.ua/oauth/apps/authorize', // Replace with your actual URL\r",
							"//         method: 'POST',\r",
							"//         header: {\r",
							"//             'Content-Type': 'application/json',\r",
							"//             'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"//             'X-Custom-PSK': `${XCustomPSK}`\r",
							"//         },\r",
							"//         body: {\r",
							"//             mode: 'raw',\r",
							"//             raw: JSON.stringify({\r",
							"//                 \"app\": {\r",
							"//                     \"client_id\": `${le}`,\r",
							"//                     \"redirect_uri\": `${redirect}`,\r",
							"//                     \"scope\": `${scopes}`\r",
							"//                 }\r",
							"//             })\r",
							"//         }\r",
							"//     }, function (err, res) {\r",
							"//         if (err) {\r",
							"//             console.error('Error in parent request:', err);\r",
							"//         } else {\r",
							"//             console.log(res, 'Authorize response log')\r",
							"//             const locationHeader = res.headers.get('Location');\r",
							"//             console.log(\"Response Headers:\", locationHeader);\r",
							"//             if (locationHeader) {\r",
							"//                 const locationUrl = locationHeader.toString();\r",
							"//                 console.log(\"Location URL:\", locationUrl);\r",
							"\r",
							"//                 const match = locationUrl.match(/[?&]code=([^&]+)/);\r",
							"\r",
							"//                 if (match) {\r",
							"//                     const code = match[1];\r",
							"//                     console.log(\"Extracted Code:\", code);\r",
							"\r",
							"//                     pm.environment.set(\"user_code\", code);\r",
							"\r",
							"//                     console.log(\"Environment Variable 'user_code':\", pm.environment.get(\"user_code\"));\r",
							"//                 } else {\r",
							"//                     console.log(\"The location URL does not contain a 'code' parameter.\");\r",
							"//                 }\r",
							"//                 tests[\"Status code is 201\"] = responseCode.code === 201;\r",
							"//             } else {\r",
							"//                 console.log(\"Location URL is undefined. Check the response headers.\");\r",
							"//             }\r",
							"\r",
							"\r",
							"\r",
							"\r",
							"//             // postman.setEnvironmentVariable(\"user_code\", responseHeaders.Location.split('=')[1]);\r",
							"//             // console.log(responseHeaders)\r",
							"\r",
							"//             // Make sure the subrequest runs after setting the variable\r",
							"//             executeSubrequest();\r",
							"//         }\r",
							"//     });\r",
							"\r",
							"\r",
							"\r",
							"//     // -----------------------Exchange grant token---------------------------\r",
							"\r",
							"\r",
							"//     const userCode = pm.environment.get('user_code');\r",
							"//     console.log('userCode', userCode)\r",
							"//     const clientSecret = pm.environment.get('client_secret');\r",
							"\r",
							"\r",
							"//     function executeSubrequest() {\r",
							"//         pm.sendRequest({\r",
							"//             url: 'https://api-preprod.ehealth.gov.ua/oauth/tokens/',\r",
							"//             method: 'POST',\r",
							"//             header: {\r",
							"//                 'Content-Type': 'application/json',\r",
							"//                 'api-key': `${apiKey}`,\r",
							"//                 'X-Custom-PSK': `${XCustomPSK}`\r",
							"//             },\r",
							"//             body: {\r",
							"//                 mode: 'raw',\r",
							"//                 raw: JSON.stringify({\r",
							"//                     \"token\": {\r",
							"//                         \"grant_type\": \"authorization_code\",\r",
							"//                         \"code\": `${userCode}`,\r",
							"//                         \"client_id\": `${le}`,\r",
							"//                         \"client_secret\": `${clientSecret}`,\r",
							"//                         \"redirect_uri\": `${redirect}`\r",
							"\r",
							"//                     }\r",
							"//                 })\r",
							"//             }\r",
							"//         }, function (err, res) {\r",
							"//             if (err) {\r",
							"//                 console.error('Error in subrequest:', err);\r",
							"//             } else {\r",
							"//                 console.log('Subrequest Status Code:', res.status);\r",
							"//                 console.log('Raw Subrequest Response:', res.text());\r",
							"//                 try {\r",
							"//                     const subrequestData = res.json();\r",
							"//                     console.log('Parsed Subrequest Response:', subrequestData.data.value);\r",
							"\r",
							"//                     if (subrequestData.data && subrequestData.data.value) {\r",
							"//                         const access_token = subrequestData.data.value;\r",
							"//                         const refresh_token = subrequestData.data.details.refresh_token;\r",
							"//                         pm.environment.set(\"access_token\", access_token);\r",
							"//                         pm.environment.set(\"refresh_token\", refresh_token);\r",
							"//                     } else {\r",
							"//                         pm.environment.set(\"access_token\", \"<<undefined>>\");\r",
							"//                         pm.environment.set(\"refresh_token\", \"<<undefined>>\");\r",
							"//                     }\r",
							"//                     const employeeSpeciality = pm.environment.get('employee_specialty');\r",
							"//                     displayResponse('Authorization Successful', `You authorized as a ${employeeSpeciality}`, subrequestData.data);\r",
							"//                 } catch (parseError) {\r",
							"//                     console.error('Error parsing subrequest JSON:', parseError);\r",
							"//                     displayResponse('TRY SEND REQUEST AGAIN PLEASE', 'This is required so that the value of the environment is updated', parseError)\r",
							"\r",
							"//                 }\r",
							"//             }\r",
							"//         });\r",
							"//     }\r",
							"// }"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-ca3caa9a-74fc-49a7-ac3d-1b4b3842ee4e",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"token\": {\r\n        \"grant_type\": \"password\",\r\n        \"email\": \"{{user_email}}\",\r\n        \"password\": \"{{user_password}}\",\r\n        \"client_id\": \"{{client_id_preprod_demo}}\",\r\n        \"scope\": \"app:authorize\"\r\n    }\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{auth_host}}/auth/login",
					"host": [
						"{{auth_host}}"
					],
					"path": [
						"auth",
						"login"
					]
				}
			},
			"response": []
		},
		{
			"name": "Authorize",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "1b571b65-2aec-4d49-836a-c75607eaf406",
						"exec": [
							"pm.test(\"Authorize - PASS. Status code is 201\", () => {\r",
							"    pm.response.to.have.status(201);\r",
							"});\r",
							"\r",
							"const locationHeader = pm.response.headers.get(\"Location\");\r",
							"\r",
							"if (locationHeader) {\r",
							"    const userCode = locationHeader.split('=')[1];\r",
							"    pm.environment.set(\"user_code\", userCode);\r",
							"    console.log(\"User Code:\", userCode);\r",
							"} else {\r",
							"    console.warn(\"Location header not found in response.\");\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "5c0f65fc-bfa4-415e-b740-1147a2587e65",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-3a59cb71-1748-49ac-926e-7ae8ad09a7fb",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"app\": {\r\n        \"client_id\": \"{{user_legal_entity}}\",\r\n        \"redirect_uri\": \"{{user_redirect_uri}}\",\r\n        \"scope\": \"{{user_scopes}}\"\r\n    }\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{auth_host}}/oauth/apps/authorize",
					"host": [
						"{{auth_host}}"
					],
					"path": [
						"oauth",
						"apps",
						"authorize"
					]
				}
			},
			"response": []
		},
		{
			"name": "Exchange grant token",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "0c4e06ff-0d3c-41e7-b506-9c5236058ecd",
						"exec": [
							"pm.test(\"Exchange grant token - PASS. Status code is 201\", () => {",
							"    pm.response.to.have.status(201);",
							"});",
							"",
							"const jsonData = pm.response.json();",
							"",
							"if (jsonData?.data?.value) {",
							"    pm.environment.set(\"access_token\", jsonData.data.value);",
							"    pm.environment.set(\"refresh_token\", jsonData.data.details?.refresh_token || \"<<undefined>>\");",
							"} else {",
							"    pm.environment.set(\"access_token\", \"<<undefined>>\");",
							"    pm.environment.set(\"refresh_token\", \"<<undefined>>\");",
							"}",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "0997667a-e9c6-411f-b988-e242fe48175a",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-4294f4ff-cb2f-44b0-bbcb-2095af8de3e1",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "\n{\n   \"token\":{\n      \"grant_type\":\"authorization_code\",\n      \"code\": \"{{user_code}}\",\n      \"client_id\":\"{{user_legal_entity}}\",\n      \"client_secret\": \"{{client_secret}}\",\n      \"redirect_uri\": \"{{user_redirect_uri}}\"\n\n   }\n}"
				},
				"url": {
					"raw": "{{host}}/oauth/tokens",
					"host": [
						"{{host}}"
					],
					"path": [
						"oauth",
						"tokens"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Person Request",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "fcf93292-ee12-4e12-84eb-f7df52d5a874",
						"exec": [
							"// Списки з 30 імен, прізвищ та по батькові (чоловічі)\r",
							"const firstNames = [\r",
							"    \"Олександр\", \"Андрій\", \"Іван\", \"Сергій\", \"Володимир\", \"Дмитро\", \"Артем\", \"Роман\", \"Максим\", \"Євген\",\r",
							"    \"Павло\", \"Михайло\", \"Юрій\", \"Олег\", \"Тарас\", \"Ігор\", \"Віталій\", \"Богдан\", \"Василь\", \"Григорій\",\r",
							"    \"Ярослав\", \"Антон\", \"Леонід\", \"Степан\", \"Арсен\", \"Ілля\", \"Костянтин\", \"Любомир\", \"Ростислав\", \"Олексій\"\r",
							"];\r",
							"\r",
							"const lastNames = [\r",
							"    \"Шевченко\", \"Ковальчук\", \"Бондаренко\", \"Ткаченко\", \"Кравченко\", \"Олійник\", \"Поліщук\", \"Мельник\", \"Сидоренко\", \"Петренко\",\r",
							"    \"Захарчук\", \"Козак\", \"Семенюк\", \"Гаврилюк\", \"Кравчук\", \"Дяченко\", \"Романюк\", \"Коваль\", \"Іванов\", \"Гончаренко\",\r",
							"    \"Савчук\", \"Литвин\", \"Мороз\", \"Бойко\", \"Зінченко\", \"Цимбалюк\", \"Клименко\", \"Білоус\", \"Марчук\", \"Никитюк\"\r",
							"];\r",
							"\r",
							"const patronymics = [\r",
							"    \"Олександрович\", \"Іванович\", \"Сергійович\", \"Володимирович\", \"Андрійович\", \"Дмитрович\", \"Петрович\", \"Миколайович\", \"Юрійович\", \"Павлович\",\r",
							"    \"Максимович\", \"Артемович\", \"Михайлович\", \"Олегович\", \"Тарасович\", \"Ігорович\", \"Віталійович\", \"Богданович\", \"Васильович\", \"Григорійович\",\r",
							"    \"Ярославович\", \"Антонович\", \"Леонідович\", \"Степанович\", \"Арсенович\", \"Ілліч\", \"Костянтинович\", \"Любомирович\", \"Ростиславович\", \"Олексійович\"\r",
							"];\r",
							"\r",
							"// Функція для вибору випадкового елементу з масиву\r",
							"function getRandomElement(arr) {\r",
							"    return arr[Math.floor(Math.random() * arr.length)];\r",
							"}\r",
							"\r",
							"// Випадкове ПІБ\r",
							"const firstName = getRandomElement(firstNames);\r",
							"const lastName = getRandomElement(lastNames);\r",
							"const secondName = getRandomElement(patronymics);\r",
							"\r",
							"// Встановлення значень у глобальні змінні Postman\r",
							"pm.globals.set(\"first_name\", firstName);\r",
							"pm.globals.set(\"last_name\", lastName);\r",
							"pm.globals.set(\"second_name\", secondName);\r",
							"\r",
							"\r",
							"\r",
							"// Лог для відлагодження\r",
							"console.log(`Generated: ${lastName} ${firstName} ${secondName}`);\r",
							"\r",
							"\r",
							"\r",
							"function generateRandomTaxId() {\r",
							"    let taxId = '';\r",
							"    for (let i = 0; i < 10; i++) {\r",
							"        taxId += Math.floor(Math.random() * 10); // Generate a random digit\r",
							"    }\r",
							"    return taxId;\r",
							"}\r",
							"\r",
							"// Generate a random tax ID\r",
							"const randomTaxId = generateRandomTaxId();\r",
							"\r",
							"// Set the random tax ID in an environment variable\r",
							"pm.globals.set('person_tax_id', randomTaxId);\r",
							"\r",
							"// Optional: Log the generated tax ID for debugging\r",
							"console.log('Generated tax ID:', randomTaxId);\r",
							"\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "039cf868-24b0-488e-ac23-daa49a26b114",
						"exec": [
							"const resBody = JSON.parse(responseBody);\r",
							"\r",
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"if (resBody.data.id) {\r",
							"    const personReqId = resBody.data.id\r",
							"    console.log(personReqId)\r",
							"    pm.globals.set(\"Person_req_id\", personReqId);\r",
							"}\r",
							"\r",
							"\r",
							"\r",
							"\r",
							"// Function to handle each URL request\r",
							"function processUrl(url, additionalData) {\r",
							"    console.log(url, 'urls loop');\r",
							"   \r",
							"    pm.sendRequest({\r",
							"        url: url,\r",
							"        method: 'PUT',\r",
							"        header: {\r",
							"            'Content-Type': 'image/jpeg'\r",
							"        },\r",
							"        body: {\r",
							"            mode: 'raw',\r",
							"            raw: JSON.stringify(additionalData) // Include additional data in the body\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"        if (err) {\r",
							"            console.error('Request failed:', err);\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"        } else {\r",
							"            let responseData;\r",
							"\r",
							"            // Check content type to determine how to parse the response\r",
							"            const contentType = res.headers.get('Content-Type');\r",
							"            console.log(contentType)\r",
							"            if (contentType && contentType.includes('text/plain')) {\r",
							"                try {\r",
							"                     // Handle TEXT response if needed\r",
							"                responseData = res.text(); // Get response as text\r",
							"                displayResponse('Document sign successful', { response: responseData });\r",
							"                } catch (e) {\r",
							"                    console.error('JSON parsing error:', e);\r",
							"                    displayResponse('Parsing Error', { error: 'Failed to parse JSON' });\r",
							"                    return;\r",
							"                }\r",
							"                // displayResponse('Document sign successful', responseData);\r",
							"            } else {\r",
							"                // Handle other response types if needed\r",
							"                responseData = res.text(); // Default to text for unknown formats\r",
							"                displayResponse('Unknown Response Format', { response: responseData });\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"const resData = pm.response.json();\r",
							"\r",
							"// Extract URLs from the documents array in the response\r",
							"const documents = resData.urgent.documents;\r",
							"const urls = documents.map(doc => doc.url);\r",
							"\r",
							"const additionalData = {\r",
							"    row: '0JTQvtC60YPQvNC10L3Rgg=='\r",
							"};\r",
							"\r",
							"// Process each URL from the documents array\r",
							"urls.forEach(url => {\r",
							"    processUrl(url, additionalData);\r",
							"});\r",
							"\r",
							"tests[\"Status code is 201\"] = responseCode.code === 201;"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-01808532-391e-4199-a231-71bbe2948542",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"person\": {\n        \"first_name\": \"{{first_name}}\",\n        \"last_name\": \"{{last_name}}\",\n        \"second_name\": \"{{second_name}}\",\n        \"birth_date\": \"2000-12-13\",\n        \"birth_country\": \"Україна\",\n        \"birth_settlement\": \"Київ\",\n        \"gender\": \"MALE\",\n        \"email\": \"example@example.com\",\n        \"no_tax_id\": false,\n        \"tax_id\": \"{{person_tax_id}}\",\n        \"secret\": \"secret\",\n        \"documents\": [\n            {\n                \"type\": \"PASSPORT\",\n                \"number\": \"АГ768421\",\n                \"issued_by\": \"Рокитнянським РВ ГУ МВС Київської області\",\n                \"issued_at\": \"2015-02-28\"\n            }\n        ],\n        \"addresses\": [\n            {\n                \"area\": \"ХАРКІВСЬКА\",\n                \"building\": \"15\",\n                \"country\": \"UA\",\n                \"region\": \"ЧУГУЇВСЬКИЙ\",\n                \"settlement\": \"ВЕЛИКА БАБКА\",\n                \"settlement_id\": \"7a438190-5b6f-4341-b25d-0b19f46c320f\",\n                \"settlement_type\": \"VILLAGE\",\n                \"street\": \"Ніжинська\",\n                \"street_type\": \"STREET\",\n                \"type\": \"RESIDENCE\",\n                \"zip\": \"12345\"\n            }\n        ],\n        \"phones\": [\n            {\n                \"type\": \"MOBILE\",\n                \"number\": \"+380503476416\"\n            }\n        ],\n        \"authentication_methods\": [\n            {\n                \"type\": \"OFFLINE\"\n            }\n        ],\n        \"unzr\": \"19881125-54021\",\n        \"emergency_contact\": {\n            \"first_name\": \"Ганна\",\n            \"last_name\": \"Сіра\",\n            \"second_name\": \"Іванівна\",\n            \"phones\": [\n                {\n                    \"type\": \"MOBILE\",\n                    \"number\": \"+380954445566\"\n                }\n            ]\n        },\n        \"preferred_way_communication\": \"email\"\n    },\n    \"patient_signed\": false,\n    \"process_disclosure_data_consent\": true\n}"
				},
				"url": {
					"raw": "{{host}}/api/v2/person_requests",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"v2",
						"person_requests"
					],
					"query": [
						{
							"key": "Content-Type",
							"value": "application/json",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Approve Person Request",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "3b88a033-2561-4b91-90df-67ac27a52377",
						"exec": [
							"if (pm.response.code === 200) {\r",
							"\r",
							"    function displayResponse(title, data) {\r",
							"        const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"        pm.visualizer.set(html);\r",
							"    }\r",
							"\r",
							"    // Extract data from the response\r",
							"    const responseJson = pm.response.json();\r",
							"    let dataToSign = responseJson.data;\r",
							"\r",
							"    console.log(dataToSign)\r",
							"\r",
							"    dataToSign.patient_signed = true;\r",
							"\r",
							"    // Define the URL and the request details for the local server\r",
							"    const localServerUrl = 'http://localhost:3000/receive-data'; // Replace with your local server endpoint\r",
							"    const requestData = {\r",
							"        method: 'POST',\r",
							"        url: localServerUrl,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json'\r",
							"        },\r",
							"        body: {\r",
							"            mode: 'raw',\r",
							"            raw: JSON.stringify(dataToSign) // Send the entire response or specific fields\r",
							"        }\r",
							"    };\r",
							"\r",
							"    // Send the request to the local server\r",
							"    pm.sendRequest(requestData, function (err, res) {\r",
							"        if (err) {\r",
							"            console.error('Error sending request to local server:', err);\r",
							"        } else {\r",
							"            console.log('Response from local server:', res.json());\r",
							"            const responseBody = res.json();\r",
							"\r",
							"            pm.globals.set('person_req_signed_content', responseBody.signed_content)\r",
							"            \r",
							"            displayResponse('Signed person data', responseBody);\r",
							"        }\r",
							"    });\r",
							"} else {\r",
							"    console.log('Initial request failed');\r",
							"}\r",
							"tests[\"Status code is 200\"] = responseCode.code === 200;"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "437f933e-2574-445d-8e4f-0b86de597e06",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-a3164427-ed18-4318-99a3-b13dc937d60e",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"verification_code\": 8431\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/v2/person_requests/{{Person_req_id}}/actions/approve",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"v2",
						"person_requests",
						"{{Person_req_id}}",
						"actions",
						"approve"
					]
				}
			},
			"response": []
		},
		{
			"name": "Sign person request",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "32be31aa-57b0-4a65-a195-736d265a0f54",
						"exec": [
							"const resBody = pm.response.json();",
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"",
							"    const patientID = resBody.data?.person_id",
							"    pm.globals.set('patient_for_regress', patientID)",
							"});",
							""
						],
						"type": "text/javascript",
						"packages": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "b65c9699-c6a7-4d48-9a37-38261f4aced5",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {}
					}
				}
			],
			"id": "15381251-abf12195-a7d1-4fb1-84b5-47f52f928d09",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"signed_content\": \"{{person_req_signed_content}}\"\n}\n\n"
				},
				"url": {
					"raw": "{{host}}/api/v2/person_requests/{{Person_req_id}}/actions/sign",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"v2",
						"person_requests",
						"{{Person_req_id}}",
						"actions",
						"sign"
					]
				}
			},
			"response": []
		},
		{
			"name": "Search for a person",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "fe464840-c6ff-4523-8b55-08c6e79a1925",
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"// Перевіряємо, чи відповідь містить JSON",
							"pm.test(\"Response has valid JSON\", function () {",
							"    pm.response.to.be.json;",
							"});",
							"",
							"// Парсимо тіло відповіді",
							"const jsonData = pm.response.json();",
							"",
							"// Перевірка, чи масив \"data\" порожній",
							"pm.test(\"Data array is not empty\", function () {",
							"    pm.expect(jsonData.data).to.be.an('array').that.is.not.empty;",
							"});",
							"",
							"// Якщо потрібно перевірити, що масив \"data\" саме порожній:",
							"pm.test(\"Data array is not empty\", function () {",
							"    pm.expect(jsonData.data, \"Data array is empty\").to.be.an('array').that.is.not.empty;",
							"});",
							"",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "6f6af315-0768-4a5b-bdc7-be54db1b1675",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-348f8437-f5d1-4794-ae72-613bad4f332a",
			"protocolProfileBehavior": {
				"disabledSystemHeaders": {
					"accept": true,
					"user-agent": true,
					"accept-encoding": true,
					"connection": true
				},
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/persons?first_name={{first_name}}&last_name={{last_name}}&birth_date=2000-12-13",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"persons"
					],
					"query": [
						{
							"key": "second_name",
							"value": "Іванівна",
							"disabled": true
						},
						{
							"key": "first_name",
							"value": "{{first_name}}"
						},
						{
							"key": "last_name",
							"value": "{{last_name}}"
						},
						{
							"key": "birth_date",
							"value": "2000-12-13"
						},
						{
							"key": null,
							"value": "",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Declaration Request V3",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "3cef400f-db1c-463c-a215-367bc77b220d",
						"exec": [
							"const generalResData = pm.response.json();",
							"const parsedGeneraData = JSON.stringify(generalResData, null, 2)",
							"",
							"function displayResponse(title, data) {",
							"    const html = `",
							"        <h1>${title}</h1>",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;",
							"    pm.visualizer.set(html);",
							"}",
							"",
							"",
							"// pm.test(`Response status is not 200, ${generalResData.error ? parsedGeneraData : ''}`, function () {",
							"//     pm.expect(pm.response.code).to.not.eql(200);",
							"//     const errData = pm.response.json();",
							"//     console.log(errData)",
							"//     displayResponse('Create Declaration Request', errData)",
							"// });",
							"",
							"",
							"pm.test(`Declaration request pass. Response status is 200  |  ${parsedGeneraData}`, function () {",
							"    const jsonData = pm.response.json();",
							"    const declarationReqId = jsonData.data.id",
							"    pm.expect(pm.response.code).to.eql(200);",
							"    pm.globals.set('declaration_request_id', declarationReqId)",
							"",
							"",
							"    const resData = pm.response.json();",
							"",
							"    // Extract URLs from the documents array in the response",
							"    const documents = resData.urgent.documents;",
							"    const urls = documents.map(doc => doc.url);",
							"",
							"    const additionalData = {",
							"        row: '0JTQvtC60YPQvNC10L3Rgg=='",
							"    };",
							"",
							"    // Process each URL from the documents array",
							"    urls.forEach(url => {",
							"        processUrl(url, additionalData);",
							"    });",
							"});",
							"",
							"",
							"// Function to handle each URL request",
							"function processUrl(url, additionalData) {",
							"    console.log(url, 'urls loop');",
							"",
							"    pm.sendRequest({",
							"        url: url,",
							"        method: 'PUT',",
							"        header: {",
							"            'Content-Type': 'image/jpeg'",
							"        },",
							"        body: {",
							"            mode: 'raw',",
							"            raw: JSON.stringify(additionalData) // Include additional data in the body",
							"        }",
							"    }, function (err, res) {",
							"        if (err) {",
							"            console.error('Request failed:', err);",
							"            displayResponse('Request Error', { error: err.message });",
							"        } else {",
							"            let responseData;",
							"",
							"            // Check content type to determine how to parse the response",
							"            const contentType = res.headers.get('Content-Type');",
							"            console.log(contentType)",
							"            if (contentType && contentType.includes('text/plain')) {",
							"                try {",
							"                    // Handle TEXT response if needed",
							"                    responseData = res.text(); // Get response as text",
							"                    displayResponse('Document sign successful', { response: responseData });",
							"                } catch (e) {",
							"                    console.error('JSON parsing error:', e);",
							"                    displayResponse('Parsing Error', { error: 'Failed to parse JSON' });",
							"                    return;",
							"                }",
							"                // displayResponse('Document sign successful', responseData);",
							"            } else {",
							"                // Handle other response types if needed",
							"                responseData = res.text(); // Default to text for unknown formats",
							"                displayResponse('Unknown Response Format', { response: responseData });",
							"            }",
							"        }",
							"    });",
							"}",
							"",
							"",
							"",
							"",
							"",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "0dfa2756-78ca-482f-850d-61758d63b97f",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-13b62a57-5f64-4b53-82ba-a917b34e6e36",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"person_id\": \"{{patient_for_regress}}\",\n    \"employee_id\": \"{{user_id}}\",\n    \"division_id\": \"{{user_division_id}}\"\n    // \"authorize_with\": \"ecb05bcd-b907-476f-8c98-ecedf22a1482\"\n}"
				},
				"url": {
					"raw": "{{host}}/api/v3/declaration_requests",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"v3",
						"declaration_requests"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Declaration Request by ID V3",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Get Declaration Request by ID V3 - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "8913febb-588f-40b9-b537-737d565714c5"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [],
						"type": "text/javascript",
						"id": "a1504a29-de6d-4411-b346-b73f032f5df7"
					}
				}
			],
			"id": "15381251-0d24a34c-795f-4b2e-bae5-14168525268a",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/v3/declaration_requests/{{declaration_request_id}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"v3",
						"declaration_requests",
						"{{declaration_request_id}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Approve Declaration Request",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "6b271ae1-363a-4ce0-97cd-f5e260727d0e",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "aa2e8cbd-503e-4fbd-82ef-54735c896e3b",
						"exec": [
							"const jsonData = pm.response.json();",
							"",
							"",
							"function displayResponse(title, data) {",
							"    const html = `",
							"        <h1>${title}</h1>",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;",
							"    pm.visualizer.set(html);",
							"}",
							"",
							"if(jsonData.error){",
							"    displayResponse('Error Approve Declaration Request Details', jsonData)",
							"}",
							"",
							"",
							"",
							"function sendDataToSign(dataToBeSigned) {",
							"    const localServerUrl = 'http://localhost:3000/receive-data';",
							"",
							"    const requestData = {",
							"        method: 'POST',",
							"        url: localServerUrl,",
							"        header: {",
							"            'Content-Type': 'application/json',",
							"        },",
							"        body: {",
							"            mode: 'raw',",
							"            raw: JSON.stringify(dataToBeSigned) // Send the entire response or specific fields",
							"        }",
							"    };",
							"",
							"    // Send the request to the local server",
							"    pm.sendRequest(requestData, function (err, res) {",
							"        if (err) {",
							"            console.error('Error sending request to local server:', err);",
							"        } else {",
							"            console.log('Response from local server:', res.json());",
							"            const responseBody = res.json();",
							"",
							"            console.log(responseBody);",
							"",
							"            pm.globals.set('declaration_signed_content', responseBody.signed_content)",
							"",
							"            displayResponse('Signed declaration data', responseBody);",
							"        }",
							"    });",
							"}",
							"",
							"",
							"pm.test(`Approve declaration request pass. Response status is 200  |  ${JSON.stringify(jsonData, null, 2)}`, function () {",
							"",
							"    pm.expect(pm.response.code).to.eql(200);",
							"",
							"    let dataToBeSigned = jsonData.data.data_to_be_signed;",
							"",
							"    dataToBeSigned.person.patient_signed = true;",
							"",
							"    console.log(dataToBeSigned.person.patient_signed)",
							"",
							"    sendDataToSign(dataToBeSigned);",
							"",
							"})",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-ec1399c3-df11-41fd-a748-e12149f3e088",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"verification_code\": 2446\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/v3/declaration_requests/{{declaration_request_id}}/actions/approve",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"v3",
						"declaration_requests",
						"{{declaration_request_id}}",
						"actions",
						"approve"
					]
				}
			},
			"response": []
		},
		{
			"name": "Sign Declaration Request",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "56f447e6-654b-4770-9bd6-88e86e5d5028",
						"exec": [
							"const jsonData = pm.response.json();\r",
							"\r",
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"if (jsonData.error) {\r",
							"    displayResponse('Error Sign Declaration Request Details', jsonData)\r",
							"}\r",
							"\r",
							"pm.test(`Sign declaration request ${pm.response.code === 200 ? 'pass' : 'fail'}. Response code is ${pm.response.code === 200 ? '200' : pm.response.code} / ${JSON.stringify(jsonData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    console.log(jsonData);\r",
							"    const declarationId = jsonData.data.id;\r",
							"    pm.globals.set('declaration_id', declarationId)\r",
							"})"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "3c01bc7e-4d26-4430-9128-454a32f5e210",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-d500aa9e-c71c-4710-8392-0d7ca646c3e6",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "API-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"signed_declaration_request\": \"{{declaration_signed_content}}\"\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/v3/declaration_requests/{{declaration_request_id}}/actions/sign",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"v3",
						"declaration_requests",
						"{{declaration_request_id}}",
						"actions",
						"sign"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Declaration by ID",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Get Declaration by ID - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "d8766870-7ed5-4661-aa06-0a1fb700a3c4"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [],
						"type": "text/javascript",
						"id": "136ce0c5-552d-4b11-a0c3-170267fea4e1"
					}
				}
			],
			"id": "15381251-fffe98d1-9801-48e2-b7b7-c8565836acd0",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "API-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/declarations/{{declaration_id}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"declarations",
						"{{declaration_id}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Episode",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "36840670-fa01-4bab-81c8-effb1ae2039e",
						"exec": [
							"const uuid = require('uuid');",
							"const id = uuid.v4();",
							"pm.environment.set(\"episode_id\", id);",
							"",
							"const now = new Date();",
							"",
							"// Зменшити дату на 2 дні",
							"const twoDaysAgo = new Date();",
							"twoDaysAgo.setDate(now.getDate() - 2);",
							"",
							"// Форматувати дату у форматі ISO 8601",
							"const formattedDate = twoDaysAgo.toISOString();",
							"console.log(formattedDate)",
							"// Зберегти дату в змінній середовища",
							"pm.globals.set('episode_start_date', formattedDate);",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "e8848f8b-c9c0-4c5b-b90b-5be7b6bbfefd",
						"exec": [
							"function displayResponse(title, data) {",
							"    console.log(title, data)",
							"    const html = `",
							"        <h1>${title}</h1>",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;",
							"    pm.visualizer.set(html);",
							"}",
							"",
							"// Initialize variables to track the number of tests",
							"let allTestsPassed = false;",
							"let passedTestsCount = 0;",
							"let totalTestsCount = 3; // Adjust based on the total number of tests",
							"",
							"// Run your tests",
							"pm.test(\"Check token is not expired\", function () {",
							"    const result = pm.response.code !== 401;",
							"    pm.expect(result).to.be.true;",
							"    if (result) {",
							"        passedTestsCount++;",
							"        allTestsPassed = true;",
							"    }",
							"});",
							"",
							"pm.test(\"Check user has the required scope\", function () {",
							"    const result = pm.response.code !== 403;",
							"    pm.expect(result).to.be.true;",
							"    if (result) {",
							"        passedTestsCount++;",
							"        allTestsPassed = true;",
							"    }",
							"});",
							"",
							"pm.test(\"Check for valid access token\", function () {",
							"    const result = pm.response.code !== 401;",
							"    pm.expect(result).to.be.true;",
							"    if (result) {",
							"        passedTestsCount++;",
							"        allTestsPassed = true;",
							"    }",
							"});",
							"",
							"console.log(`Passed ${passedTestsCount} out of ${totalTestsCount} tests ${passedTestsCount < totalTestsCount}`);",
							"if (passedTestsCount === totalTestsCount) {",
							"    const jsonData = pm.response.json();",
							"    console.log('response in episode', jsonData);",
							"",
							"    pm.test(\"Episode done. Response status is 202\", function () {",
							"        pm.expect(pm.response.code).to.eql(202);",
							"    });",
							"",
							"",
							"",
							"    if (jsonData && jsonData.error) {",
							"        displayResponse('Episode Response Error Details', jsonData.error);",
							"    }",
							"",
							"",
							"    const job_id = jsonData.data.links[0].href.substring(6) || '';",
							"    console.log(job_id)",
							"    pm.globals.set(\"job_id\", job_id);",
							"",
							"    pm.environment.set('retryCount', 0);",
							"",
							"    // Function to check job status",
							"    function checkJobStatus(jobId) {",
							"",
							"        const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;",
							"        const maxRetries = 3; // Set the maximum number of retries",
							"",
							"        pm.sendRequest({",
							"            method: 'GET',",
							"            url: url,",
							"            header: {",
							"                'Content-Type': 'application/json',",
							"                'Authorization': `Bearer ${pm.environment.get('access_token')}`,",
							"                'api-key': `${pm.environment.get('mis_client_secret')}`,",
							"                'X-Custom-PSK': `${pm.globals.get('x-custom-psk')}`",
							"            }",
							"        }, function (err, res) {",
							"",
							"            const responseBody = res.json();",
							"",
							"            pm.test(\"Check if patient is not active\", function () {",
							"                if (responseBody.data.status_code === 409) {",
							"                    pm.expect(responseBody.error.message).to.equal(\"Person is not active\");",
							"                    pm.expect(responseBody.error.type).to.equal(\"request_conflict\");",
							"                }",
							"            });",
							"",
							"            // Валідація ID епізоду",
							"            pm.test(\"Check episode id is unique\", function () {",
							"                // Перевірка, чи статус відповіді є 422",
							"                pm.response.to.not.have.status(422);",
							"",
							"                // Отримання масиву помилок",
							"                const errors = responseBody.data?.error?.invalid || [];",
							"",
							"                // Перевірка на наявність помилки \"Episode with such id already exists\"",
							"                const isIdDuplicate = errors.some(error =>",
							"                    error.entry === \"$.id\" &&",
							"                    Array.isArray(error.rules) &&",
							"                    error.rules.some(rule => rule.description === \"Episode with such id already exists\")",
							"                );",
							"                // Якщо знайдена помилка, тест не пройде",
							"                pm.expect(isIdDuplicate).to.be.false;",
							"            });",
							"",
							"            pm.test(\"Check if episode period start date is valid\", function () {",
							"                const errors = responseBody.data.error?.invalid || [];",
							"                const isPeriodStartError = errors.some(error =>",
							"                    error.entry === \"$.period.start\" &&",
							"                    error.rules.some(rule => rule.description === \"Start date must be in past\")",
							"                );",
							"                pm.expect(isPeriodStartError).to.be.false;",
							"            });",
							"",
							"            if (err) {",
							"                displayResponse('Request Error', { error: err.message });",
							"                console.error('Error checking job status:', err);",
							"            } else {",
							"",
							"                // const responseBody = res.json();",
							"                console.log('Job Status:', responseBody.data.status);",
							"",
							"                if (responseBody.data.status === 'processed') {",
							"",
							"                    pm.test(`Episode Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {",
							"                        // Перевіряємо, чи код відповіді є або 303",
							"                        pm.expect(res.code).to.eql(303);",
							"                    });",
							"",
							"                    // Extract patientID and jobEpisodeID from responseBody",
							"                    const links = responseBody.data.links.reduce((acc, link) => {",
							"                        const href = link.href.replace('/api/', '');",
							"",
							"                        if (href.includes('patients/')) {",
							"                            // Extract patient ID",
							"                            const parts = href.split('/');",
							"                            const patientIDIndex = parts.indexOf('patients') + 1;",
							"                            if (patientIDIndex > 0 && patientIDIndex < parts.length) {",
							"                                acc.patientID = parts[patientIDIndex];",
							"                            }",
							"                        }",
							"",
							"                        if (href.includes('episodes/')) {",
							"                            // Extract episode ID",
							"                            acc.jobEpisodeID = href.split('episodes/')[1];",
							"                        }",
							"",
							"                        return acc;",
							"                    }, {});",
							"",
							"                    // Set globals",
							"                    if (links.patientID) {",
							"                        pm.globals.set('patient_id_from_episode', links.patientID);",
							"                    }",
							"",
							"                    if (links.jobEpisodeID) {",
							"                        pm.globals.set('jobEpisodeID', links.jobEpisodeID);",
							"                    }",
							"",
							"                    // Display response details in visualizer",
							"                    displayResponse('Episode Job Response Details', responseBody.data);",
							"",
							"",
							"                } else {",
							"",
							"                    // Retrieve the current retry count",
							"                    let retryCount = parseInt(pm.environment.get('retryCount')) || 0;",
							"",
							"                    if (retryCount < maxRetries) {",
							"                        // Increment the retry count and set it back to the environment",
							"                        retryCount++;",
							"                        pm.environment.set('retryCount', retryCount);",
							"",
							"                        console.log(`Retrying... Attempt ${retryCount}`);",
							"",
							"                        setTimeout(() => {",
							"                            checkJobStatus(jobId);",
							"                        }, 1000);",
							"",
							"                    } else {",
							"                        console.log('Maximum retry limit reached.');",
							"                        // Display final response details in visualizer",
							"                        displayResponse('Final Job Status Check', responseBody.data);",
							"                    }",
							"                }",
							"            }",
							"        });",
							"    }",
							"",
							"    // Call the function with the job ID",
							"    checkJobStatus(job_id);",
							"",
							"} else {",
							"    console.log('One or more tests failed, skipping job status check.');",
							"}",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-155d48ea-2708-4279-9270-c35ce122d64b",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"id\": \"{{episode_id}}\",\n    \"name\": \"Епізод QA_30\",\n    \"status\": \"active\",\n    \"type\": {\n        \"system\": \"eHealth/episode_types\",\n        \"code\": \"TREATMENT\"\n    },\n    \"period\": {\n        \"start\": \"{{episode_start_date}}\"\n    },\n    \"managing_organization\": {\n        \"identifier\": {\n            \"type\": {\n                \"coding\": [\n                    {\n                        \"system\": \"eHealth/resources\",\n                        \"code\": \"legal_entity\"\n                    }\n                ]\n            },\n            \"value\": \"{{user_legal_entity}}\"\n        }\n    },\n    \"care_manager\": {\n        \"identifier\": {\n            \"type\": {\n                \"coding\": [\n                    {\n                        \"system\": \"eHealth/resources\",\n                        \"code\": \"employee\"\n                    }\n                ]\n            },\n            \"value\": \"{{user_id}}\"\n        }\n    }\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/episodes",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"episodes"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Episode by ID",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Get Episode by ID - PASS. Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "d2abf2ae-c2af-47cd-a791-dd8a29f3bf1d"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"id": "00bb72d5-befd-4557-a6cc-181a7a904251"
					}
				}
			],
			"id": "15381251-9d685665-d095-4c8c-a253-9f63c86a1730",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/episodes/{{jobEpisodeID}}?legal_entity={{user_legal_entity}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"episodes",
						"{{jobEpisodeID}}"
					],
					"query": [
						{
							"key": "legal_entity",
							"value": "{{user_legal_entity}}"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Episode by search params",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Get Episode by search params - PASS. Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "d68a1c1a-37c1-44fe-a50c-231e9c88d704"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"id": "fc73566d-420b-4ab7-850a-740db32b7c6a"
					}
				}
			],
			"id": "15381251-62804fbf-f567-4f46-b17c-70d8233ea6c8",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/episodes?managing_organization_id={{user_legal_entity}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"episodes"
					],
					"query": [
						{
							"key": "page",
							"value": "1",
							"disabled": true
						},
						{
							"key": "page_size",
							"value": "50",
							"disabled": true
						},
						{
							"key": "period_from",
							"value": "2022-05-01",
							"disabled": true
						},
						{
							"key": "period_to",
							"value": "2022-06-20",
							"disabled": true
						},
						{
							"key": "status",
							"value": "active",
							"disabled": true
						},
						{
							"key": "managing_organization_id",
							"value": "{{user_legal_entity}}"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Dummy Encounter data package",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "c4fb34ba-93f5-473b-b57c-4b534d6bb3b0",
						"exec": [
							"const resData = pm.response.json();\r",
							"console.log('create encounter sign content', resData)\r",
							"\r",
							"pm.test(`Encounter content sign success. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    pm.expect(resData).to.have.property('signed_content');\r",
							"    pm.globals.set('encounter_signed_content', resData.signed_content);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "1d830f30-72de-4f4a-9515-78e38f0a3888",
						"exec": [
							"const uuid = require('uuid');\r",
							"const encounterId = uuid.v4();\r",
							"const visitId = uuid.v4();\r",
							"pm.globals.set(\"encounter_dummy_id\", encounterId);\r",
							"pm.globals.set(\"visit_id\", visitId);\r",
							"\r",
							"const episodeStartDate = pm.globals.get('episode_start_date');\r",
							"const encounterDate = new Date(episodeStartDate);\r",
							"\r",
							"console.log(encounterDate)\r",
							"// Додаємо 1 день\r",
							"encounterDate.setDate(encounterDate.getDate() + 1);\r",
							"\r",
							"// Перетворюємо назад у формат ISO 8601\r",
							"const encounterDateISO = encounterDate.toISOString();\r",
							"\r",
							"// Зберігаємо оновлену дату в глобальні змінні\r",
							"pm.globals.set('encounter_start_date', encounterDateISO);\r",
							"\r",
							"console.log(\"Encounter Start Date:\", encounterDateISO);\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-14bd3d30-cecb-4700-89d6-3459b29c620c",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"encounter\": {\r\n        \"id\": \"{{encounter_dummy_id}}\",\r\n        \"status\": \"finished\",\r\n        \"period\": {\r\n            \"start\": \"{{encounter_start_date}}\",\r\n            \"end\": \"{{encounter_start_date}}\"\r\n        },\r\n        \"visit\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"visit\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{visit_id}}\"\r\n            }\r\n        },\r\n        \"actions\": [\r\n            {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/ICPC2/actions\",\r\n                        \"code\": \"N47\"\r\n                    }\r\n                ]\r\n            }\r\n        ],\r\n        \"episode\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"episode\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{jobEpisodeID}}\"\r\n            }\r\n        },\r\n        \"class\": {\r\n            \"system\": \"eHealth/encounter_classes\",\r\n            \"code\": \"PHC\"\r\n        },\r\n        \"type\": {\r\n            \"coding\": [\r\n                {\r\n                    \"system\": \"eHealth/encounter_types\",\r\n                    \"code\": \"service_delivery_location\"\r\n                }\r\n            ]\r\n        },\r\n        \"priority\": {\r\n            \"coding\": [\r\n                {\r\n                    \"system\": \"eHealth/encounter_priority\",\r\n                    \"code\": \"urgent\"\r\n                }\r\n            ]\r\n        },\r\n        \"performer\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"employee\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{user_id}}\"\r\n            }\r\n        },\r\n        \"reasons\": [\r\n            {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/ICPC2/reasons\",\r\n                        \"code\": \"S17\"\r\n                    }\r\n                ]\r\n            }\r\n        ],\r\n        \"diagnoses\": [\r\n            {\r\n                \"condition\": {\r\n                    \"identifier\": {\r\n                        \"type\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"eHealth/resources\",\r\n                                    \"code\": \"condition\"\r\n                                }\r\n                            ]\r\n                        },\r\n                        \"value\": \"{{encounter_dummy_id}}\"\r\n                    }\r\n                },\r\n                \"role\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/diagnosis_roles\",\r\n                            \"code\": \"primary\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"rank\": 1\r\n            }\r\n        ],\r\n        \"division\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"division\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{user_division_id}}\"\r\n            }\r\n        },\r\n        \"prescriptions\": \"Дієта №3, Омепразолу 40 мг 1 раз на добу + амоксициліну 500 мг + метронідазолу 400 мг при необхідності 500 мг або тинідазолу 500 мг 3 рази на добу протягом 1 тижня\"\r\n    },\r\n    \"conditions\": [\r\n        {\r\n            \"id\": \"{{encounter_dummy_id}}\",\r\n            \"primary_source\": true,\r\n            \"asserter\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"employee\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"Якийсь текст\"\r\n                    },\r\n                    \"value\": \"{{user_id}}\"\r\n                }\r\n            },\r\n            \"context\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"encounter\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"value\": \"{{encounter_dummy_id}}\"\r\n                }\r\n            },\r\n            \"code\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/ICPC2/condition_codes\",\r\n                        \"code\": \"T89\"\r\n                    }\r\n                ]\r\n            },\r\n            \"clinical_status\": \"active\",\r\n            \"verification_status\": \"confirmed\",\r\n            \"severity\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/condition_severities\",\r\n                        \"code\": \"moderate\"\r\n                    }\r\n                ]\r\n            },\r\n            \"body_sites\": [\r\n                {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/body_sites\",\r\n                            \"code\": \"pelvis\"\r\n                        }\r\n                    ]\r\n                }\r\n            ],\r\n            \"onset_date\": \"2025-01-10T09:46:37.694Z\",\r\n            \"asserted_date\": \"2025-01-11T09:46:37.694Z\",\r\n            \"stage\": {\r\n                \"summary\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/condition_stages\",\r\n                            \"code\": \"default_condition_stage\"\r\n                        }\r\n                    ]\r\n                }\r\n            },\r\n            \"evidences\": [\r\n                {\r\n                    \"codes\": [\r\n                        {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"eHealth/ICPC2/reasons\",\r\n                                    \"code\": \"T90\"\r\n                                }\r\n                            ]\r\n                        }\r\n                    ]\r\n                }\r\n            ]\r\n        }\r\n    ],\r\n    \"observations\": [\r\n        {\r\n            \"id\": \"{{encounter_dummy_id}}\",\r\n            \"status\": \"valid\",\r\n            \"categories\": [\r\n                {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/ICF/observation_categories\",\r\n                            \"code\": \"functions\"\r\n                        }\r\n                    ]\r\n                }\r\n            ],\r\n            \"code\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/ICF/classifiers\",\r\n                        \"code\": \"b1721\"\r\n                    }\r\n                ]\r\n            },\r\n            \"components\": [\r\n                {\r\n                    \"code\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"code\": \"extent_or_magnitude_of_impairment\",\r\n                                \"system\": \"eHealth/ICF/qualifiers\"\r\n                            }\r\n                        ],\r\n                        \"text\": null\r\n                    },\r\n                    \"interpretation\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/observation_interpretations\",\r\n                                \"code\": \"normal\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"reference_ranges\": [],\r\n                    \"value_codeable_concept\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"code\": \"1\",\r\n                                \"system\": \"eHealth/ICF/qualifiers/extent_or_magnitude_of_impairment\"\r\n                            }\r\n                        ],\r\n                        \"text\": null\r\n                    }\r\n                }\r\n            ],\r\n            \"effective_date_time\": \"2025-01-20T10:45:16.000Z\",\r\n            \"issued\": \"2025-01-21T10:45:16.000Z\",\r\n            \"primary_source\": true,\r\n            \"performer\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"employee\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"Галина Олександрівна\"\r\n                    },\r\n                    \"value\": \"{{user_id}}\"\r\n                }\r\n            },\r\n            \"comment\": \"Some comment\",\r\n            \"value_quantity\": {\r\n                \"value\": 0,\r\n                \"comparator\": \">\",\r\n                \"unit\": \"kg\",\r\n                \"system\": \"eHealth/ucum/units\",\r\n                \"code\": \"kg\"\r\n            },\r\n            \"context\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"encounter\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"value\": \"{{encounter_dummy_id}}\"\r\n                }\r\n            }\r\n        }\r\n    ],\r\n    \"immunizations\": [\r\n        {\r\n            \"id\": \"{{encounter_dummy_id}}\",\r\n            \"status\": \"completed\",\r\n            \"not_given\": false,\r\n            \"vaccine_code\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/vaccine_codes\",\r\n                        \"code\": \"SarsCov2_nRVv\"\r\n                    }\r\n                ]\r\n            },\r\n            \"context\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"encounter\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"value\": \"{{encounter_dummy_id}}\"\r\n                }\r\n            },\r\n            \"date\": \"2025-01-19T09:46:37.694Z\",\r\n            \"primary_source\": true,\r\n            \"performer\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"employee\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"Текст 123\"\r\n                    },\r\n                    \"value\": \"{{user_id}}\"\r\n                }\r\n            },\r\n            \"manufacturer\": \"VacinePro Manufacturer\",\r\n            \"lot_number\": \"041A21A\",\r\n            \"expiration_date\": \"2025-10-02T09:46:37.694Z\",\r\n            \"site\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/immunization_body_sites\",\r\n                        \"code\": \"outer_surface_of_(left_shoulder)\"\r\n                    }\r\n                ]\r\n            },\r\n            \"route\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/vaccination_routes\",\r\n                        \"code\": \"intramuscularly\"\r\n                    }\r\n                ]\r\n            },\r\n            \"dose_quantity\": {\r\n                \"value\": 5,\r\n                \"unit\": \"MG\",\r\n                \"system\": \"eHealth/immunization_dosage_units\",\r\n                \"code\": \"MG\"\r\n            },\r\n            \"explanation\": {\r\n                \"reasons\": [\r\n                    {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/reason_explanations\",\r\n                                \"code\": \"immunization_by_epidemic_indicators\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"Щеплення, які проводяться на ендемічних і ензоотичних територіях та за епідемічними показаннями\"\r\n                    }\r\n                ]\r\n            },\r\n            \"vaccination_protocols\": [\r\n                {\r\n                    \"dose_sequence\": 1,\r\n                    \"description\": \"Опис 123\",\r\n                    \"authority\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/vaccination_authorities\",\r\n                                \"code\": \"MoH\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"series\": \"Vaccination Series 1\",\r\n                    \"series_doses\": 1,\r\n                    \"target_diseases\": [\r\n                        {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"eHealth/vaccination_target_diseases\",\r\n                                    \"code\": \"COVID_19\"\r\n                                }\r\n                            ]\r\n                        }\r\n                    ]\r\n                }\r\n            ]\r\n        }\r\n    ]\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "http://localhost:3000/create-encounter-signed-content",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "3000",
					"path": [
						"create-encounter-signed-content"
					]
				}
			},
			"response": []
		},
		{
			"name": "Submit encounter datapackage",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "a28f1d86-7645-44f9-83dc-eb93f4d5ee7b",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Encounter Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': `${pm.globals.get('x-custom-psk')}`\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"            pm.expect([200, 303]).to.include(res.code);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                pm.test(`Encounter Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(303);\r",
							"                });\r",
							"\r",
							"                const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                    acc[link.entity] = link.href.replace('/api/', '');\r",
							"                    return acc;\r",
							"                }, {});\r",
							"\r",
							"                // Iterate over the links object and set globals dynamically\r",
							"                Object.entries(links).forEach(([entity, href]) => {\r",
							"                    const globalName = `job${entity.charAt(0).toUpperCase() + entity.slice(1).replace('_', '')}ID`;\r",
							"                    pm.globals.set(globalName, href);\r",
							"                });\r",
							"\r",
							"\r",
							"                displayResponse('Encounter Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Encounter Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Encounter Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "1cdbc1f9-752b-492f-9b40-7a7ba60748c0",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-d116602c-c33f-41c8-8318-4ba9ce358cf3",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"visit\": {\n    \"id\": \"{{visit_id}}\",\n    \"period\": {\n      \"start\": \"2022-05-05T10:42:16.000Z\",\n      \"end\": \"2024-06-10T11:46:17.000Z\"\n    }\n  },\n  \"signed_data\": \"{{encounter_signed_content}}\"\n}\n"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/encounter_package",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"encounter_package"
					]
				}
			},
			"response": []
		},
		{
			"name": "Care_plan_dummy",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const uuid = require('uuid');\r",
							"const carePlanId = uuid.v4();\r",
							"\r",
							"pm.globals.set(\"care_plan_id\", carePlanId);\r",
							"\r",
							"const encounterPeriodes = pm.globals.get('encounter_start_date');\r",
							"const encounterDate = new Date(encounterPeriodes);\r",
							"\r",
							"// Додаємо 1 день для carePlanStartDate\r",
							"const carePlanStartDate = new Date(encounterDate);\r",
							"carePlanStartDate.setDate(carePlanStartDate.getDate() + 1);\r",
							"\r",
							"// Додаємо 10 днів для carePlanEndDate\r",
							"const carePlanEndDate = new Date(carePlanStartDate);\r",
							"carePlanEndDate.setDate(carePlanEndDate.getDate() + 10);\r",
							"\r",
							"// Конвертуємо у формат ISO 8601\r",
							"const carePlanStartDateISO = carePlanStartDate.toISOString();\r",
							"const carePlanEndDateISO = carePlanEndDate.toISOString();\r",
							"\r",
							"// Зберігаємо значення в глобальні змінні\r",
							"pm.globals.set('carePlanStartDate', carePlanStartDateISO);\r",
							"pm.globals.set('carePlanEndDate', carePlanEndDateISO);\r",
							"\r",
							"console.log(\"Care Plan Start Date:\", carePlanStartDateISO);\r",
							"console.log(\"Care Plan End Date:\", carePlanEndDateISO);\r",
							"\r",
							"\r",
							"\r",
							"// Retrieve the URL from the global variable\r",
							"const url = pm.globals.get('jobEncounterID');\r",
							"\r",
							"// Check if the URL is defined and contains the expected format\r",
							"if (url && url.includes('encounters/')) {\r",
							"    // Extract the ID after 'encounters/'\r",
							"    const parts = url.split('encounters/');\r",
							"    if (parts.length > 1) {\r",
							"        const jobEncounterID = parts[1];\r",
							"        \r",
							"        // Log the extracted ID to the console (for debugging purposes)\r",
							"        console.log('Extracted jobEncounterID:', jobEncounterID);\r",
							"        \r",
							"        // Optionally, set the extracted ID as an environment variable\r",
							"        pm.globals.set('encounter_extracted_id', jobEncounterID);\r",
							"    } else {\r",
							"        console.error('The URL does not contain the expected format.');\r",
							"    }\r",
							"} else {\r",
							"    console.error('The global variable jobEncounterID is not defined or does not contain the expected format.');\r",
							"}"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "5e7c221d-6d79-409b-83fd-cd79b9313159"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"\r",
							"pm.test(`Care Plan content sign success. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    pm.expect(resData).to.have.property('signed_content');\r",
							"    pm.globals.set('care_plan_signed_content', resData.signed_content);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "e14633c7-fe8f-4f4e-b5e1-c9e61458da18"
					}
				}
			],
			"id": "15381251-9783e977-8543-426b-8f11-a374e564a403",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"id\": \"{{care_plan_id}}\",\r\n    \"category\": {\r\n        \"coding\": [\r\n            {\r\n                \"system\": \"eHealth/care_plan_categories\",\r\n                \"code\": \"class_4\"\r\n            }\r\n        ]\r\n    },\r\n    \"title\": \"План Лікуваня\",\r\n    \"description\": \"123\",\r\n    \"period\": {\r\n        \"start\": \"{{carePlanStartDate}}\",\r\n        \"end\": \"{{carePlanEndDate}}\"\r\n    },\r\n    \"note\": \"123\",\r\n    \"intent\": \"order\",\r\n    \"encounter\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"encounter\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{encounter_extracted_id}}\"\r\n        }\r\n    },\r\n    \"addresses\": [\r\n        {\r\n            \"coding\": [\r\n                {\r\n                    \"system\": \"eHealth/ICPC2/condition_codes\",\r\n                    \"code\": \"T89\"\r\n                }\r\n            ]\r\n        }\r\n    ],\r\n    \"author\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"employee\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_id}}\"\r\n        }\r\n    },\r\n    \"terms_of_service\": {\r\n        \"coding\": [\r\n            {\r\n                \"system\": \"PROVIDING_CONDITION\",\r\n                \"code\": \"OUTPATIENT\"\r\n            }\r\n        ]\r\n    },\r\n    \"status\": \"new\"\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "http://localhost:3000/create-care-plan-signed-content",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "3000",
					"path": [
						"create-care-plan-signed-content"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Care Plan",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "4bcedd17-f351-4a40-8195-fcd427903ae2",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"pm.test(\"Care Plan done. Response status is 202\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(202);\r",
							"});\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Care Plan Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': `${pm.globals.get('x-custom-psk')}`\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"            pm.expect([200, 303]).to.include(res.code);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                pm.test(`Care Plan Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(303);\r",
							"                });\r",
							"\r",
							"                const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                    // Extract the part after \"care_plans/\" if present\r",
							"                    const href = link.href.replace('/api/', '');\r",
							"                    acc[link.entity] = href.includes('care_plans/') ? href.split('care_plans/')[1] : href;\r",
							"                    return acc;\r",
							"                }, {});\r",
							"\r",
							"                // Iterate over the links object and set globals dynamically\r",
							"                Object.entries(links).forEach(([entity, href]) => {\r",
							"                    const globalName = `job${entity.charAt(0).toUpperCase() + entity.slice(1).replace('_', '')}ID`;\r",
							"                    pm.globals.set(globalName, href);\r",
							"                });\r",
							"\r",
							"\r",
							"                displayResponse('Care Plan Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Care Plan Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Care Plan Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "a3326218-ce8f-44bb-a80a-226735832bfa",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-6da8c45c-f207-407c-a485-4c7ee1ba9943",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"signed_data\": \"{{care_plan_signed_content}}\"\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/care_plans",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"care_plans"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Care Plan by ID",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "0ec9f7fd-a2ba-4554-995a-beb48f6b840c",
						"exec": [
							"pm.test(\"Get Care Plan by ID - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "a63d8835-8663-437f-bc48-27ad39ed9706",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-c5c4e624-85f2-4893-9b5c-c11f08e94602",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/care_plans/{{jobCareplanID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"care_plans",
						"{{jobCareplanID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Care Plans by search params",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "d2031ad7-3246-4194-9bc9-ddc62ada14aa",
						"exec": [
							"pm.test(\"Get Care Plans by search params - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "b1f4a4ac-803e-4d4c-b592-c6db5aed7d5d",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-934634ad-1eb6-4bac-8c1a-4d4104789a78",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/care_plans?encounter_id={{encounter_extracted_id}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"care_plans"
					],
					"query": [
						{
							"key": "period_date",
							"value": "2018-08-02",
							"disabled": true
						},
						{
							"key": "based_on",
							"value": "7c3da506-804d-4550-8993-bf17f9ee0401",
							"disabled": true
						},
						{
							"key": "part_of",
							"value": "7c3da506-804d-4550-8993-bf17f9ee0401",
							"disabled": true
						},
						{
							"key": "managing_organization_id",
							"value": "80a9e15b-b71b-4caf-8f2e-ff247e8a5677",
							"disabled": true
						},
						{
							"key": "status",
							"value": "active",
							"disabled": true
						},
						{
							"key": "page",
							"value": "2",
							"disabled": true
						},
						{
							"key": "page_size",
							"value": "50",
							"disabled": true
						},
						{
							"key": "encounter_id",
							"value": "{{encounter_extracted_id}}"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Create approval",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "4ef1ed11-812d-499e-a20e-0ac758607754",
						"exec": [
							"const patientId = pm.globals.get('patient_id_from_episode');\r",
							"const url = `https://api-demo.ehealth.gov.ua/api/persons/${patientId}/authentication_methods`;\r",
							"const accessToken = pm.environment.get('access_token');\r",
							"\r",
							"function displayResponse(title, data) {\r",
							"    console.log(title, data)\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"pm.sendRequest({\r",
							"    url: url,\r",
							"    method: 'GET',\r",
							"    header: {\r",
							"        'Content-Type': 'application/json',\r",
							"        'Authorization': `Bearer ${accessToken}`,\r",
							"        'api-key': '30276e63617461a185ec',\r",
							"        'X-Custom-PSK': 'a2ffb0888561e50d5a868faf56ea5708619b7ecc03b5bd21ff1a50f37a3f430e'\r",
							"    }\r",
							"}, function (err, res) {\r",
							"    if (err) {\r",
							"        console.error('Error in request:', err);\r",
							"    } else {\r",
							"        console.log('Response Status:', res.status);\r",
							"        console.log('Response Body:', res.text());\r",
							"\r",
							"        // Optional: Process the response data if needed\r",
							"        try {\r",
							"            const responseData = res.json();\r",
							"\r",
							"            // Extract the ID from the response data\r",
							"            if (responseData.data && responseData.data.length > 0) {\r",
							"                const id = responseData.data[0].id;\r",
							"\r",
							"                // Set the extracted ID in the Postman globals\r",
							"                pm.globals.set('patient_authentication_methods_in_approval', id);\r",
							"\r",
							"                displayResponse('Patient authentication methods in approval details', responseData)\r",
							"                console.log('Global Variable \"authenticationMethodID\" set to:', id);\r",
							"            } else {\r",
							"                console.log('No data found in response.');\r",
							"            }\r",
							"\r",
							"            console.log('Parsed Response Data:', responseData.data);\r",
							"        } catch (parseError) {\r",
							"            console.error('Error parsing response JSON:', parseError);\r",
							"        }\r",
							"    }\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "3f9fd889-b460-4028-95d5-5ea189fd8976",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"pm.test(\"Approval Response status code is 202\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(202);\r",
							"});\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Create Approval Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': `${pm.globals.get('x-custom-psk')}`\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"            pm.expect([200, 303]).to.include(res.code);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                // const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                //     acc[link.entity] = link.href.replace('/api/', '');\r",
							"                //     return acc;\r",
							"                // }, {});\r",
							"\r",
							"                // // Iterate over the links object and set globals dynamically\r",
							"                // Object.entries(links).forEach(([entity, href]) => {\r",
							"                //     const globalName = `job${entity.charAt(0).toUpperCase() + entity.slice(1).replace('_', '')}ID`;\r",
							"                //     pm.globals.set(globalName, href);\r",
							"                // });\r",
							"                pm.test(`Approval Job Success. Response status is 200 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(200);\r",
							"                });\r",
							"\r",
							"                const approvalId = responseBody.data.response_data.id\r",
							"                console.log(approvalId)\r",
							"\r",
							"                pm.globals.set('jobApprovalID', approvalId);\r",
							"                displayResponse('Create Approval Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Create Approval Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Create Approval Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-5ce9d070-dea2-46b9-810b-19eb9e1ee62e",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"resources\": [\r\n        {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"care_plan\"\r\n                        }\r\n                    ],\r\n                    \"text\": \"\"\r\n                },\r\n                \"value\": \"{{jobCareplanID}}\"\r\n            }\r\n        }\r\n    ],\r\n    \"granted_to\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"employee\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_id}}\"\r\n        }\r\n    },\r\n    \"access_level\": \"write\"\r\n    }"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/approvals",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"approvals"
					]
				}
			},
			"response": []
		},
		{
			"name": "Verify approval",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "b02cae6a-c64e-4cee-b570-209c29657ecc",
						"exec": [
							"pm.test(\"Verify Approval is 200\", function () {",
							"    pm.expect(pm.response.code).to.eql(200);",
							"});",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "b7239e2e-84d4-49b6-a69e-a66d0917d916",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-a5536ee9-6ba0-438e-8f3b-38d28739597e",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"code\": 4328\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/approvals/{{jobApprovalID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"approvals",
						"{{jobApprovalID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get approvals",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "abed0e0e-6fd1-4a46-b28c-b8066101d9fa",
						"exec": [
							"pm.test(\"Get approvals is 200\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"});\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "1d32833a-9aaa-4c77-b542-6828b2c32abf",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-b4af856a-05e0-4c4d-b72f-5211c88b2e9f",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/approvals",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"approvals"
					],
					"query": [
						{
							"key": "granted_to",
							"value": "7ca4c165-b3b9-47bc-95f9-a9c1708f543a",
							"disabled": true
						},
						{
							"key": "granted_resources",
							"value": "0f7e98c3-e17a-48bc-85ab-a60ed506652c",
							"disabled": true
						},
						{
							"key": "granted_resource_type",
							"value": "diagnostic_report",
							"disabled": true
						},
						{
							"key": "reason",
							"value": "7c3da506-804d-4550-8993-bf17f9ee0401",
							"disabled": true
						},
						{
							"key": "access_level",
							"value": "read",
							"disabled": true
						},
						{
							"key": "page",
							"value": "2",
							"disabled": true
						},
						{
							"key": "page_size",
							"value": "50",
							"disabled": true
						},
						{
							"key": "status",
							"value": "active",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "PreQualify Care Plan Activity",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "4658e667-07df-4054-b37b-5697c35850bb",
						"exec": [
							"// Retrieve the URL from the global variable\r",
							"const url = pm.globals.get('jobConditionID');\r",
							"\r",
							"const carePlanStartDate = pm.globals.get('carePlanStartDate');\r",
							"const carePlanDate = new Date(carePlanStartDate);\r",
							"\r",
							"// Додаємо 1 день для activityStartDate\r",
							"const activityStartDate = new Date(carePlanDate);\r",
							"activityStartDate.setDate(activityStartDate.getDate() + 1);\r",
							"\r",
							"\r",
							"// Конвертуємо у формат ISO 8601\r",
							"const activityStartDateISO = activityStartDate.toISOString();\r",
							"\r",
							"// Зберігаємо значення в глобальні змінні\r",
							"pm.globals.set('activityStartDate', activityStartDateISO);\r",
							"\r",
							"console.log(\"Activity Start Date:\", activityStartDateISO);\r",
							"\r",
							"\r",
							"\r",
							"\r",
							"// Check if the URL is defined and contains the expected format\r",
							"if (url && url.includes('conditions/')) {\r",
							"    // Extract the ID after 'conditions/'\r",
							"    const parts = url.split('conditions/');\r",
							"    if (parts.length > 1) {\r",
							"        const jobConditionID = parts[1];\r",
							"        \r",
							"        // Log the extracted ID to the console (for debugging purposes)\r",
							"        console.log('Extracted jobConditionID:', jobConditionID);\r",
							"        \r",
							"        // Optionally, set the extracted ID as an environment variable\r",
							"        pm.globals.set('condition_extracted_id', jobConditionID);\r",
							"    } else {\r",
							"        console.error('The URL does not contain the expected format.');\r",
							"    }\r",
							"} else {\r",
							"    console.error('The global variable jobConditionID is not defined or does not contain the expected format.');\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "b8d5d490-cc21-4df1-af4f-335207de5c8e",
						"exec": [
							"pm.test(\"PreQualify Care Plan Activity Response status code is 200\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"});\r",
							"\r",
							"pm.test(\"PreQualify Care Plan Activity status is VALID\", function () {\r",
							"   const resData = pm.response.json();\r",
							"    console.log(resData.data[0].status)\r",
							"    const status = resData.data[0].status;\r",
							"    pm.expect(status).to.eql(\"VALID\");\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-750fa18c-5b43-4377-a3dd-4f5b7eef32e4",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"activity\": {\r\n        \"author\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"employee\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{user_id}}\"\r\n            }\r\n        },\r\n        \"care_plan\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"care_plan\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{jobCareplanID}}\"\r\n            }\r\n        },\r\n        \"detail\": {\r\n            \"kind\": \"service_request\",\r\n            \"product_reference\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"service\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"\"\r\n                    },\r\n                    \"value\": \"2a3bdbc7-98d7-4892-8f82-6572f67d3bc9\"\r\n                }\r\n            },\r\n            \"reason_code\": [\r\n                {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/ICD10_AM/condition_codes\",\r\n                            \"code\": \"E10.9\"\r\n                        }\r\n                    ]\r\n                }\r\n            ],\r\n            \"reason_reference\": [\r\n                {\r\n                    \"identifier\": {\r\n                        \"type\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"eHealth/resources\",\r\n                                    \"code\": \"condition\"\r\n                                }\r\n                            ]\r\n                        },\r\n                        \"value\": \"{{condition_extracted_id}}\"\r\n                    }\r\n                }\r\n            ],\r\n            \"goal\": [\r\n                {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/care_plan_activity_goals\",\r\n                            \"code\": \"patient_maintaince\"\r\n                        }\r\n                    ]\r\n                }\r\n            ],\r\n            \"quantity\": {\r\n                \"value\": 56,\r\n                \"system\": \"SERVICE_UNIT\",\r\n                \"code\": \"PIECE\"\r\n            },\r\n            \"scheduled_period\": {\r\n                \"start\": \"{{activityStartDate}}\",\r\n                \"end\": \"{{carePlanEndDate}}\"\r\n            },\r\n            \"location\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"division\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"value\": \"{{user_division_id}}\"\r\n                }\r\n            },\r\n            \"performer\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"employee\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"value\": \"{{user_id}}\"\r\n                }\r\n            },\r\n            \"daily_amount\": {\r\n                \"value\": 1.0,\r\n                \"system\": \"SERVICE_UNIT\",\r\n                \"code\": \"PIECE\"\r\n            },\r\n            \"description\": \"Some activity description\",\r\n            \"do_not_perform\": false,\r\n            \"status\": \"scheduled\"\r\n        }\r\n    },\r\n    \"programs\": [\r\n        {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"medical_program\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"0eb268fa-ab21-4df9-8d58-1bc85e393533\"\r\n            }\r\n        }\r\n    ]\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/care_plans/{{jobCareplanID}}/activities/prequalify",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"care_plans",
						"{{jobCareplanID}}",
						"activities",
						"prequalify"
					]
				}
			},
			"response": []
		},
		{
			"name": "SR dummy care plan activity",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const uuid = require('uuid');\r",
							"const caraPlanActivityId = uuid.v4();\r",
							"\r",
							"pm.globals.set(\"care_plan_activity_id\", caraPlanActivityId);"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "fd160839-13df-4934-b4b7-7a530500f300"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"pm.test(`Care Plan Activity content sign success. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    pm.expect(resData).to.have.property('signed_content');\r",
							"    pm.globals.set('care_plan_activity_signed_content', resData.signed_content);\r",
							"});\r",
							"\r",
							"\r",
							"// if(resData.signed_content){\r",
							"//     pm.globals.set('care_plan_activity_signed_content', resData.signed_content)\r",
							"// }"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "1104d7f7-74cd-4336-9fd0-14aeaf1fa3ba"
					}
				}
			],
			"id": "15381251-9a1c2b9b-a699-4383-a547-daa6b66a8abf",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"id\": \"{{care_plan_activity_id}}\",\r\n    \"author\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"employee\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_id}}\"\r\n        }\r\n    },\r\n    \"care_plan\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"care_plan\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{jobCareplanID}}\"\r\n        }\r\n    },\r\n    \"detail\": {\r\n        \"kind\": \"service_request\",\r\n        \"product_reference\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"service\"\r\n                        }\r\n                    ],\r\n                    \"text\": \"\"\r\n                },\r\n                \"value\": \"2a3bdbc7-98d7-4892-8f82-6572f67d3bc9\"\r\n            }\r\n        },\r\n        \"reason_code\": [\r\n            {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/ICD10_AM/condition_codes\",\r\n                        \"code\": \"E10.9\"\r\n                    }\r\n                ]\r\n            }\r\n        ],\r\n        \"reason_reference\": [\r\n            {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"condition\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"value\": \"{{condition_extracted_id}}\"\r\n                }\r\n            }\r\n        ],\r\n        \"goal\": [\r\n            {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/care_plan_activity_goals\",\r\n                        \"code\": \"patient_maintaince\"\r\n                    }\r\n                ]\r\n            }\r\n        ],\r\n        \"quantity\": {\r\n            \"value\": 56,\r\n            \"system\": \"SERVICE_UNIT\",\r\n            \"code\": \"PIECE\"\r\n        },\r\n        \"scheduled_period\": {\r\n           \"start\": \"{{activityStartDate}}\",\r\n                \"end\": \"{{carePlanEndDate}}\"\r\n        },\r\n        \"location\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"division\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{user_division_id}}\"\r\n            }\r\n        },\r\n        \"performer\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"employee\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{user_id}}\"\r\n            }\r\n        },\r\n        \"description\": \"Some activity description 123\",\r\n        \"do_not_perform\": false,\r\n        \"program\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"medical_program\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"0eb268fa-ab21-4df9-8d58-1bc85e393533\"\r\n            }\r\n        },\r\n        \"status\": \"scheduled\"\r\n    }\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "http://localhost:3000/create-care-plan-activity-signed-content",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "3000",
					"path": [
						"create-care-plan-activity-signed-content"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Care Plan Activity",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "ee2f16f2-5c72-46b2-8456-dbf994d3843e",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"pm.test(\"Care Plan Activity Response status code is 202\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(202);\r",
							"});\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Care Plan Activity Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': '0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b'\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"            pm.expect([200, 303]).to.include(res.code);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                 pm.test(`Care Plan Activity Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(303);\r",
							"                });\r",
							"\r",
							"                const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                    // Extract the part after \"/api/\"\r",
							"                    const href = link.href.replace('/api/', '');\r",
							"\r",
							"                    // Set the link entity to global variables\r",
							"                    acc[link.entity] = href;\r",
							"\r",
							"                    if (href.includes('activities/')) {\r",
							"                        const activityId = href.split('/')[5]; // Extract the activity ID\r",
							"                        acc['jobActivity'] = activityId;\r",
							"                    }\r",
							"\r",
							"                    return acc;\r",
							"                }, {});\r",
							"\r",
							"                // Iterate over the links object and set globals dynamically\r",
							"                Object.entries(links).forEach(([entity, value]) => {\r",
							"                    const globalName = `${entity.charAt(0).toUpperCase() + entity.slice(1)}ID`;\r",
							"                    pm.globals.set(globalName, value);\r",
							"                });\r",
							"\r",
							"\r",
							"                displayResponse('Care Plan Activity Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Care Plan Activity Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Care Plan Activity Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "c1cdd004-b3d3-4c69-9eea-e45c8d8de6f4",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-25f2e2b3-b8f2-487f-a8df-a79201b03b01",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"signed_data\": \"{{care_plan_activity_signed_content}}\"\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/care_plans/{{jobCareplanID}}/activities",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"care_plans",
						"{{jobCareplanID}}",
						"activities"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Care Plan Activity by ID",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "9b6a98f2-e3ce-48dc-b497-638abceee2ff",
						"exec": [
							"pm.test(\"Get Care Plan Activity by ID - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "997f9fd5-e235-4b0d-a7fd-872add5fe153",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-769ced3a-872e-4418-b18c-c2448f541149",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/care_plans/{{jobCareplanID}}/activities/{{JobActivityID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"care_plans",
						"{{jobCareplanID}}",
						"activities",
						"{{JobActivityID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Care Plan activities",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Get Care Plan activities - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "2b325cbf-ce54-43c1-9630-d654fd420c00"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [],
						"type": "text/javascript",
						"id": "c35ccbec-6527-4108-84d9-7b2cd4091884"
					}
				}
			],
			"id": "15381251-85373cec-23a1-488c-9ddf-778ab7488ad4",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/care_plans/{{jobCareplanID}}/activities",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"care_plans",
						"{{jobCareplanID}}",
						"activities"
					],
					"query": [
						{
							"key": "author",
							"value": "9183a36b-4d45-4244-9339-63d81cd08d9c",
							"disabled": true
						},
						{
							"key": "kind",
							"value": "service_request",
							"disabled": true
						},
						{
							"key": "status",
							"value": "scheduled",
							"disabled": true
						},
						{
							"key": "page",
							"value": "2",
							"disabled": true
						},
						{
							"key": "page_size",
							"value": "5",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "PreQualify Service Request",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "122077e5-4bed-4911-be2d-cd2bad8c89f2",
						"exec": [
							"// Retrieve the URL from the global variable\r",
							"const url = pm.globals.get('jobEncounterID');\r",
							"\r",
							"const today = new Date();\r",
							"\r",
							"// Встановлюємо serviceRequestStartDate на завтра\r",
							"const serviceRequestStartDate = new Date(today);\r",
							"serviceRequestStartDate.setDate(serviceRequestStartDate.getDate() + 1);\r",
							"\r",
							"// Встановлюємо serviceRequestEndDate на 10 днів після serviceRequestStartDate\r",
							"const serviceRequestEndDate = new Date(serviceRequestStartDate);\r",
							"serviceRequestEndDate.setDate(serviceRequestEndDate.getDate() + 10);\r",
							"\r",
							"// Форматуємо дати у формат ISO 8601\r",
							"const serviceRequestStartDateISO = serviceRequestStartDate.toISOString();\r",
							"const serviceRequestEndDateISO = serviceRequestEndDate.toISOString();\r",
							"\r",
							"// Зберігаємо у глобальні змінні\r",
							"pm.globals.set('serviceRequestStartDate', serviceRequestStartDateISO);\r",
							"pm.globals.set('serviceRequestEndDate', serviceRequestEndDateISO);\r",
							"\r",
							"console.log(\"Service Request Start Date:\", serviceRequestStartDateISO);\r",
							"console.log(\"Service Request End Date:\", serviceRequestEndDateISO);\r",
							"\r",
							"\r",
							"\r",
							"\r",
							"\r",
							"// Check if the URL is defined and contains the expected format\r",
							"if (url && url.includes('encounters/')) {\r",
							"    // Extract the ID after 'encounters/'\r",
							"    const parts = url.split('encounters/');\r",
							"    if (parts.length > 1) {\r",
							"        const jobEncounterID = parts[1];\r",
							"        \r",
							"        // Log the extracted ID to the console (for debugging purposes)\r",
							"        console.log('Extracted jobEncounterID:', jobEncounterID);\r",
							"        \r",
							"        // Optionally, set the extracted ID as an environment variable\r",
							"        pm.globals.set('encounter_extracted_id', jobEncounterID);\r",
							"    } else {\r",
							"        console.error('The URL does not contain the expected format.');\r",
							"    }\r",
							"} else {\r",
							"    console.error('The global variable jobEncounterID is not defined or does not contain the expected format.');\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "098a0671-9483-45ca-8b06-05a5dd18aac3",
						"exec": [
							"pm.test(\"PreQualify Service Request Response status code is 200\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"});\r",
							"\r",
							"pm.test(\"PreQualify Service Request status is VALID\", function () {\r",
							"    const resData = pm.response.json();\r",
							"    console.log(resData.data[0].status)\r",
							"    const status = resData.data[0].status;\r",
							"    pm.expect(status).to.eql(\"VALID\");\r",
							"});\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-9ef59f44-56d7-4c7c-b653-643a356bd3ca",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "API-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"service_request\": {\r\n        \"status\": \"active\",\r\n        \"intent\": \"order\",\r\n        \"priority\": \"routine\",\r\n        \"category\": {\r\n            \"coding\": [\r\n                {\r\n                    \"system\": \"eHealth/SNOMED/service_request_categories\",\r\n                    \"code\": \"procedure\"\r\n                }\r\n            ]\r\n        },\r\n        \"code\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"service\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"40b2dfdf-7623-4fa5-bbfb-58a6b651ff0c\"\r\n            }\r\n        },\r\n        \"context\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"encounter\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{encounter_extracted_id}}\"\r\n            }\r\n        },\r\n        \"occurrence_period\": {\r\n            \"start\": \"{{serviceRequestStartDate}}\",\r\n            \"end\": \"{{serviceRequestEndDate}}\"\r\n        },\r\n        \"requester_employee\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"employee\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{user_id}}\"\r\n            }\r\n        },\r\n        \"requester_legal_entity\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"legal_entity\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{user_legal_entity}}\"\r\n            }\r\n        }\r\n    },\r\n    \"programs\": [\r\n        {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"medical_program\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"0eb268fa-ab21-4df9-8d58-1bc85e393533\"\r\n            }\r\n        }\r\n    ]\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/service_requests/prequalify",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"service_requests",
						"prequalify"
					]
				}
			},
			"response": []
		},
		{
			"name": "Dummy Service Request",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const uuid = require('uuid');\r",
							"const serviceRequestId = uuid.v4();\r",
							"\r",
							"pm.globals.set(\"service_request_id\", serviceRequestId);"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "a99c8384-fc48-498a-8791-2143f209fba5"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"pm.test(`Service Request content sign success. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    pm.expect(resData).to.have.property('signed_content');\r",
							"    pm.globals.set('service_request_signed_content', resData.signed_content);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "f7a85fab-b962-4ace-b6b3-ed89afeabd6a"
					}
				}
			],
			"id": "15381251-ac0c4130-50ea-4bea-8bf4-9ecb62baa6f2",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"id\": \"{{service_request_id}}\",\r\n    \"status\": \"active\",\r\n    \"intent\": \"order\",\r\n    \"priority\": \"routine\",\r\n    \"category\": {\r\n        \"coding\": [\r\n            {\r\n                \"system\": \"eHealth/SNOMED/service_request_categories\",\r\n                \"code\": \"procedure\"\r\n            }\r\n        ]\r\n    },\r\n    \"code\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"service\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"40b2dfdf-7623-4fa5-bbfb-58a6b651ff0c\"\r\n        }\r\n    },\r\n    \"context\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"encounter\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{encounter_extracted_id}}\"\r\n        }\r\n    },\r\n    \"occurrence_period\": {\r\n        \"start\": \"{{serviceRequestStartDate}}\",\r\n            \"end\": \"{{serviceRequestEndDate}}\"\r\n    },\r\n    \"requester_employee\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"employee\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_id}}\"\r\n        }\r\n    },\r\n    \"requester_legal_entity\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"legal_entity\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_legal_entity}}\"\r\n        }\r\n    },\r\n    \"program\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"medical_program\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"0eb268fa-ab21-4df9-8d58-1bc85e393533\"\r\n        }\r\n    }\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "http://localhost:3000/create-service-request-signed-content",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "3000",
					"path": [
						"create-service-request-signed-content"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Service Request",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "acd599b5-5a73-4ca9-a3fd-6e9b508922f0",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"pm.test(\"Create Service Request Response status code is 202\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(202);\r",
							"});\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Create Service Request Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': '0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b'\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"            pm.expect([200, 303]).to.include(res.code);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                 pm.test(`Create Service Request Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(303);\r",
							"                });\r",
							"\r",
							"                const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                    // Extract the part after \"/api/\"\r",
							"                    const href = link.href.replace('/api/', '');\r",
							"\r",
							"                    // Set the link entity to global variables\r",
							"                    acc[link.entity] = href;\r",
							"\r",
							"                    if (href.includes('service_requests/')) {\r",
							"                        const activityId = href.split('/')[5]; // Extract the service requests ID\r",
							"                        acc['jobSericeRequest'] = activityId;\r",
							"                    }\r",
							"\r",
							"                    return acc;\r",
							"                }, {});\r",
							"\r",
							"                // Iterate over the links object and set globals dynamically\r",
							"                Object.entries(links).forEach(([entity, value]) => {\r",
							"                    const globalName = `${entity.charAt(0).toUpperCase() + entity.slice(1)}ID`;\r",
							"                    pm.globals.set(globalName, value);\r",
							"                });\r",
							"\r",
							"\r",
							"                displayResponse('Create Service Request Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Create Service Request Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Create Service Request Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-cf07211b-490c-4ab0-ad19-0084862448e9",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "API-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"signed_data\": \"{{service_request_signed_content}}\"\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/service_requests",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"service_requests"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get service request Details",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "1519bca9-0b2b-4e2e-a770-4da29d8f48ca",
						"exec": [
							"pm.test(\"Get service request Details - PASS. Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "8ee937d6-e2a5-40de-a667-3b296aac8bf6",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-45f6607e-e2fb-43e5-83fa-9504ac1618fc",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					},
					{
						"key": "",
						"value": "",
						"type": "text",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/service_requests/{{JobSericeRequestID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"service_requests",
						"{{JobSericeRequestID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "PreQualify Medication Request Request",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "a1bc1cbe-f824-4e21-9da5-e6eec19a9776",
						"exec": [
							"// Отримуємо encounter_start_date з глобальних змінних\r",
							"const encounterPeriodes = new Date(pm.globals.get('encounter_start_date'));\r",
							"\r",
							"// Створюємо medicationRequestCreatedAt (на день більше за encounter_start_date)\r",
							"const medicationRequestCreatedAt = new Date(encounterPeriodes);\r",
							"medicationRequestCreatedAt.setDate(medicationRequestCreatedAt.getDate());\r",
							"\r",
							"// Створюємо medicationRequestStartedAt (завтра відносно сьогоднішньої дати)\r",
							"const today = new Date();\r",
							"const medicationRequestStartedAt = new Date(today);\r",
							"medicationRequestStartedAt.setDate(medicationRequestStartedAt.getDate() + 1);\r",
							"\r",
							"// Створюємо medicationRequestEndedAt (на 10 днів більше ніж medicationRequestStartedAt)\r",
							"const medicationRequestEndedAt = new Date(medicationRequestStartedAt);\r",
							"medicationRequestEndedAt.setDate(medicationRequestEndedAt.getDate() + 10);\r",
							"\r",
							"// Обрізаємо час, залишаємо тільки YYYY-MM-DD\r",
							"const formatDate = (date) => date.toISOString().split('T')[0];\r",
							"\r",
							"const medicationRequestCreatedAtISO = formatDate(medicationRequestCreatedAt);\r",
							"const medicationRequestStartedAtISO = formatDate(medicationRequestStartedAt);\r",
							"const medicationRequestEndedAtISO = formatDate(medicationRequestEndedAt);\r",
							"\r",
							"// Зберігаємо у глобальні змінні\r",
							"pm.globals.set('medicationRequestCreatedAt', medicationRequestCreatedAtISO);\r",
							"pm.globals.set('medicationRequestStartedAt', medicationRequestStartedAtISO);\r",
							"pm.globals.set('medicationRequestEndedAt', medicationRequestEndedAtISO);\r",
							"\r",
							"console.log(\"Medication Request Created At:\", medicationRequestCreatedAtISO);\r",
							"console.log(\"Medication Request Started At:\", medicationRequestStartedAtISO);\r",
							"console.log(\"Medication Request Ended At:\", medicationRequestEndedAtISO);\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "9f5a08bd-2922-46a4-8d49-83b67ed4530e",
						"exec": [
							"pm.test(\"PreQualify Medication Request Response status code is 200\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"});\r",
							"\r",
							"pm.test(\"PreQualify Medication Request status is VALID\", function () {\r",
							"    const resData = pm.response.json();\r",
							"    console.log(resData.data[0].status)\r",
							"    const status = resData.data[0].status;\r",
							"    pm.expect(status).to.eql(\"VALID\");\r",
							"});\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-53bba19d-466c-4830-8cb2-b36a08723e4e",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"medication_request_request\": {\r\n        \"person_id\": \"{{patient_for_regress}}\",\r\n        \"employee_id\": \"{{user_id}}\",\r\n        \"division_id\": \"{{user_division_id}}\",\r\n        \"created_at\": \"{{medicationRequestCreatedAt}}\",\r\n        \"started_at\": \"{{medicationRequestStartedAt}}\",\r\n        \"ended_at\": \"{{medicationRequestEndedAt}}\",\r\n        \"medication_id\": \"03e31a12-e894-490b-8f22-c5941f5a789f\",\r\n        \"medication_qty\": 30.0,\r\n        \"intent\": \"order\",\r\n        \"category\": \"community\",\r\n        \"context\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"encounter\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{encounter_extracted_id}}\"\r\n            }\r\n        },\r\n        \"dosage_instruction\": [\r\n            {\r\n                \"sequence\": 1,\r\n                \"text\": \"0.25mg PO every 6-12 hours as needed for menses from Jan 15-20, 2015.  Do not exceed more than 4mg per day\",\r\n                \"patient_instruction\": \"0.25mg PO every 6-12 hours as needed for menses from Jan 15-20, 2015.  Do not exceed more than 4mg per day\",\r\n                \"max_dose_per_period\": {\r\n                    \"numerator\": {\r\n                        \"value\": 0,\r\n                        \"unit\": \"mg\",\r\n                        \"system\": \"eHealth/ucum/units\",\r\n                        \"code\": \"mg\"\r\n                    },\r\n                    \"denominator\": {\r\n                        \"value\": 0,\r\n                        \"unit\": \"mg\",\r\n                        \"system\": \"eHealth/ucum/units\",\r\n                        \"code\": \"mg\"\r\n                    }\r\n                },\r\n                \"max_dose_per_administration\": {\r\n                    \"value\": 0,\r\n                    \"unit\": \"mg\",\r\n                    \"system\": \"eHealth/ucum/units\",\r\n                    \"code\": \"mg\"\r\n                }\r\n            }\r\n        ]\r\n    },\r\n    \"programs\": [\r\n        {\r\n            \"id\": \"f01d0d8c-bccb-4bde-a6c6-f4b873a005c2\"\r\n        }\r\n    ]\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/medication_request_requests/prequalify",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"medication_request_requests",
						"prequalify"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Medication Request Request",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "71307cfd-d53d-4474-a2d5-d8530dcb0379",
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Medication Request Request Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"\r",
							"function sendDataToSign(dataToBeSigned) {\r",
							"    const localServerUrl = 'http://localhost:3000/create-medication-request-request-signed-content';\r",
							"\r",
							"    const requestData = {\r",
							"        method: 'POST',\r",
							"        url: localServerUrl,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"        },\r",
							"        body: {\r",
							"            mode: 'raw',\r",
							"            raw: JSON.stringify(dataToBeSigned) // Send the entire response or specific fields\r",
							"        }\r",
							"    };\r",
							"\r",
							"    // Send the request to the local server\r",
							"    pm.sendRequest(requestData, function (err, res) {\r",
							"        if (err) {\r",
							"            console.error('Error sending request to local server:', err);\r",
							"        } else {\r",
							"            console.log('Response from local server:', res.json());\r",
							"            const responseBody = res.json();\r",
							"\r",
							"            pm.test(`Create Medication Request Request content sign success. Response status is 200 ${JSON.stringify(responseBody, null, 2)}`, function () {\r",
							"                pm.expect(res.code).to.eql(200);\r",
							"                pm.expect(responseBody).to.have.property('signed_content');\r",
							"                pm.globals.set('medication_req_req_data_to_sign', responseBody.signed_content)\r",
							"\r",
							"                displayResponse('Signed medication request request data', responseBody);\r",
							"            });\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"\r",
							"\r",
							"pm.test(`Create Medication Request Request Response status code is 201  | RESPONSE - ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(201);\r",
							"\r",
							"    const status = resData.data.status\r",
							"    console.info(status)\r",
							"    pm.test('Medication Request Request status is \"NEW\"', function () {\r",
							"        pm.expect(status).to.eql('NEW');\r",
							"    });\r",
							"\r",
							"\r",
							"    const medicationReqReqId = resData.data.id\r",
							"    pm.globals.set('medication_req_req_id', medicationReqReqId);\r",
							"    console.info(medicationReqReqId);\r",
							"\r",
							"    pm.globals.set('medication_req_req_data_to_sign', resData.data);\r",
							"    console.info(resData.data);\r",
							"    displayResponse('Сформований контент для підпису', resData.data)\r",
							"    sendDataToSign(resData.data);\r",
							"\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "9ad400da-e5f0-41b5-b4ec-b79c8b5734bf",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-0e7a8f20-f42a-4da8-aa3d-d0673e96fd04",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"medication_request_request\": {\r\n       \"person_id\": \"{{patient_for_regress}}\",\r\n        \"employee_id\": \"{{user_id}}\",\r\n        \"division_id\": \"{{user_division_id}}\",\r\n        \"created_at\": \"{{medicationRequestCreatedAt}}\",\r\n        \"started_at\": \"{{medicationRequestStartedAt}}\",\r\n        \"ended_at\": \"{{medicationRequestEndedAt}}\",\r\n        \"medication_id\": \"03e31a12-e894-490b-8f22-c5941f5a789f\",\r\n        \"medication_qty\": 30.0,\r\n        \"medical_program_id\": \"f01d0d8c-bccb-4bde-a6c6-f4b873a005c2\",\r\n        \"intent\": \"order\",\r\n        \"category\": \"community\",\r\n        \"context\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"encounter\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{encounter_extracted_id}}\"\r\n            }\r\n        },\r\n        \"dosage_instruction\": [\r\n            {\r\n                \"sequence\": 1,\r\n                \"text\": \"0.25mg PO every 6-12 hours as needed for menses from Jan 15-20, 2015.  Do not exceed more than 4mg per day\",\r\n                \"patient_instruction\": \"0.25mg PO every 6-12 hours as needed for menses from Jan 15-20, 2015.  Do not exceed more than 4mg per day\",\r\n                \"max_dose_per_period\": {\r\n                    \"numerator\": {\r\n                        \"value\": 0,\r\n                        \"unit\": \"mg\",\r\n                        \"system\": \"eHealth/ucum/units\",\r\n                        \"code\": \"mg\"\r\n                    },\r\n                    \"denominator\": {\r\n                        \"value\": 0,\r\n                        \"unit\": \"mg\",\r\n                        \"system\": \"eHealth/ucum/units\",\r\n                        \"code\": \"mg\"\r\n                    }\r\n                },\r\n                \"max_dose_per_administration\": {\r\n                    \"value\": 0,\r\n                    \"unit\": \"mg\",\r\n                    \"system\": \"eHealth/ucum/units\",\r\n                    \"code\": \"mg\"\r\n                }\r\n            }\r\n        ]\r\n    }\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/medication_request_requests",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"medication_request_requests"
					]
				}
			},
			"response": []
		},
		{
			"name": "Sign Medication Request Request Copy",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "4d4e36c9-bbeb-4dea-bc53-5ab2d2c768c7",
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Sign Medication Request Request Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"\r",
							"\r",
							"pm.test(\"Sign Medication Request Request Response status code is 200\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"\r",
							"    const status = resData.data.status\r",
							"    console.info(status)\r",
							"\r",
							"    pm.test('Medication Request Request status is \"ACTIVE\"', function () {\r",
							"        pm.expect(status).to.eql('ACTIVE');\r",
							"    });\r",
							"\r",
							"    const printForm = resData.data.printout_form;\r",
							"\r",
							"    // Regular expression to match the confirmation code\r",
							"    const codeMatch = printForm.match(/КОД ПІДТВЕРДЖЕННЯ:\\s*(\\d+)/);\r",
							"\r",
							"    if (codeMatch && codeMatch[1]) {\r",
							"        const confirmationCode = codeMatch[1];\r",
							"        console.log(\"КОД ПІДТВЕРДЖЕННЯ:\", confirmationCode);\r",
							"        pm.globals.set('medication_req_confirmation_code', confirmationCode);\r",
							"    } else {\r",
							"        console.log(\"КОД ПІДТВЕРДЖЕННЯ not found.\");\r",
							"    }\r",
							"\r",
							"\r",
							"    pm.globals.set('medication_req_id', resData.data.id);\r",
							"    pm.globals.set('medication_req_request_number', resData.data.request_number);\r",
							"\r",
							"});\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "fd0f2e0d-6863-4ff1-b16e-84ef84dda1c1",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-01db31f1-dd80-40b9-a7b2-f1482017fab4",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"signed_medication_request_request\": \"{{medication_req_req_data_to_sign}}\",\r\n  \"signed_content_encoding\": \"base64\"\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{host}}/api/medication_request_requests/{{medication_req_req_id}}/actions/sign",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"medication_request_requests",
						"{{medication_req_req_id}}",
						"actions",
						"sign"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get medication requests details",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Get medication requests details - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "729ec177-48da-4569-82da-ad4a3f814652"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [],
						"type": "text/javascript",
						"id": "5287c6d5-fd53-4039-bec1-3760276c254a"
					}
				}
			],
			"id": "15381251-f55f87ae-bb62-478b-9a8b-0dbcf222944d",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/persons/{{patient_for_regress}}/medication_requests/{{medication_req_id}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"persons",
						"{{patient_for_regress}}",
						"medication_requests",
						"{{medication_req_id}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Qualify Medication Request by ID",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "64f6ffbc-057a-4676-a874-24acda1d41a9",
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"pm.test(\"Qualify Medication Request Request Response status code is 200\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"});\r",
							"\r",
							"pm.test(\"Qualify Medication Request Request status is VALID\", function () {\r",
							"    const resData = pm.response.json();\r",
							"    console.log(resData.data[0].status)\r",
							"    const status = resData.data[0].status;\r",
							"    pm.expect(status).to.eql(\"VALID\");\r",
							"\r",
							"    pm.test(\"resData.data is an array\", function () {\r",
							"        pm.expect(Array.isArray(resData.data)).to.be.true;\r",
							"        const programId = resData.data[0].program_id;\r",
							"        console.info(programId)\r",
							"        pm.globals.set('program_id_qualify_medication_request', programId);\r",
							"\r",
							"        const medicationId = resData.data[0].participants[1].medication_id;\r",
							"        console.info(resData.data[0].participants[0].medication_id);\r",
							"        pm.globals.set('medication_id_qualify_medication_request', medicationId);\r",
							"\r",
							"        const porgramMedicationId = resData.data[0].participants[1].id;\r",
							"        console.info(resData.data[0].participants[0].id);\r",
							"        pm.globals.set('program_medication_id_qualify_medication_request', porgramMedicationId);\r",
							"    });\r",
							"\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "d7f6ce3a-be05-47b1-bb09-a8f5b1edbdcc",
						"exec": [
							"pm.environment.set(\"original_access_token\", pm.environment.get(\"access_token\"));\r",
							"pm.environment.set(\"original_user_division_id\", pm.environment.get(\"user_division_id\"));\r",
							"\r",
							"const pharmacyToken = \"ZGRHQ3ExdFB5ZFpjdnNKeWxYeHVaQT09\";\r",
							"const pharmacyDivision = \"cbc34ead-00e2-4122-b880-245f204344a3\"\r",
							"\r",
							"pm.environment.set(\"access_token\", pharmacyToken);\r",
							"pm.environment.set(\"user_division_id\", pharmacyDivision);\r",
							"console.log(\"✅ Temporary token set for this request:\", pharmacyToken);"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-65ac57df-6bcf-4c9f-aa28-0682a9fccf5d",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "a2ffb0888561e50d5a868faf56ea5708619b7ecc03b5bd21ff1a50f37a3f430e",
						"type": "text",
						"disabled": true
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"division_id\": \"{{user_division_id}}\",\r\n  \"programs\": [\r\n    {\r\n      \"id\": \"f01d0d8c-bccb-4bde-a6c6-f4b873a005c2\"\r\n    }\r\n  ]\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/medication_requests/{{medication_req_id}}/actions/qualify",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"medication_requests",
						"{{medication_req_id}}",
						"actions",
						"qualify"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Medication Dispense by Pharmacy User",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "89e7f4a6-0b78-4b2f-923c-d7c1b61c1c27",
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"\r",
							"pm.test(\"Create Medication Dispense Response status code is 201\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(201);\r",
							"\r",
							"    pm.globals.set('medication_dispense_id', resData.data.id)\r",
							"\r",
							"});\r",
							"\r",
							"\r",
							"\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "7e368b11-d97a-4936-90fa-66e318ba46cc",
						"exec": [
							"// Отримуємо поточну дату\r",
							"const now = new Date();\r",
							"\r",
							"// Форматуємо у вигляді YYYY-MM-DD\r",
							"const formattedDate = now.toISOString().split('T')[0];\r",
							"\r",
							"// Записуємо у глобальну змінну Postman\r",
							"pm.globals.set(\"dispensed_at\", formattedDate);\r",
							"\r",
							"// Для зручності виведемо в консоль\r",
							"console.log(\"Global variable 'dispensed_at' set to:\", formattedDate);\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-18ac00ab-0fd1-4e91-923c-73ac9f7304c2",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "a2ffb0888561e50d5a868faf56ea5708619b7ecc03b5bd21ff1a50f37a3f430e",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"medication_dispense\": {\r\n        \"medication_request_id\": \"{{medication_req_id}}\",\r\n        \"dispensed_at\": \"2025-03-03\",\r\n        \"dispensed_by\": \"Іванов Іван Іванович\",\r\n        \"division_id\": \"{{user_division_id}}\",\r\n        \"medical_program_id\": \"{{program_id_qualify_medication_request}}\",\r\n        \"dispense_details\": [\r\n            {\r\n                \"program_medication_id\": \"{{program_medication_id_qualify_medication_request}}\",\r\n                \"medication_id\": \"{{medication_id_qualify_medication_request}}\",\r\n                \"medication_qty\": 30.0,\r\n                \"sell_price\": 10.00,\r\n                \"sell_amount\": 0.5,\r\n                \"discount_amount\": 0\r\n            }\r\n        ]\r\n    }\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/pharmacy/medication_dispenses?code={{medication_req_confirmation_code}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"pharmacy",
						"medication_dispenses"
					],
					"query": [
						{
							"key": "code",
							"value": "{{medication_req_confirmation_code}}"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Medication dispense details by Pharmacy User",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "aec3ae9c-7308-4f8c-ad50-53c80d9dbc62",
						"exec": [
							"// Парсимо JSON-відповідь\r",
							"const res = pm.response.json();\r",
							"\r",
							"// Перевіряємо, чи є поле data\r",
							"if (res && res.data) {\r",
							"    const updatedData = { ...res.data };\r",
							"\r",
							"    // Замінюємо payment_amount на 2\r",
							"    updatedData.payment_amount = 2;\r",
							"\r",
							"    // Зберігаємо в глобальну змінну\r",
							"    pm.globals.set(\"updated_dispense_data\", JSON.stringify(updatedData));\r",
							"\r",
							"    // Виводимо у вкладку Visualize у форматі JSON\r",
							"    const template = `\r",
							"        <h3>💊 Updated Dispense Data</h3>\r",
							"        <pre>{{json this}}</pre>\r",
							"    `;\r",
							"    // pm.visualizer.set(template, updatedData);\r",
							"\r",
							"    pm.visualizer.set(`\r",
							"  <style>\r",
							"    pre {\r",
							"      background-color: #f6f8fa;\r",
							"      padding: 16px;\r",
							"      border-radius: 5px;\r",
							"      font-family: monospace;\r",
							"      white-space: pre-wrap;\r",
							"      max-height: 500px;\r",
							"      overflow: auto;\r",
							"    }\r",
							"    button {\r",
							"      margin-bottom: 10px;\r",
							"      padding: 5px 10px;\r",
							"      border-radius: 4px;\r",
							"      border: 1px solid #ccc;\r",
							"      background-color: #e0e0e0;\r",
							"      cursor: pointer;\r",
							"    }\r",
							"    button:hover {\r",
							"      background-color: #d0d0d0;\r",
							"    }\r",
							"  </style>\r",
							"  <h3>Згенерований JSON підписний контент для погашення рецепту</h3>\r",
							"  <button onclick=\"copyToClipboard()\">Скопіювати JSON</button>\r",
							"  <pre id=\"jsonOutput\">{{json}}</pre>\r",
							"  <script>\r",
							"    function copyToClipboard() {\r",
							"      const text = document.getElementById('jsonOutput').innerText;\r",
							"      const textArea = document.createElement('textarea');\r",
							"      textArea.value = text;\r",
							"      document.body.appendChild(textArea);\r",
							"      textArea.select();\r",
							"      try {\r",
							"        document.execCommand('copy');\r",
							"        alert('JSON скопійовано!');\r",
							"      } catch (err) {\r",
							"        alert('Помилка копіювання: ' + err);\r",
							"      }\r",
							"      document.body.removeChild(textArea);\r",
							"    }\r",
							"  </script>\r",
							"`, {\r",
							"        json: JSON.stringify(updatedData, null, 2)\r",
							"    });\r",
							"\r",
							"} else {\r",
							"    pm.visualizer.set(`<b style=\"color:red;\">❌ Response does not contain 'data' field</b>`);\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-fee0fe3d-6dd0-4f21-bbec-a6cb52609ad9",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "a2ffb0888561e50d5a868faf56ea5708619b7ecc03b5bd21ff1a50f37a3f430e",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/pharmacy/medication_dispenses/{{medication_dispense_id}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"pharmacy",
						"medication_dispenses",
						"{{medication_dispense_id}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Process Medication Dispense by Pharmacy User",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "5c5d1b63-2420-4069-88f0-4e63fa7143ef",
						"exec": [
							"// Отримуємо ContentForSign із глобальних змінних\r",
							"const contentForSign = pm.globals.get('updated_dispense_data');\r",
							"\r",
							"if (!contentForSign) {\r",
							"    console.error(\"Error: ContentForSign is not set in global variables.\");\r",
							"} else {\r",
							"    // Функція для надсилання контенту на підпис\r",
							"    function sendDataToSign(contentForSign) {\r",
							"        const localServerUrl = 'http://localhost:3000/process-medication-dispene-signed-content';\r",
							"\r",
							"        const requestData = {\r",
							"            method: 'POST',\r",
							"            url: localServerUrl,\r",
							"            header: {\r",
							"                'Content-Type': 'application/json',\r",
							"            },\r",
							"            body: {\r",
							"                mode: 'raw',\r",
							"                raw: contentForSign // Використовуємо JSON-рядок із глобальних змінних\r",
							"            }\r",
							"        };\r",
							"\r",
							"        // Відправляємо запит на локальний сервер\r",
							"        pm.sendRequest(requestData, function (err, res) {\r",
							"            if (err) {\r",
							"                console.error('Error sending request to local server:', err);\r",
							"            } else {\r",
							"                console.log('Response from local server:', res.json());\r",
							"                const responseBody = res.json();\r",
							"\r",
							"                pm.test(`Process Medication Dispense. Response status is 200 ${JSON.stringify(responseBody, null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(200);\r",
							"                    pm.expect(responseBody).to.have.property('signed_content');\r",
							"\r",
							"                    // Зберігаємо підписаний контент у глобальні змінні\r",
							"                    pm.globals.set('process_medication_dispense_signed_content', responseBody.signed_content);\r",
							"                });\r",
							"            }\r",
							"        });\r",
							"    }\r",
							"\r",
							"    // Викликаємо функцію з отриманими даними\r",
							"    sendDataToSign(contentForSign);\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "3858096d-543c-42b3-8c6b-ddde5e2c0e97",
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"\r",
							"pm.test(\"Process Medication Dispense - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"\r",
							"    const resId = resData.data?.id;\r",
							"    console.log(resId)\r",
							"    // pm.globals.set('creatCompositionJobId', resId)\r",
							"\r",
							"});\r",
							"\r",
							"// Відновлюємо попередні значення після запиту\r",
							"const originalToken = pm.environment.get(\"original_access_token\");\r",
							"const originalDivision = pm.environment.get(\"original_user_division_id\");\r",
							"\r",
							"if (originalToken) {\r",
							"    pm.environment.set(\"access_token\", originalToken);\r",
							"    pm.environment.unset(\"original_access_token\");\r",
							"}\r",
							"\r",
							"if (originalDivision) {\r",
							"    pm.environment.set(\"user_division_id\", originalDivision);\r",
							"    pm.environment.unset(\"original_user_division_id\");\r",
							"}\r",
							"\r",
							"console.log(\"🔁 Environment restored to original user.\");"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-455b084e-5497-4b74-a89c-45fbc18b4483",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "a2ffb0888561e50d5a868faf56ea5708619b7ecc03b5bd21ff1a50f37a3f430e",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"signed_medication_dispense\": \"{{process_medication_dispense_signed_content}}\",\r\n  \"signed_content_encoding\": \"base64\"\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/pharmacy/medication_dispenses/{{medication_dispense_id}}/actions/process",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"pharmacy",
						"medication_dispenses",
						"{{medication_dispense_id}}",
						"actions",
						"process"
					]
				}
			},
			"response": []
		},
		{
			"name": "PreQualify Device request",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "33cd1485-07c2-4a20-8973-0a0f44954ddd",
						"exec": [
							"// Retrieve the URL from the global variable\r",
							"const url = pm.globals.get('jobEncounterID');\r",
							"\r",
							"\r",
							"// Check if the URL is defined and contains the expected format\r",
							"if (url && url.includes('encounters/')) {\r",
							"    // Extract the ID after 'encounters/'\r",
							"    const parts = url.split('encounters/');\r",
							"    if (parts.length > 1) {\r",
							"        const jobEncounterID = parts[1];\r",
							"        \r",
							"        // Log the extracted ID to the console (for debugging purposes)\r",
							"        console.log('Extracted jobEncounterID:', jobEncounterID);\r",
							"        \r",
							"        // Optionally, set the extracted ID as an environment variable\r",
							"        pm.globals.set('encounter_extracted_id', jobEncounterID);\r",
							"    } else {\r",
							"        console.error('The URL does not contain the expected format.');\r",
							"    }\r",
							"} else {\r",
							"    console.error('The global variable jobEncounterID is not defined or does not contain the expected format.');\r",
							"}\r",
							"\r",
							"\r",
							"// Отримуємо encounter_start_date з глобальних змінних\r",
							"const encounterPeriodes = new Date(pm.globals.get('encounter_start_date'));\r",
							"\r",
							"// Обчислюємо deviceRequestStartedAt (на день більше за encounter_start_date)\r",
							"const deviceRequestStartedAt = new Date(encounterPeriodes);\r",
							"deviceRequestStartedAt.setDate(deviceRequestStartedAt.getDate() + 1);\r",
							"\r",
							"// Обчислюємо deviceRequestEndAt (на 5 днів більше ніж deviceRequestStartedAt)\r",
							"const deviceRequestEndAt = new Date(deviceRequestStartedAt);\r",
							"deviceRequestEndAt.setDate(deviceRequestEndAt.getDate() + 5);\r",
							"\r",
							"// Обчислюємо deviceRequestAuthoredOn (вчора відносно сьогоднішньої дати)\r",
							"const today = new Date();\r",
							"const deviceRequestAuthoredOn = new Date(today);\r",
							"deviceRequestAuthoredOn.setDate(deviceRequestAuthoredOn.getDate() - 1);\r",
							"\r",
							"// Функція для форматування дати у форматі ISO 8601 (з T00:00:00.000Z)\r",
							"const formatISODate = (date) => date.toISOString();\r",
							"\r",
							"// Зберігаємо у глобальні змінні\r",
							"pm.globals.set('deviceRequestStartedAt', formatISODate(deviceRequestStartedAt));\r",
							"pm.globals.set('deviceRequestEndAt', formatISODate(deviceRequestEndAt));\r",
							"pm.globals.set('deviceRequestAuthoredOn', formatISODate(deviceRequestAuthoredOn));\r",
							"\r",
							"console.log(\"Device Request Started At:\", formatISODate(deviceRequestStartedAt));\r",
							"console.log(\"Device Request End At:\", formatISODate(deviceRequestEndAt));\r",
							"console.log(\"Device Request Authored On:\", formatISODate(deviceRequestAuthoredOn));\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "b70ba999-b29f-461f-a8ba-eac42c5b2da4",
						"exec": [
							"pm.test(\"PreQualify Device request Response status code is 200\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"});\r",
							"\r",
							"pm.test(\"PreQualify Device request status is VALID\", function () {\r",
							"    const resData = pm.response.json();\r",
							"    console.log(resData.data[0].status)\r",
							"    const status = resData.data[0].status;\r",
							"    pm.expect(status).to.eql(\"VALID\");\r",
							"});\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-c8318a99-1999-4e07-b649-4b8df84f4b00",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"device_request\": {\r\n    \"intent\": \"order\",\r\n    \"quantity\": {\r\n      \"value\": 50,\r\n      \"system\": \"device_unit\",\r\n      \"code\": \"piece\"\r\n    },\r\n    \"code\": {\r\n      \"coding\": [\r\n        {\r\n          \"system\": \"device_definition_classification_type\",\r\n          \"code\": \"53307\"\r\n        }\r\n      ]\r\n    },\r\n    \"encounter\": {\r\n      \"identifier\": {\r\n        \"type\": {\r\n          \"coding\": [\r\n            {\r\n              \"system\": \"eHealth/resources\",\r\n              \"code\": \"encounter\"\r\n            }\r\n          ]\r\n        },\r\n        \"value\": \"{{encounter_extracted_id}}\"\r\n      }\r\n    },\r\n    \"requester\": {\r\n      \"identifier\": {\r\n        \"type\": {\r\n          \"coding\": [\r\n            {\r\n              \"system\": \"eHealth/resources\",\r\n              \"code\": \"employee\"\r\n            }\r\n          ]\r\n        },\r\n        \"value\": \"{{user_id}}\"\r\n      }\r\n    },\r\n    \"authored_on\": \"{{deviceRequestAuthoredOn}}\",\r\n    \"occurrence_period\": {\r\n      \"start\": \"{{deviceRequestStartedAt}}\",\r\n      \"end\": \"{{deviceRequestEndAt}}\"\r\n    },\r\n    \"performer\": {\r\n      \"identifier\": {\r\n        \"type\": {\r\n          \"coding\": [\r\n            {\r\n              \"system\": \"eHealth/resources\",\r\n              \"code\": \"legal_entity\"\r\n            }\r\n          ]\r\n        },\r\n        \"value\": \"{{user_legal_entity}}\"\r\n      }\r\n    }\r\n  },\r\n  \"programs\": [\r\n    {\r\n      \"identifier\": {\r\n        \"type\": {\r\n          \"coding\": [\r\n            {\r\n              \"system\": \"eHealth/resources\",\r\n              \"code\": \"medical_program\"\r\n            }\r\n          ]\r\n        },\r\n        \"value\": \"0e26d6ca-b6c2-49d6-8d16-ca9635ea59ad\"\r\n      }\r\n    }\r\n  ]\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/device_requests/prequalify",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"device_requests",
						"prequalify"
					]
				}
			},
			"response": []
		},
		{
			"name": "Dummy Device request",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "019a60f4-6832-4a10-b438-7c3622a059df",
						"exec": [
							"const uuid = require('uuid');\r",
							"const serviceRequestId = uuid.v4();\r",
							"\r",
							"pm.globals.set(\"dummy_device_request_id\", serviceRequestId);"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "c596aab1-8696-4d90-b877-4a5d98ca288e",
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"pm.test(`Device Request content sign success. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    pm.expect(resData).to.have.property('signed_content');\r",
							"    pm.globals.set('device_request_signed_content', resData.signed_content);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-31ad9995-6dfd-4881-9aa4-41ca52fd3e5d",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"id\": \"{{dummy_device_request_id}}\",\r\n    \"intent\": \"order\",\r\n    \"quantity\": {\r\n        \"value\": 30,\r\n        \"system\": \"device_unit\",\r\n        \"code\": \"piece\"\r\n    },\r\n    \"code\": {\r\n        \"coding\": [\r\n            {\r\n                \"system\": \"device_definition_classification_type\",\r\n                \"code\": \"53307\"\r\n            }\r\n        ]\r\n    },\r\n    \"encounter\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"encounter\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{encounter_extracted_id}}\"\r\n        }\r\n    },\r\n    \"requester\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"employee\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_id}}\"\r\n        }\r\n    },\r\n    \"authored_on\": \"{{deviceRequestAuthoredOn}}\",\r\n    \"occurrence_period\": {\r\n        \"start\": \"{{deviceRequestStartedAt}}\",\r\n        \"end\": \"{{deviceRequestEndAt}}\"\r\n    },\r\n    \"performer\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"legal_entity\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_legal_entity}}\"\r\n        }\r\n    },\r\n    \"note\": \"Some notes\",\r\n    \"program\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"medical_program\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"0cefbce3-6dd2-45bd-b1e6-983fc055d5e0\"\r\n        }\r\n    },\r\n    \"status\": \"active\"\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "http://localhost:3000/create-device-signed-content",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "3000",
					"path": [
						"create-device-signed-content"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Device request",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "005dbf15-a485-4735-9f0c-83dbef15fb5a",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"pm.test(\"Create Device Request Response status code is 202\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(202);\r",
							"});\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Create Device Request Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': '0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b'\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"            pm.expect([200, 303]).to.include(res.code);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                pm.test(`Create Device Request Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(303);\r",
							"                });\r",
							"\r",
							"                const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                    // Видаляємо '/api/' з початку href\r",
							"                    const href = link.href.replace('/api/', '');\r",
							"\r",
							"                    // Додаємо оброблений href у глобальні змінні\r",
							"                    acc[link.entity] = href;\r",
							"\r",
							"                    // Якщо href містить \"device_requests/\", витягуємо ID\r",
							"                    if (href.includes('device_requests/')) {\r",
							"                        const activityId = href.split('/').pop(); // Беремо останній елемент після розділення \"/\"\r",
							"                        acc['jobDeviceRequest'] = activityId;\r",
							"                    }\r",
							"\r",
							"                    return acc;\r",
							"                }, {});\r",
							"                // Iterate over the links object and set globals dynamically\r",
							"                Object.entries(links).forEach(([entity, value]) => {\r",
							"                    const globalName = `${entity.charAt(0).toUpperCase() + entity.slice(1)}ID`;\r",
							"                    pm.globals.set(globalName, value);\r",
							"                });\r",
							"\r",
							"\r",
							"                displayResponse('Create Device Request Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Create Device Request Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Create Device Request Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "a957924f-68c2-4faf-8973-c90719c6617a",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-cc8b2b71-0224-49c3-89cb-17af3deebac3",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"signed_data\": \"{{device_request_signed_content}}\"\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/device_requests",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"device_requests"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Device Request details",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Get Device Request details - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "d85f6826-9341-4ef8-bc14-bba91911a9d7"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [],
						"type": "text/javascript",
						"id": "821f65b1-9f1e-4253-a910-223a3488ff06"
					}
				}
			],
			"id": "15381251-393a8cab-d710-4ebd-ace1-0cac53d1901d",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/device_requests/{{JobDeviceRequestID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"device_requests",
						"{{JobDeviceRequestID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Dummy Submit Diagnostic Report Package",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const uuid = require('uuid');\r",
							"const diagnosticReportId = uuid.v4();\r",
							"\r",
							"pm.globals.set(\"diagnostic_report_id\", diagnosticReportId);\r",
							"\r",
							"\r",
							"// Отримуємо поточну дату\r",
							"const today = new Date();\r",
							"\r",
							"// Обчислюємо diagnosticReportStart (сьогодні - 12 днів)\r",
							"const diagnosticReportStart = new Date(today);\r",
							"diagnosticReportStart.setDate(diagnosticReportStart.getDate() - 12);\r",
							"\r",
							"// Обчислюємо diagnosticReportEnd (сьогодні - 3 дні)\r",
							"const diagnosticReportEnd = new Date(today);\r",
							"diagnosticReportEnd.setDate(diagnosticReportEnd.getDate() - 3);\r",
							"\r",
							"// Обчислюємо diagnosticReportIssued (diagnosticReportEnd + 1 день)\r",
							"const diagnosticReportIssued = new Date(diagnosticReportEnd);\r",
							"diagnosticReportIssued.setDate(diagnosticReportIssued.getDate() + 1);\r",
							"\r",
							"// Функція для форматування дати у форматі ISO 8601 (з T00:00:00.000Z)\r",
							"const formatISODate = (date) => date.toISOString();\r",
							"\r",
							"// Зберігаємо у глобальні змінні\r",
							"pm.globals.set('diagnosticReportStart', formatISODate(diagnosticReportStart));\r",
							"pm.globals.set('diagnosticReportEnd', formatISODate(diagnosticReportEnd));\r",
							"pm.globals.set('diagnosticReportIssued', formatISODate(diagnosticReportIssued));\r",
							"\r",
							"// Виводимо у консоль для перевірки\r",
							"console.log(\"Diagnostic Report Start:\", formatISODate(diagnosticReportStart));\r",
							"console.log(\"Diagnostic Report End:\", formatISODate(diagnosticReportEnd));\r",
							"console.log(\"Diagnostic Report Issued:\", formatISODate(diagnosticReportIssued));\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"id": "159129a8-3f26-41f0-be96-74e12dc46d08"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const resData = pm.response.json();\r",
							"console.log('create diagnostic report sign content', resData)\r",
							"\r",
							"pm.test(`Diagnostic report content sign success. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    pm.expect(resData).to.have.property('signed_content');\r",
							"    pm.globals.set('diagnostic_report_signed_content', resData.signed_content);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "b027b92e-5f3e-44ec-b12e-b301639d2954"
					}
				}
			],
			"id": "15381251-9ddd0dbf-2f6a-4fc6-853f-e741a0ded71e",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"diagnostic_report\": {\r\n    \"id\": \"{{diagnostic_report_id}}\",\r\n    \"status\": \"final\",\r\n    \"code\": {\r\n      \"identifier\": {\r\n        \"type\": {\r\n          \"coding\": [\r\n            {\r\n              \"system\": \"eHealth/resources\",\r\n              \"code\": \"service\"\r\n            }\r\n          ]\r\n        },\r\n        \"value\": \"351ba946-f6a5-4630-8ec3-07739d142c47\"\r\n      }\r\n    },\r\n    \"category\": [\r\n      {\r\n        \"coding\": [\r\n          {\r\n            \"system\": \"eHealth/diagnostic_report_categories\",\r\n            \"code\": \"laboratory_procedure\"\r\n          }\r\n        ]\r\n      }\r\n    ],\r\n    \"effective_period\": {\r\n      \"start\": \"{{diagnosticReportStart}}\",\r\n      \"end\": \"{{diagnosticReportEnd}}\"\r\n    },\r\n    \"issued\": \"{{diagnosticReportIssued}}\",\r\n    \"conclusion\": \"At risk of osteoporotic fracture\",\r\n    \"recorded_by\": {\r\n      \"identifier\": {\r\n        \"type\": {\r\n          \"coding\": [\r\n            {\r\n              \"system\": \"eHealth/resources\",\r\n              \"code\": \"employee\"\r\n            }\r\n          ]\r\n        },\r\n        \"value\": \"{{user_id}}\"\r\n      }\r\n    },\r\n    \"primary_source\": true,\r\n    \"performer\": {\r\n      \"reference\": {\r\n        \"identifier\": {\r\n          \"type\": {\r\n            \"coding\": [\r\n              {\r\n                \"system\": \"eHealth/resources\",\r\n                \"code\": \"employee\"\r\n              }\r\n            ]\r\n          },\r\n          \"value\": \"{{user_id}}\"\r\n        }\r\n      }\r\n    },\r\n    \"managing_organization\": {\r\n      \"identifier\": {\r\n        \"type\": {\r\n          \"coding\": [\r\n            {\r\n              \"system\": \"eHealth/resources\",\r\n              \"code\": \"legal_entity\"\r\n            }\r\n          ]\r\n        },\r\n        \"value\": \"{{user_legal_entity}}\"\r\n      }\r\n    },\r\n    \"division\": {\r\n      \"identifier\": {\r\n        \"type\": {\r\n          \"coding\": [\r\n            {\r\n              \"system\": \"eHealth/resources\",\r\n              \"code\": \"division\"\r\n            }\r\n          ]\r\n        },\r\n        \"value\": \"{{user_division_id}}\"\r\n      }\r\n    },\r\n    \"results_interpreter\": {\r\n      \"reference\": {\r\n        \"identifier\": {\r\n          \"type\": {\r\n            \"coding\": [\r\n              {\r\n                \"system\": \"eHealth/resources\",\r\n                \"code\": \"employee\"\r\n              }\r\n            ]\r\n          },\r\n          \"value\": \"{{user_id}}\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "http://localhost:3000/diagnostic-report-signed-content",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "3000",
					"path": [
						"diagnostic-report-signed-content"
					]
				}
			},
			"response": []
		},
		{
			"name": "Submit Diagnostic Report Package Copy",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "2d3a6fd2-2ad4-4091-98bb-c1c331c6750c",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Diagnostic Report Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': '0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b'\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"            pm.expect([200, 303]).to.include(res.code);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                pm.test(`Diagnostic Report Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(303);\r",
							"                });\r",
							"\r",
							"                // const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                //     const href = link.href.replace('/api/', ''); // Видаляємо /api/\r",
							"\r",
							"                //     acc[link.entity] = href;\r",
							"\r",
							"                //     if (href.includes('diagnostic_reports/')) {\r",
							"                //         const drId = href.split('/').pop(); // Отримуємо останню частину URL (це і є ID)\r",
							"                //         acc['jobDiagnosticReport'] = drId;\r",
							"                //     }\r",
							"\r",
							"                //     return acc;\r",
							"                // }, {});\r",
							"\r",
							"                // // Записуємо всі значення у глобальні змінні\r",
							"                // Object.entries(links).forEach(([entity, value]) => {\r",
							"                //     const globalName = `${entity.charAt(0).toUpperCase() + entity.slice(1)}ID`;\r",
							"                //     pm.globals.set(globalName, value);\r",
							"                // });\r",
							"\r",
							"                // ------------\r",
							"\r",
							"                const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                    // Extract the part after \"/api/\"\r",
							"                    const href = link.href.replace('/api/', '');\r",
							"\r",
							"                    // Set the link entity to global variables\r",
							"                    acc[link.entity] = href;\r",
							"\r",
							"                    if (href.includes('diagnostic_reports/')) {\r",
							"                        const drId = href.split('/')[3]; // Extract the service requests ID\r",
							"                        acc['jobDiagnosticReport'] = drId;\r",
							"                    }\r",
							"\r",
							"                    return acc;\r",
							"                }, {});\r",
							"\r",
							"                // Iterate over the links object and set globals dynamically\r",
							"                Object.entries(links).forEach(([entity, value]) => {\r",
							"                    const globalName = `${entity.charAt(0).toUpperCase() + entity.slice(1)}ID`;\r",
							"                    pm.globals.set(globalName, value);\r",
							"                });\r",
							"\r",
							"                displayResponse('Diagnostic Report Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Diagnostic Report Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Diagnostic Report Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "1cec282f-3c97-4924-b4f8-61425aabace3",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-ef1f18dd-d098-4b0a-a4a5-7890b12b26f6",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"signed_data\": \"{{diagnostic_report_signed_content}}\"\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/diagnostic_report_package",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"diagnostic_report_package"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Diagnostic Report by id",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Get Diagnostic Report by id - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "e36f85b9-ff3a-4a64-854a-e04ad13b79da"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [],
						"type": "text/javascript",
						"id": "cc4b2768-2279-4989-bf98-8426547ce9d6"
					}
				}
			],
			"id": "15381251-24115844-7462-4c40-8e66-4908b3152d3e",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/diagnostic_reports/{{JobDiagnosticReportID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"diagnostic_reports",
						"{{JobDiagnosticReportID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Diagnostic Report by search params",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "1855275f-d1cf-437f-85bb-1e029306c8c7",
						"exec": [
							"pm.test(\"Get Diagnostic Report by search params - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "f5cc28ef-2fa3-4117-a90b-28594e4b56bb",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-a5eef01c-a3ff-4a0e-b44b-df71429e5f6f",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/diagnostic_reports/?code=351ba946-f6a5-4630-8ec3-07739d142c47",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"diagnostic_reports",
						""
					],
					"query": [
						{
							"key": "page",
							"value": "2",
							"disabled": true
						},
						{
							"key": "page_size",
							"value": "50",
							"disabled": true
						},
						{
							"key": "code",
							"value": "351ba946-f6a5-4630-8ec3-07739d142c47"
						},
						{
							"key": "encounter_id",
							"value": "09dc3ed7-2169-45d8-8fa3-d918c6839bf9",
							"disabled": true
						},
						{
							"key": "context_episode_id",
							"value": "{{jobEpisodeID}}",
							"disabled": true
						},
						{
							"key": "issued_from",
							"value": "1990-01-01",
							"disabled": true
						},
						{
							"key": "issued_to",
							"value": "2000-01-02",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Dummy create procedure",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const uuid = require('uuid');\r",
							"const procedureId = uuid.v4();\r",
							"\r",
							"pm.globals.set(\"procedure_id\", procedureId);\r",
							"\r",
							"\r",
							"\r",
							"// Отримуємо поточну дату\r",
							"const today = new Date();\r",
							"\r",
							"// Обчислюємо procedureStart (сьогодні - 10 днів)\r",
							"const procedureStart = new Date(today);\r",
							"procedureStart.setDate(procedureStart.getDate() - 10);\r",
							"\r",
							"// Обчислюємо procedureEnd (сьогодні - 1 день)\r",
							"const procedureEnd = new Date(today);\r",
							"procedureEnd.setDate(procedureEnd.getDate() - 1);\r",
							"\r",
							"// Функція для форматування дати у форматі ISO 8601 (з T00:00:00.000Z)\r",
							"const formatISODate = (date) => date.toISOString();\r",
							"\r",
							"// Зберігаємо у глобальні змінні\r",
							"pm.globals.set('procedureStart', formatISODate(procedureStart));\r",
							"pm.globals.set('procedureEnd', formatISODate(procedureEnd));\r",
							"\r",
							"// Виводимо у консоль для перевірки\r",
							"console.log(\"Procedure Start:\", formatISODate(procedureStart));\r",
							"console.log(\"Procedure End:\", formatISODate(procedureEnd));\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"id": "9cb77786-5b68-4ed6-971e-f14850fb1eea"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"const resData = pm.response.json();\r",
							"console.log('create procedure sign content', resData)\r",
							"\r",
							"pm.test(`Procedure content sign success. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    pm.expect(resData).to.have.property('signed_content');\r",
							"    pm.globals.set('procedure_signed_content', resData.signed_content);\r",
							"});\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"id": "2311869d-6269-46b8-b37d-a86de4ed311c"
					}
				}
			],
			"id": "15381251-dfb6fdc2-818e-4c0b-aca1-ef75b4d0bb11",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"id\": \"{{procedure_id}}\",\r\n    \"status\": \"completed\",\r\n    \"based_on\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"service_request\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{JobSericeRequestID}}\"\r\n        }\r\n    },\r\n    \"code\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"service\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"40b2dfdf-7623-4fa5-bbfb-58a6b651ff0c\"\r\n        }\r\n    },\r\n    \"performed_period\": {\r\n        \"start\": \"{{procedureStart}}\",\r\n        \"end\": \"{{procedureEnd}}\"\r\n    },\r\n    \"recorded_by\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"employee\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_id}}\"\r\n        }\r\n    },\r\n    \"primary_source\": true,\r\n    \"performer\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"employee\"\r\n                    }\r\n                ],\r\n                \"text\": \"Галина Олександрівна\"\r\n            },\r\n            \"value\": \"{{user_id}}\"\r\n        }\r\n    },\r\n    \"division\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"division\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_division_id}}\"\r\n        }\r\n    },\r\n    \"managing_organization\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"legal_entity\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{user_legal_entity}}\"\r\n        }\r\n    },\r\n    \"category\": {\r\n        \"coding\": [\r\n            {\r\n                \"system\": \"eHealth/procedure_categories\",\r\n                \"code\": \"procedure\"\r\n            }\r\n        ]\r\n    }\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "http://localhost:3000/procedure-signed-content",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "3000",
					"path": [
						"procedure-signed-content"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create procedure",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "00ad422e-aee8-413d-8692-9e6ff3acd877",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"pm.test(\"Create Procedures Response status code is 202\", function () {\r",
							"    pm.expect(pm.response.code).to.eql(202);\r",
							"});\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Create Procedures Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': '0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b'\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"            pm.expect([200, 303]).to.include(res.code);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                 pm.test(`Create Procedures Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(303);\r",
							"                });\r",
							"\r",
							"                const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                    // Extract the part after \"/api/\"\r",
							"                    const href = link.href.replace('/api/', '');\r",
							"\r",
							"                    // Set the link entity to global variables\r",
							"                    acc[link.entity] = href;\r",
							"\r",
							"                    if (href.includes('procedures/')) {\r",
							"                        console.log('dsasdasdasdasssadasdds',href, acc[link.entity] )\r",
							"                        const procedureId = href.split('/')[3]; // Extract the Proceduress ID\r",
							"                        acc['createProcedure'] = procedureId;\r",
							"                    }\r",
							"\r",
							"                    return acc;\r",
							"                }, {});\r",
							"\r",
							"                // Iterate over the links object and set globals dynamically\r",
							"                Object.entries(links).forEach(([entity, value]) => {\r",
							"                    const globalName = `${entity.charAt(0).toUpperCase() + entity.slice(1)}ID`;\r",
							"                    pm.globals.set(globalName, value);\r",
							"                });\r",
							"\r",
							"\r",
							"                displayResponse('Create Procedures Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Create Procedures Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Create Procedures Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "ab7febc8-eaae-4d63-9800-59d3b8b1a80b",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-e046bed0-574c-4876-80ed-39724c5bd63b",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"signed_data\": \"{{procedure_signed_content}}\"\r\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/procedures",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"procedures"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Procedures by ID",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "34e48d90-4be8-4af8-be4e-dff6b6809d7b",
						"exec": [
							"pm.test(\"Get Procedures by ID - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "b248c0ae-6150-407c-a6c8-7e3aaecdfb9f",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-4ea4c39c-cc6f-412b-af40-d60f150cbda6",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/procedures/{{CreateProcedureID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"procedures",
						"{{CreateProcedureID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Procedures by search params",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "77c33c7e-897e-420b-a58c-7e6370c5b36a",
						"exec": [
							"pm.test(\"Get Procedures by search params - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "838f252e-441c-439d-83cd-66218a713c29",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-9ca3f01f-c8fc-4b82-8b0d-f2a3c126d40c",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/procedures?managing_organization_id={{user_legal_entity}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"procedures"
					],
					"query": [
						{
							"key": "episode_id",
							"value": "ef30f210-5328-4f48-bfe6-c7150d4737a6",
							"disabled": true
						},
						{
							"key": "status",
							"value": "completed",
							"disabled": true
						},
						{
							"key": "based_on",
							"value": "ef30f210-5328-4f48-bfe6-c7150d4737a6",
							"disabled": true
						},
						{
							"key": "code",
							"value": "9075e0e2-6b57-47fd-aff7-324806efa7e6",
							"disabled": true
						},
						{
							"key": "managing_organization_id",
							"value": "{{user_legal_entity}}"
						},
						{
							"key": "encounter_id",
							"value": "7075e0e2-6b57-47fd-aff7-324806efa7e5",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Dummy Encounter data package",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "779e919d-1e49-4bfb-9100-be0d9983a12b",
						"exec": [
							"const resData = pm.response.json();\r",
							"console.log('create encounter sign content', resData)\r",
							"\r",
							"pm.test(`Encounter content sign success. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    pm.expect(resData).to.have.property('signed_content');\r",
							"    pm.globals.set('encounter_signed_content', resData.signed_content);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "8b7ffef4-6d68-4728-be2e-7d010aa70119",
						"exec": [
							"const uuid = require('uuid');\r",
							"const encounterId = uuid.v4();\r",
							"const visitId = uuid.v4();\r",
							"pm.globals.set(\"encounter_dummy_id\", encounterId);\r",
							"pm.globals.set(\"visit_id\", visitId);\r",
							"\r",
							"const episodeStartDate = pm.globals.get('episode_start_date');\r",
							"const encounterDate = new Date(episodeStartDate);\r",
							"\r",
							"console.log(encounterDate)\r",
							"// Додаємо 1 день\r",
							"encounterDate.setDate(encounterDate.getDate() + 1);\r",
							"\r",
							"// Перетворюємо назад у формат ISO 8601\r",
							"const encounterDateISO = encounterDate.toISOString();\r",
							"\r",
							"// Зберігаємо оновлену дату в глобальні змінні\r",
							"pm.globals.set('encounter_start_date', encounterDateISO);\r",
							"\r",
							"console.log(\"Encounter Start Date:\", encounterDateISO);\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-322ed832-6dbe-435f-8a8e-a9f3f27c202d",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"encounter\": {\r\n        \"id\": \"{{encounter_dummy_id}}\",\r\n        \"status\": \"finished\",\r\n        \"period\": {\r\n            \"start\": \"{{encounter_start_date}}\",\r\n            \"end\": \"{{encounter_start_date}}\"\r\n        },\r\n        \"visit\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"visit\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{visit_id}}\"\r\n            }\r\n        },\r\n        \"actions\": [\r\n            {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/ICPC2/actions\",\r\n                        \"code\": \"N47\"\r\n                    }\r\n                ]\r\n            }\r\n        ],\r\n        \"episode\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"episode\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{jobEpisodeID}}\"\r\n            }\r\n        },\r\n        \"class\": {\r\n            \"system\": \"eHealth/encounter_classes\",\r\n            \"code\": \"PHC\"\r\n        },\r\n        \"type\": {\r\n            \"coding\": [\r\n                {\r\n                    \"system\": \"eHealth/encounter_types\",\r\n                    \"code\": \"service_delivery_location\"\r\n                }\r\n            ]\r\n        },\r\n        \"priority\": {\r\n            \"coding\": [\r\n                {\r\n                    \"system\": \"eHealth/encounter_priority\",\r\n                    \"code\": \"urgent\"\r\n                }\r\n            ]\r\n        },\r\n        \"performer\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"employee\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{user_id}}\"\r\n            }\r\n        },\r\n        \"reasons\": [\r\n            {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/ICPC2/reasons\",\r\n                        \"code\": \"S17\"\r\n                    }\r\n                ]\r\n            }\r\n        ],\r\n        \"diagnoses\": [\r\n            {\r\n                \"condition\": {\r\n                    \"identifier\": {\r\n                        \"type\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"eHealth/resources\",\r\n                                    \"code\": \"condition\"\r\n                                }\r\n                            ]\r\n                        },\r\n                        \"value\": \"{{encounter_dummy_id}}\"\r\n                    }\r\n                },\r\n                \"role\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/diagnosis_roles\",\r\n                            \"code\": \"primary\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"rank\": 1\r\n            }\r\n        ],\r\n        \"division\": {\r\n            \"identifier\": {\r\n                \"type\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/resources\",\r\n                            \"code\": \"division\"\r\n                        }\r\n                    ]\r\n                },\r\n                \"value\": \"{{user_division_id}}\"\r\n            }\r\n        },\r\n        \"prescriptions\": \"Дієта №3, Омепразолу 40 мг 1 раз на добу + амоксициліну 500 мг + метронідазолу 400 мг при необхідності 500 мг або тинідазолу 500 мг 3 рази на добу протягом 1 тижня\"\r\n    },\r\n    \"conditions\": [\r\n        {\r\n            \"id\": \"{{encounter_dummy_id}}\",\r\n            \"primary_source\": true,\r\n            \"asserter\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"employee\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"Якийсь текст\"\r\n                    },\r\n                    \"value\": \"{{user_id}}\"\r\n                }\r\n            },\r\n            \"context\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"encounter\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"value\": \"{{encounter_dummy_id}}\"\r\n                }\r\n            },\r\n            \"code\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/ICPC2/condition_codes\",\r\n                        \"code\": \"S14\"\r\n                    }\r\n                ]\r\n            },\r\n            \"clinical_status\": \"active\",\r\n            \"verification_status\": \"confirmed\",\r\n            \"severity\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/condition_severities\",\r\n                        \"code\": \"moderate\"\r\n                    }\r\n                ]\r\n            },\r\n            \"body_sites\": [\r\n                {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/body_sites\",\r\n                            \"code\": \"pelvis\"\r\n                        }\r\n                    ]\r\n                }\r\n            ],\r\n            \"onset_date\": \"2025-01-10T09:46:37.694Z\",\r\n            \"asserted_date\": \"2025-01-11T09:46:37.694Z\",\r\n            \"stage\": {\r\n                \"summary\": {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/condition_stages\",\r\n                            \"code\": \"default_condition_stage\"\r\n                        }\r\n                    ]\r\n                }\r\n            },\r\n            \"evidences\": [\r\n                {\r\n                    \"codes\": [\r\n                        {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"eHealth/ICPC2/reasons\",\r\n                                    \"code\": \"T90\"\r\n                                }\r\n                            ]\r\n                        }\r\n                    ]\r\n                }\r\n            ]\r\n        }\r\n    ],\r\n    \"observations\": [\r\n        {\r\n            \"id\": \"{{encounter_dummy_id}}\",\r\n            \"status\": \"valid\",\r\n            \"categories\": [\r\n                {\r\n                    \"coding\": [\r\n                        {\r\n                            \"system\": \"eHealth/observation_categories\",\r\n                            \"code\": \"vital-signs\"\r\n                        }\r\n                    ]\r\n                }\r\n            ],\r\n            \"code\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/LOINC/observation_codes\",\r\n                        \"code\": \"31044-1\"\r\n                    }\r\n                ]\r\n            },\r\n            \"components\": [\r\n                {\r\n                    \"code\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"code\": \"extent_or_magnitude_of_impairment\",\r\n                                \"system\": \"eHealth/ICF/qualifiers\"\r\n                            }\r\n                        ],\r\n                        \"text\": null\r\n                    },\r\n                    \"interpretation\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/observation_interpretations\",\r\n                                \"code\": \"normal\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"reference_ranges\": [],\r\n                    \"value_codeable_concept\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"code\": \"1\",\r\n                                \"system\": \"eHealth/ICF/qualifiers/extent_or_magnitude_of_impairment\"\r\n                            }\r\n                        ],\r\n                        \"text\": null\r\n                    }\r\n                }\r\n            ],\r\n            \"effective_date_time\": \"2025-01-18T10:45:16.000Z\",\r\n            \"issued\": \"2025-01-19T10:45:16.000Z\",\r\n            \"primary_source\": true,\r\n            \"performer\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"employee\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"Галина Олександрівна\"\r\n                    },\r\n                    \"value\": \"{{user_id}}\"\r\n                }\r\n            },\r\n            \"comment\": \"Some comment\",\r\n            \"value_quantity\": {\r\n                \"value\": 0,\r\n                \"comparator\": \">\",\r\n                \"unit\": \"kg\",\r\n                \"system\": \"eHealth/ucum/units\",\r\n                \"code\": \"kg\"\r\n            },\r\n            \"context\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"encounter\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"value\": \"{{encounter_dummy_id}}\"\r\n                }\r\n            }\r\n        }\r\n    ],\r\n    \"immunizations\": [\r\n        {\r\n            \"id\": \"{{encounter_dummy_id}}\",\r\n            \"status\": \"completed\",\r\n            \"not_given\": false,\r\n            \"vaccine_code\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/vaccine_codes\",\r\n                        \"code\": \"SarsCov2_nRVv\"\r\n                    }\r\n                ]\r\n            },\r\n            \"context\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"encounter\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"value\": \"{{encounter_dummy_id}}\"\r\n                }\r\n            },\r\n            \"date\": \"2025-01-19T09:46:37.694Z\",\r\n            \"primary_source\": true,\r\n            \"performer\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"employee\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"Текст 123\"\r\n                    },\r\n                    \"value\": \"{{user_id}}\"\r\n                }\r\n            },\r\n            \"manufacturer\": \"VacinePro Manufacturer\",\r\n            \"lot_number\": \"041A21A\",\r\n            \"expiration_date\": \"2025-10-02T09:46:37.694Z\",\r\n            \"site\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/immunization_body_sites\",\r\n                        \"code\": \"outer_surface_of_(left_shoulder)\"\r\n                    }\r\n                ]\r\n            },\r\n            \"route\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/vaccination_routes\",\r\n                        \"code\": \"intramuscularly\"\r\n                    }\r\n                ]\r\n            },\r\n            \"dose_quantity\": {\r\n                \"value\": 5,\r\n                \"unit\": \"MG\",\r\n                \"system\": \"eHealth/immunization_dosage_units\",\r\n                \"code\": \"MG\"\r\n            },\r\n            \"explanation\": {\r\n                \"reasons\": [\r\n                    {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/reason_explanations\",\r\n                                \"code\": \"immunization_by_epidemic_indicators\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"Щеплення, які проводяться на ендемічних і ензоотичних територіях та за епідемічними показаннями\"\r\n                    }\r\n                ]\r\n            },\r\n            \"vaccination_protocols\": [\r\n                {\r\n                    \"dose_sequence\": 1,\r\n                    \"description\": \"Опис 123\",\r\n                    \"authority\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/vaccination_authorities\",\r\n                                \"code\": \"MoH\"\r\n                            }\r\n                        ]\r\n                    },\r\n                    \"series\": \"Vaccination Series 1\",\r\n                    \"series_doses\": 1,\r\n                    \"target_diseases\": [\r\n                        {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"eHealth/vaccination_target_diseases\",\r\n                                    \"code\": \"COVID_19\"\r\n                                }\r\n                            ]\r\n                        }\r\n                    ]\r\n                }\r\n            ]\r\n        }\r\n    ]\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "http://localhost:3000/create-encounter-signed-content",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "3000",
					"path": [
						"create-encounter-signed-content"
					]
				}
			},
			"response": []
		},
		{
			"name": "Submit encounter datapackage",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "86371ab3-fb7a-4f90-8cd2-b39bd904b27a",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Encounter Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': '0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b'\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"           pm.expect([200, 303]).to.include(res.code);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                pm.test(`Encounter Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(303);\r",
							"                });\r",
							"\r",
							"                const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                    acc[link.entity] = link.href.replace('/api/', '');\r",
							"                    return acc;\r",
							"                }, {});\r",
							"\r",
							"                // Iterate over the links object and set globals dynamically\r",
							"                Object.entries(links).forEach(([entity, href]) => {\r",
							"                    const globalName = `job${entity.charAt(0).toUpperCase() + entity.slice(1).replace('_', '')}ID`;\r",
							"                    pm.globals.set(globalName, href);\r",
							"                });\r",
							"\r",
							"\r",
							"                displayResponse('Encounter Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Encounter Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Encounter Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "edc46aed-db60-4c88-b24c-ebafda9aa2c0",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-04dd94ac-3683-4dd8-9495-c264cdd33294",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n  \"visit\": {\n    \"id\": \"{{visit_id}}\",\n    \"period\": {\n      \"start\": \"2022-05-05T10:42:16.000Z\",\n      \"end\": \"2024-06-10T11:46:17.000Z\"\n    }\n  },\n  \"signed_data\": \"{{encounter_signed_content}}\"\n}\n"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/encounter_package",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"encounter_package"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Encounter by id",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "5c3ed928-d1fd-4c9c-a616-57590a5a58f5",
						"exec": [
							"pm.test(\"Get Encounter by id - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "99609e84-65a6-4b21-b2a8-bc560d2eec66",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-f50c204d-3f83-4270-8f7c-17e18f9e51a8",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/{{jobEncounterID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"{{jobEncounterID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Encounters by search params",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "13deb9dc-0e2a-4861-a710-210b1f4ff4e1",
						"exec": [
							"pm.test(\"Get Encounters by search params - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "6f8aae18-9268-4ab4-a726-3072a7fa76a6",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-17ba8866-4b15-47c5-a9ff-b6310b440667",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/encounters?managing_organization_id={{user_legal_entity}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"encounters"
					],
					"query": [
						{
							"key": "page",
							"value": "2",
							"disabled": true
						},
						{
							"key": "page_size",
							"value": "50",
							"disabled": true
						},
						{
							"key": "date_from",
							"value": "2022-10-20",
							"disabled": true
						},
						{
							"key": "date_to",
							"value": "2022-10-30",
							"disabled": true
						},
						{
							"key": "origin_episode_id",
							"value": "1242121d-bdfb-420b-a1bc-64d9abeddaf5",
							"disabled": true
						},
						{
							"key": "incoming_referral_id",
							"value": "",
							"disabled": true
						},
						{
							"key": "episode_id",
							"value": "34ac9c30-78d1-4bdd-8ab9-d48f5e7cd7f2",
							"disabled": true
						},
						{
							"key": "managing_organization_id",
							"value": "{{user_legal_entity}}"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Immunization by id",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "e695d741-f3cf-4239-89f6-f5f4d21995d8",
						"exec": [
							"pm.test(\"Get Immunization by id - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "72d9cab8-058c-4edb-ba45-eee9664a973f",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-a68f518f-985d-46c0-bce3-f006596355dc",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					},
					{
						"key": "",
						"value": "",
						"type": "text",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{host}}/api/{{jobImmunizationID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"{{jobImmunizationID}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Immunizations by search params",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "9c307c2d-1d5c-4fb8-a20a-4bd3829d8954",
						"exec": [
							"pm.test(\"Get Immunizations by search params - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "48e8a5fd-d00a-4226-887b-9eb15010c987",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-621c27c8-46e6-4c7d-b4f2-b3fd5e5c02a6",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					},
					{
						"key": "",
						"value": "",
						"type": "text",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/immunizations?episode_id={{jobEpisodeID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"immunizations"
					],
					"query": [
						{
							"key": "page",
							"value": "2",
							"disabled": true
						},
						{
							"key": "page_size",
							"value": "50",
							"disabled": true
						},
						{
							"key": "vaccine_code",
							"value": "wex-10",
							"disabled": true
						},
						{
							"key": "encounter_id",
							"value": "09dc3ed7-2169-45d8-8fa3-d918c6839bf9",
							"disabled": true
						},
						{
							"key": "episode_id",
							"value": "{{jobEpisodeID}}"
						},
						{
							"key": "date_from",
							"value": "1990-01-01",
							"disabled": true
						},
						{
							"key": "date_to",
							"value": "2000-01-01",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Composition TEMP_DISABILITY",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "92a3afc3-da4e-437b-9e31-e48d30e84673",
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"\r",
							"pm.test(\"Create Compisition Temp Disability - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"\r",
							"    const resId = resData.data?.id;\r",
							"    pm.globals.set('creatCompositionJobId', resId)\r",
							"\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "f6059e55-2cf6-4987-bf7d-707050832730",
						"exec": [
							"// Retrieve the URL from the global variable\r",
							"const url = pm.globals.get('jobEncounterID');\r",
							"\r",
							"// Отримуємо поточну дату\r",
							"const today = new Date();\r",
							"\r",
							"// Обчислюємо start (сьогодні)\r",
							"const compositionTempDisabilityStart = new Date(today);\r",
							"\r",
							"// Обчислюємо end (сьогодні + 3 дні)\r",
							"const compositionTempDisabilityEnd = new Date(today);\r",
							"compositionTempDisabilityEnd.setDate(compositionTempDisabilityEnd.getDate() + 3);\r",
							"\r",
							"// Функція для форматування дати у форматі ISO 8601 (з T00:00:00.000Z)\r",
							"const formatISODate = (date) => date.toISOString().split('T')[0] + \"T00:00:00.000Z\";\r",
							"\r",
							"// Зберігаємо у глобальні змінні\r",
							"pm.globals.set('compositionTempDisabilityStart', formatISODate(compositionTempDisabilityStart));\r",
							"pm.globals.set('compositionTempDisabilityEnd', formatISODate(compositionTempDisabilityEnd));\r",
							"\r",
							"// Виводимо у консоль для перевірки\r",
							"console.log(\"Composition Temp Disability Start:\", formatISODate(compositionTempDisabilityStart));\r",
							"console.log(\"Composition Temp Disability End:\", formatISODate(compositionTempDisabilityEnd));\r",
							"\r",
							"\r",
							"// Check if the URL is defined and contains the expected format\r",
							"if (url && url.includes('encounters/')) {\r",
							"    // Extract the ID after 'encounters/'\r",
							"    const parts = url.split('encounters/');\r",
							"    if (parts.length > 1) {\r",
							"        const jobEncounterID = parts[1];\r",
							"        \r",
							"        // Log the extracted ID to the console (for debugging purposes)\r",
							"        console.log('Extracted jobEncounterID:', jobEncounterID);\r",
							"        \r",
							"        // Optionally, set the extracted ID as an environment variable\r",
							"        pm.globals.set('encounter_extracted_id', jobEncounterID);\r",
							"    } else {\r",
							"        console.error('The URL does not contain the expected format.');\r",
							"    }\r",
							"} else {\r",
							"    console.error('The global variable jobEncounterID is not defined or does not contain the expected format.');\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-481d650e-168f-4cfe-afc7-88e87d890406",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"category\": {\r\n        \"coding\": [\r\n            {\r\n                \"system\": \"COMPOSITION_CATEGORIES\",\r\n                \"code\": \"SICKNESS\"\r\n            }\r\n        ]\r\n    },\r\n    \"type\": {\r\n        \"coding\": [\r\n            {\r\n                \"system\": \"COMPOSITION_TYPES\",\r\n                \"code\": \"TEMP_DISABILITY\"\r\n            }\r\n        ]\r\n    },\r\n    \"event\": [\r\n        {\r\n            \"code\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"COMPOSITION_EVENTS\",\r\n                        \"code\": \"COMPOSITION_VALIDITY_PERIOD\"\r\n                    }\r\n                ]\r\n            },\r\n            \"period\": {\r\n                \"start\": \"{{compositionTempDisabilityStart}}\",\r\n                \"end\": \"{{compositionTempDisabilityEnd}}\"\r\n            }\r\n        }\r\n    ],\r\n    \"subject\": {\r\n        \"type\": {\r\n            \"coding\": [\r\n                {\r\n                    \"system\": \"eHealth/resources\",\r\n                    \"code\": \"person\"\r\n                }\r\n            ],\r\n            \"text\": \"string\"\r\n        },\r\n        \"value\": \"{{patient_for_regress}}\"\r\n    },\r\n    \"encounter\": {\r\n        \"type\": {\r\n            \"coding\": [\r\n                {\r\n                    \"system\": \"eHealth/resources\",\r\n                    \"code\": \"encounter\"\r\n                }\r\n            ],\r\n            \"text\": \"string\"\r\n        },\r\n        \"value\": \"{{encounter_extracted_id}}\"\r\n    },\r\n    \"author\": {\r\n        \"type\": {\r\n            \"coding\": [\r\n                {\r\n                    \"system\": \"eHealth/resources\",\r\n                    \"code\": \"employee\"\r\n                }\r\n            ],\r\n            \"text\": \"string\"\r\n        },\r\n        \"value\": \"{{user_id}}\"\r\n    },\r\n    \"section\": {\r\n        \"focus\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"person\"\r\n                    }\r\n                ]\r\n            },\r\n            \"value\": \"{{patient_for_regress}}\"\r\n        }\r\n    },\r\n    \"extension\": []\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{host}}/api/patients/composition",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"composition"
					]
				}
			},
			"response": []
		},
		{
			"name": "Check job status",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "a7bd0594-a66e-4031-83f0-a7a8bdf780ae",
						"exec": [
							"// Розбираємо відповідь\r",
							"const resBody = pm.response.json();\r",
							"\r",
							"// Перевіряємо статус-код\r",
							"pm.test(\"Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});\r",
							"\r",
							"// Перевіряємо статус DONE\r",
							"pm.test(\"Status is DONE\", function () {\r",
							"    pm.expect(resBody.data.status).to.eql(\"DONE\");\r",
							"});\r",
							"\r",
							"// Якщо статус 200 і DONE, зберігаємо ID\r",
							"if (resBody.data.status === \"DONE\") {\r",
							"    // Знаходимо посилання на composition\r",
							"    const compositionLink = resBody.data.links.find(link => link.href.includes(\"composition/\"));\r",
							"\r",
							"    if (compositionLink) {\r",
							"        // Витягуємо ID після composition/\r",
							"        const compositionId = compositionLink.href.split(\"composition/\")[1];\r",
							"\r",
							"        // Зберігаємо в глобальні змінні\r",
							"        pm.globals.set(\"JobCompositionID\", compositionId);\r",
							"\r",
							"        // Виводимо для перевірки\r",
							"        console.log(\"Saved Composition ID:\", compositionId);\r",
							"    } else {\r",
							"        console.warn(\"No composition link found.\");\r",
							"    }\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "1a8e91f8-83f6-4102-a274-846c3ba0b61b",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-cbcfeac5-d922-4998-bd12-1799f7008d54",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					}
				],
				"body": {
					"mode": "formdata",
					"formdata": []
				},
				"url": {
					"raw": "{{host}}/api/patients/composition/job/{{creatCompositionJobId}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"composition",
						"job",
						"{{creatCompositionJobId}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get composition",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "35bbe029-088d-4def-b7d3-ac5a6b85900e",
						"exec": [
							"// Розбираємо відповідь",
							"const resBody = pm.response.json();",
							"",
							"",
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"",
							"",
							"    const contentString = JSON.stringify(resBody);",
							"",
							"    console.log(contentString);",
							"",
							"    // Зберігаємо у глобальні змінні",
							"    pm.globals.set(\"ContentForSign\", contentString);",
							"",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "12c68028-9797-46a7-b034-d8fb86bd83ff",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-81579c72-e851-4c03-b1b3-1801fe3f1268",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					}
				],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/composition/{{JobCompositionID}}/episode/{{jobEpisodeID}}/encounter/{{encounter_extracted_id}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"composition",
						"{{JobCompositionID}}",
						"episode",
						"{{jobEpisodeID}}",
						"encounter",
						"{{encounter_extracted_id}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Sign Composition",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "00063ec9-2991-49a8-9607-c6a4985bc3d9",
						"exec": [
							"const resData = pm.response.json();",
							"",
							"",
							"pm.test(\"Sign Composition - PASS. Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"",
							"    const resId = resData.data?.id;",
							"    pm.globals.set('creatCompositionJobId', resId)",
							"",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "ef7cc10e-c8ed-4805-99d1-cbc00deeb968",
						"exec": [
							"// Отримуємо ContentForSign із глобальних змінних\r",
							"const contentForSign = pm.globals.get('ContentForSign');\r",
							"\r",
							"if (!contentForSign) {\r",
							"    console.error(\"Error: ContentForSign is not set in global variables.\");\r",
							"} else {\r",
							"    // Функція для надсилання контенту на підпис\r",
							"    function sendDataToSign(contentForSign) {\r",
							"        const localServerUrl = 'http://localhost:3000/create-composition-signed-content';\r",
							"\r",
							"        const requestData = {\r",
							"            method: 'POST',\r",
							"            url: localServerUrl,\r",
							"            header: {\r",
							"                'Content-Type': 'application/json',\r",
							"            },\r",
							"            body: {\r",
							"                mode: 'raw',\r",
							"                raw: contentForSign // Використовуємо JSON-рядок із глобальних змінних\r",
							"            }\r",
							"        };\r",
							"\r",
							"        // Відправляємо запит на локальний сервер\r",
							"        pm.sendRequest(requestData, function (err, res) {\r",
							"            if (err) {\r",
							"                console.error('Error sending request to local server:', err);\r",
							"            } else {\r",
							"                console.log('Response from local server:', res.json());\r",
							"                const responseBody = res.json();\r",
							"\r",
							"                pm.test(`Sign Composition content. Response status is 200 ${JSON.stringify(responseBody, null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(200);\r",
							"                    pm.expect(responseBody).to.have.property('signed_content');\r",
							"\r",
							"                    // Зберігаємо підписаний контент у глобальні змінні\r",
							"                    pm.globals.set('composition_signed_content', responseBody.signed_content);\r",
							"                });\r",
							"            }\r",
							"        });\r",
							"    }\r",
							"\r",
							"    // Викликаємо функцію з отриманими даними\r",
							"    sendDataToSign(contentForSign);\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-5dff3f42-d6dc-4d93-ad5b-ca6aae750d90",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "PATCH",
				"header": [
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n  \"data\": \"{{composition_signed_content}}\"\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "{{host}}/api/patients/composition/{{JobCompositionID}}/sign",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"composition",
						"{{JobCompositionID}}",
						"sign"
					]
				}
			},
			"response": []
		},
		{
			"name": "Check job status after sign",
			"event": [
				{
					"listen": "test",
					"script": {
						"id": "b8330f53-1645-4a4a-9a46-6d4432620e44",
						"exec": [
							"// Розбираємо відповідь\r",
							"const resBody = pm.response.json();\r",
							"\r",
							"// Перевіряємо статус-код\r",
							"pm.test(\"Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});\r",
							"\r",
							"// Перевіряємо статус DONE\r",
							"pm.test(\"Status is DONE\", function () {\r",
							"    pm.expect(resBody.data.status).to.eql(\"DONE\");\r",
							"});\r",
							"\r",
							"// Якщо статус 200 і DONE, зберігаємо ID\r",
							"if (pm.response.code === 200 && resBody.data.status === \"DONE\") {\r",
							"    // Знаходимо посилання на composition\r",
							"    const compositionLink = resBody.data.links.find(link => link.href.includes(\"composition/\"));\r",
							"\r",
							"    if (compositionLink) {\r",
							"        // Витягуємо ID після composition/\r",
							"        const compositionId = compositionLink.href.split(\"composition/\")[1];\r",
							"\r",
							"        // Зберігаємо в глобальні змінні\r",
							"        pm.globals.set(\"JobCompositionID\", compositionId);\r",
							"\r",
							"        // Виводимо для перевірки\r",
							"        console.log(\"Saved Composition ID:\", compositionId);\r",
							"    } else {\r",
							"        console.warn(\"No composition link found.\");\r",
							"    }\r",
							"}\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"id": "6471a0b1-185b-4879-88de-f3add01e0c2e",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-739bb7a1-d0bf-4e52-83c5-dbe480cdbc7d",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "{{x-custom-psk}}",
						"type": "text",
						"disabled": true
					}
				],
				"body": {
					"mode": "formdata",
					"formdata": []
				},
				"url": {
					"raw": "{{host}}/api/patients/composition/job/{{creatCompositionJobId}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"composition",
						"job",
						"{{creatCompositionJobId}}"
					]
				}
			},
			"response": []
		},
		{
			"name": "Search compositions",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"pm.test(\"Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "231faebe-9a8d-49b1-b28b-d4450de197e0"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"id": "14e3f403-cbc7-4364-a307-7779d8cc90e4"
					}
				}
			],
			"id": "15381251-90a4c24f-c8d0-4f21-bec6-0f355f727221",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}",
						"type": "text"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}",
						"type": "text"
					},
					{
						"key": "x-custom-psk",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b",
						"type": "text"
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/searchComposition?type=TEMP_DISABILITY&subject={{patient_for_regress}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"searchComposition"
					],
					"query": [
						{
							"key": "limit",
							"value": "100",
							"disabled": true
						},
						{
							"key": "type",
							"value": "TEMP_DISABILITY"
						},
						{
							"key": "focus",
							"value": "52b504c7-0177-4078-834b-52d89154081c",
							"disabled": true
						},
						{
							"key": "offset",
							"value": "135",
							"disabled": true
						},
						{
							"key": "episodeOfCare",
							"value": "c1ac2f2e-3e88-450e-9269-9ca79be4d6bd",
							"disabled": true
						},
						{
							"key": "encounter",
							"value": "3fd77b98-a280-4808-a5ac-00ec39246e38",
							"disabled": true
						},
						{
							"key": "status",
							"value": "FINAL",
							"disabled": true
						},
						{
							"key": "subject",
							"value": "{{patient_for_regress}}"
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Composition Title",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"id": "9ff28f18-7279-4fc0-b070-297fc0473d50"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"",
							"const resData = pm.response.json();",
							"",
							"pm.test(`Composition title. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {",
							"    pm.expect(pm.response.code).to.eql(200);",
							"    pm.globals.set('composition_stitle', resData.data.title);",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "5770c38d-0b06-467b-99c7-62b78b75db41"
					}
				}
			],
			"id": "15381251-5e748e21-28e6-4777-bf5e-44b6dd73e7b5",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "X-Custom-PSK",
						"value": "0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b"
					}
				],
				"body": {
					"mode": "raw",
					"raw": ""
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/composition_title?composition_type=ADOPTION",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"composition_title"
					],
					"query": [
						{
							"key": "composition_type",
							"value": "DRIVERS",
							"disabled": true
						},
						{
							"key": "composition_type",
							"value": "ADOPTION"
						},
						{
							"key": "composition_type",
							"value": "DRIVERS_GROUP1",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "ADOPTION_Dummy_Composition",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"const resData = pm.response.json();\r",
							"\r",
							"pm.test(`Composition content sign success. Response status is 200 ${JSON.stringify(resData, null, 2)}`, function () {\r",
							"    pm.expect(pm.response.code).to.eql(200);\r",
							"    pm.expect(resData).to.have.property('signed_content');\r",
							"    pm.globals.set('composition_signed_content', resData.signed_content);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"id": "16672cce-743f-48bb-b040-14053b0c430a"
					}
				},
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"const uuid = require('uuid');\r",
							"const id = uuid.v4();\r",
							"pm.environment.set(\"composition_id\", id);\r",
							"\r",
							"// Helper function to extract IDs from URLs\r",
							"function extractID(url, keyword, variableName) {\r",
							"    if (url && url.includes(`${keyword}/`)) {\r",
							"        const parts = url.split(`${keyword}/`);\r",
							"        if (parts.length > 1) {\r",
							"            const extractedID = parts[1];\r",
							"            \r",
							"            // Log the extracted ID to the console (for debugging purposes)\r",
							"            console.log(`Extracted ${variableName}:`, extractedID);\r",
							"            \r",
							"            // Set the extracted ID as an environment variable\r",
							"            pm.globals.set(variableName, extractedID);\r",
							"        } else {\r",
							"            console.error(`The URL does not contain the expected format for ${keyword}.`);\r",
							"        }\r",
							"    } else {\r",
							"        console.error(`The global variable ${variableName} is not defined or does not contain the expected format.`);\r",
							"    }\r",
							"}\r",
							"\r",
							"// Retrieve the URL from the global variable\r",
							"const url = pm.globals.get('jobEncounterID');\r",
							"\r",
							"// Extract encounter and observation IDs using the helper function\r",
							"extractID(url, 'encounters', 'encounter_extracted_id');\r",
							"extractID(url, 'observations', 'observation_extracted_id');\r",
							"// extractID(url, 'conditions', 'condition_extracted_id');\r",
							"\r",
							"\r",
							"// Отримуємо encounter_start_date з глобальних змінних\r",
							"const encounterPeriodes = new Date(pm.globals.get('encounter_start_date'));\r",
							"\r",
							"// Додаємо 1 день до encounter_start_date\r",
							"const adopterCompositionDate = new Date(encounterPeriodes);\r",
							"adopterCompositionDate.setDate(adopterCompositionDate.getDate() + 1);\r",
							"\r",
							"// Додаємо 2 дні до adopterCompositionDate (отримуємо start)\r",
							"const adopterCompositionStart = new Date(adopterCompositionDate);\r",
							"adopterCompositionStart.setDate(adopterCompositionStart.getDate() + 2);\r",
							"\r",
							"// Додаємо 5 днів до start (отримуємо end)\r",
							"const adopterCompositionEnd = new Date(adopterCompositionStart);\r",
							"adopterCompositionEnd.setDate(adopterCompositionEnd.getDate() + 5);\r",
							"\r",
							"// Функція для форматування дати у форматі ISO 8601 (з T00:00:00.000Z)\r",
							"const formatISODate = (date) => date.toISOString().split('T')[0] + \"T00:00:00.000Z\";\r",
							"\r",
							"// Зберігаємо у глобальні змінні\r",
							"pm.globals.set('adopterCompositionDate', formatISODate(adopterCompositionDate));\r",
							"pm.globals.set('adopterCompositionStart', formatISODate(adopterCompositionStart));\r",
							"pm.globals.set('adopterCompositionEnd', formatISODate(adopterCompositionEnd));\r",
							"\r",
							"// Виводимо у консоль для перевірки\r",
							"console.log(\"Adopter Composition Date:\", formatISODate(adopterCompositionDate));\r",
							"console.log(\"Adopter Composition Start:\", formatISODate(adopterCompositionStart));\r",
							"console.log(\"Adopter Composition End:\", formatISODate(adopterCompositionEnd));\r",
							"\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"id": "26d081aa-2a79-48ba-8fde-597b7a0e360c"
					}
				}
			],
			"id": "15381251-c980fb44-bb37-4c17-8d10-8c2148603d09",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [],
				"body": {
					"mode": "raw",
					"raw": "{\r\n    \"id\": \"{{composition_id}}\",\r\n    \"title\": \"{{composition_stitle}}\",\r\n    \"status\": \"FINAL\",\r\n    \"type\": {\r\n        \"coding\": [\r\n            {\r\n                \"system\": \"COMPOSITION_TYPES\",\r\n                \"code\": \"ADOPTION\"\r\n            }\r\n        ]\r\n    },\r\n    \"category\": {\r\n        \"coding\": [\r\n            {\r\n                \"system\": \"COMPOSITION_CATEGORIES\",\r\n                \"code\": \"ADOPTER\"\r\n            }\r\n        ]\r\n    },\r\n    \"date\": \"{{adopterCompositionDate}}\",\r\n    \"custodian\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"legal_entity\"\r\n                    }\r\n                ],\r\n                \"text\": \"string\"\r\n            },\r\n            \"value\": \"{{user_legal_entity}}\"\r\n        }\r\n    },\r\n    \"encounter\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"encounter\"\r\n                    }\r\n                ],\r\n                \"text\": \"string\"\r\n            },\r\n            \"value\": \"{{encounter_extracted_id}}\"\r\n        }\r\n    },\r\n    \"author\": {\r\n        \"identifier\": {\r\n            \"type\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"eHealth/resources\",\r\n                        \"code\": \"employee\"\r\n                    }\r\n                ],\r\n                \"text\": \"string\"\r\n            },\r\n            \"value\": \"{{user_id}}\"\r\n        }\r\n    },\r\n    \"attester\": [\r\n        {\r\n            \"mode\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"COMPOSITION_ATTESTER_MODES\",\r\n                        \"code\": \"LEGAL\"\r\n                    }\r\n                ]\r\n            },\r\n            \"party\": {\r\n                \"identifier\": {\r\n                    \"type\": {\r\n                        \"coding\": [\r\n                            {\r\n                                \"system\": \"eHealth/resources\",\r\n                                \"code\": \"employee\"\r\n                            }\r\n                        ],\r\n                        \"text\": \"string\"\r\n                    },\r\n                    \"value\": \"{{user_id}}\"\r\n                }\r\n            }\r\n        }\r\n    ],\r\n    \"event\": [\r\n        {\r\n            \"code\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"COMPOSITION_EVENTS\",\r\n                        \"code\": \"ADOPTION_ADOPTER_ELIGIBLE\"\r\n                    }\r\n                ]\r\n            },\r\n            \"period\": {\r\n                \"start\": \"{{adopterCompositionStart}}\",\r\n                \"end\": \"{{adopterCompositionEnd}}\"\r\n            }\r\n        }\r\n    ],\r\n    \"section\": [\r\n        {\r\n            \"title\": \"NOT_ADOPTION_ADOPTER_FREE_SECTION\",\r\n            \"code\": {\r\n                \"coding\": [\r\n                    {\r\n                        \"system\": \"COMPOSITION_SECTION_CODES\",\r\n                        \"code\": \"ADOPTION_ADOPTER_FREE_SECTION\"\r\n                    }\r\n                ]\r\n            },\r\n            \"author\": [\r\n                {\r\n                    \"identifier\": {\r\n                        \"type\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"eHealth/resources\",\r\n                                    \"code\": \"employee\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"string\"\r\n                        },\r\n                        \"value\": \"{{user_id}}\"\r\n                    }\r\n                }\r\n            ],\r\n            \"entry\": [\r\n                {\r\n                    \"identifier\": {\r\n                        \"type\": {\r\n                            \"coding\": [\r\n                                {\r\n                                    \"system\": \"eHealth/resources\",\r\n                                    \"code\": \"condition\"\r\n                                }\r\n                            ],\r\n                            \"text\": \"string\"\r\n                        },\r\n                        \"value\": \"{{encounter_extracted_id}}\"\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    ]\r\n}",
					"options": {
						"raw": {
							"language": "json"
						}
					}
				},
				"url": {
					"raw": "http://localhost:3000/create-composition-signed-content",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "3000",
					"path": [
						"create-composition-signed-content"
					]
				}
			},
			"response": []
		},
		{
			"name": "Create Composition",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "6d133f32-bea0-4536-8e2a-1b0dd867e6ea",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "158e0ab7-d1ab-4429-aca9-3d0f293b63de",
						"exec": [
							"function displayResponse(title, data) {\r",
							"    const html = `\r",
							"        <h1>${title}</h1>\r",
							"        <pre>${JSON.stringify(data, null, 2)}</pre>`;\r",
							"    pm.visualizer.set(html);\r",
							"}\r",
							"\r",
							"// Get the response body from the main request\r",
							"const resBody = pm.response.text();\r",
							"const resData = JSON.parse(resBody);\r",
							"\r",
							"pm.test(\"Create Composition Status code is 202\", function () {\r",
							"    pm.response.to.have.status(202);\r",
							"});\r",
							"\r",
							"\r",
							"if (resData && resData.error) {\r",
							"    displayResponse('Create Composition Response Error Details', resData.error);\r",
							"}\r",
							"\r",
							"const href = resData.data.links[0].href;\r",
							"console.log(\"Extracted href:\", href);\r",
							"\r",
							"// Extract the job ID from the href\r",
							"const number = href.split('/jobs/')[1];\r",
							"console.log(\"Extracted number:\", number);\r",
							"\r",
							"// Initialize retry counter in the environment\r",
							"pm.environment.set('retryCount', 0);\r",
							"\r",
							"// Function to check job status\r",
							"function checkJobStatus(jobId) {\r",
							"\r",
							"    const url = `${pm.globals.get('host')}/api/jobs/${jobId}`;\r",
							"    const maxRetries = 3; // Set the maximum number of retries\r",
							"\r",
							"    pm.sendRequest({\r",
							"        method: 'GET',\r",
							"        url: url,\r",
							"        header: {\r",
							"            'Content-Type': 'application/json',\r",
							"            'Authorization': `Bearer ${pm.environment.get('access_token')}`,\r",
							"            'api-key': `${pm.environment.get('mis_client_secret')}`,\r",
							"            'X-Custom-PSK': '0d65b47f51cb527a3262311da2af53e03f6fcff6e4cf655414a43f52e5ad457b'\r",
							"        }\r",
							"    }, function (err, res) {\r",
							"\r",
							"        // pm.test(`Job status check response status is 200 or 303`, function () {\r",
							"        //     pm.expect([200, 303]).to.include(res.code);\r",
							"        // });\r",
							"        const resFromJob = res.json();\r",
							"        pm.test(\"Composition job status 200\", function () {\r",
							"            pm.expect(resFromJob.data.status_code).to.eql(200);\r",
							"        });\r",
							"\r",
							"        if (err) {\r",
							"            displayResponse('Request Error', { error: err.message });\r",
							"            console.error('Error checking job status:', err);\r",
							"        } else {\r",
							"\r",
							"            const responseBody = res.json();\r",
							"            console.log('Job Status:', responseBody.data.status);\r",
							"\r",
							"            if (responseBody.data.status === 'processed') {\r",
							"\r",
							"                pm.test(`Create Composition Job Success. Response status is 303 ${JSON.stringify(res.json(), null, 2)}`, function () {\r",
							"                    pm.expect(res.code).to.eql(303);\r",
							"                });\r",
							"\r",
							"                // const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                //     const href = link.href.replace('/api/', ''); // Видаляємо /api/\r",
							"\r",
							"                //     acc[link.entity] = href;\r",
							"\r",
							"                //     if (href.includes('diagnostic_reports/')) {\r",
							"                //         const drId = href.split('/').pop(); // Отримуємо останню частину URL (це і є ID)\r",
							"                //         acc['jobDiagnosticReport'] = drId;\r",
							"                //     }\r",
							"\r",
							"                //     return acc;\r",
							"                // }, {});\r",
							"\r",
							"                // // Записуємо всі значення у глобальні змінні\r",
							"                // Object.entries(links).forEach(([entity, value]) => {\r",
							"                //     const globalName = `${entity.charAt(0).toUpperCase() + entity.slice(1)}ID`;\r",
							"                //     pm.globals.set(globalName, value);\r",
							"                // });\r",
							"\r",
							"                // ------------\r",
							"\r",
							"                const links = responseBody.data.links.reduce((acc, link) => {\r",
							"                    // Extract the part after \"/api/\"\r",
							"                    const href = link.href.replace('/api/', '');\r",
							"\r",
							"                    // Set the link entity to global variables\r",
							"                    acc[link.entity] = href;\r",
							"\r",
							"                    if (href.includes('compositions/')) {\r",
							"                        const compositionId = href.split('/')[3]; // Extract the composition ID\r",
							"                        acc['jobComposition'] = compositionId;\r",
							"                    }\r",
							"\r",
							"                    return acc;\r",
							"                }, {});\r",
							"\r",
							"                // Iterate over the links object and set globals dynamically\r",
							"                Object.entries(links).forEach(([entity, value]) => {\r",
							"                    const globalName = `${entity.charAt(0).toUpperCase() + entity.slice(1)}ID`;\r",
							"                    pm.globals.set(globalName, value);\r",
							"                });\r",
							"\r",
							"                displayResponse('Create Composition Job Response Details', responseBody.data);\r",
							"            } else {\r",
							"\r",
							"                // Retrieve the current retry count\r",
							"                let retryCount = parseInt(pm.environment.get('retryCount')) || 0;\r",
							"\r",
							"                if (retryCount < maxRetries) {\r",
							"                    // Increment the retry count and set it back to the environment\r",
							"                    retryCount++;\r",
							"                    pm.environment.set('retryCount', retryCount);\r",
							"\r",
							"                    console.log(`Retrying... Attempt ${retryCount}`);\r",
							"\r",
							"                    setTimeout(() => {\r",
							"                        checkJobStatus(jobId);\r",
							"                    }, 1000);\r",
							"\r",
							"                    displayResponse('Create Composition Job Response Details2', responseBody.data);\r",
							"\r",
							"                } else {\r",
							"                    console.log('Maximum retry limit reached.');\r",
							"                    displayResponse(responseBody.data.error ? 'Create Composition Error Details' : 'Final Job Status Check', responseBody.data);\r",
							"                }\r",
							"            }\r",
							"        }\r",
							"    });\r",
							"}\r",
							"\r",
							"// Call the function with the job ID\r",
							"checkJobStatus(number);\r",
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-3e968920-cb20-4f4f-ba04-9b38bf598426",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"signed_data\": \"{{composition_signed_content}}\"\n}"
				},
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/compositions",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"compositions"
					]
				}
			},
			"response": []
		},
		{
			"name": "Get Composition by id",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"id": "062ed673-6dd5-48fa-a3d9-eb1042de569f",
						"exec": [
							""
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				},
				{
					"listen": "test",
					"script": {
						"id": "d2bc06e8-31e6-4833-bee3-68113a386615",
						"exec": [
							"pm.test(\"Get Composition by id - PASS. Status code is 200\", function () {\r",
							"    pm.response.to.have.status(200);\r",
							"});"
						],
						"type": "text/javascript",
						"packages": {},
						"requests": {}
					}
				}
			],
			"id": "15381251-7de97ca4-c4a3-485b-84e6-d246863ee536",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{access_token}}"
					},
					{
						"key": "api-key",
						"value": "{{mis_client_secret}}"
					},
					{
						"key": "X-Custom-PSK",
						"value": "{{x-custom-psk}}",
						"disabled": true
					}
				],
				"url": {
					"raw": "{{host}}/api/patients/{{patient_for_regress}}/compositions/{{JobCompositionID}}",
					"host": [
						"{{host}}"
					],
					"path": [
						"api",
						"patients",
						"{{patient_for_regress}}",
						"compositions",
						"{{JobCompositionID}}"
					]
				}
			},
			"response": []
		}
	]
}